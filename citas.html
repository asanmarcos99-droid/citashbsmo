<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Citas MÃ©dicas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
  <!-- SheetJS para exportar/importar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-slate-900 text-white">
  <script>
    // Redirigir a la pÃ¡gina de login si no hay sesiÃ³n activa
    try {
      if (!sessionStorage.getItem('citas_current_user')) {
        // evitar bucle si ya estamos en index
        if (!location.pathname.endsWith('index.html')) {
          location.href = 'index.html';
        }
      }
    } catch (e) { /* ignore */ }
  </script>
  <div id="app" class="h-full flex flex-col overflow-auto"><!-- Header -->
   <header class="bg-gradient-to-r from-emerald-600 to-teal-600 p-4 shadow-lg no-print">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
     <div class="flex items-center gap-3">
      <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center overflow-hidden"><img id="hospital-logo" src="" alt="Logo" class="w-full h-full object-cover hidden" onerror="this.style.display='none'; document.getElementById('default-logo').style.display='flex';">
       <div id="default-logo" class="w-full h-full flex items-center justify-center">
        <svg class="w-8 h-8 text-emerald-600" fill="currentColor" viewbox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z" />
        </svg>
       </div>
      </div>
      <div>
       <h1 id="hospital-title" class="text-xl font-bold">Hospital BÃ¡sico San Marcos de Ocotepeque</h1>
       <p id="system-subtitle" class="text-emerald-100 text-sm">Sistema de Citas MÃ©dicas</p>
      </div>
     </div>
    <div class="flex items-center gap-2"><select id="doctor-filter" class="bg-white/20 border border-white/30 rounded-lg px-3 py-2 text-white text-sm"> <option value="">Todos los MÃ©dicos</option> </select> <span id="available-slots" class="bg-white/20 px-3 py-2 rounded-lg text-sm"></span>
     <div id="current-user-display" class="ml-4 text-sm text-emerald-100 hidden"></div>
     <button id="logout-btn" onclick="logoutUser()" class="ml-3 bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg text-sm hidden">Salir</button>
         </div>
    </div>
   </header><!-- Navigation -->
  <nav class="bg-slate-800 border-b border-slate-700 no-print">
  <div class="max-w-7xl mx-auto flex gap-0 p-2 overflow-x-auto"><button onclick="showSection('calendar')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="calendar">ğŸ“… Calendario</button> <button onclick="showSection('appointments')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="appointments">ğŸ“‹ Lista de Citas</button> <button onclick="showSection('triage-pending')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="triage-pending">ğŸ©º Triajes Pendientes</button> <button onclick="showSection('diagnosis-pending')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="diagnosis-pending">ğŸ“‹ DiagnÃ³sticos Pendientes</button> <button onclick="showSection('reassign')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="reassign">ğŸ”„ Reasignar Citas</button> <button onclick="showSection('doctors')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="doctors">ğŸ‘¨â€âš•ï¸ Doctores</button> <button onclick="showSection('mora')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="mora">ğŸ“Š Mora QuirÃºrgica</button> <button onclick="showSection('finance')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="finance">ğŸ’° Finanzas</button> <button onclick="showSection('settings')" class="nav-btn px-4 py-2 rounded-lg text-sm font-medium transition-all hover:bg-slate-700 whitespace-nowrap" data-section="settings">âš™ï¸ ConfiguraciÃ³n</button>
      <!-- SecciÃ³n Recibir Expediente eliminada -->
   </div>
  </nav><!-- Main Content -->
   <main class="flex-1 p-4 max-w-7xl mx-auto w-full"><!-- Calendar Section -->
    <section id="section-calendar" class="section-content">
     <div class="grid lg:grid-cols-3 gap-4"><!-- Calendar -->
      <div class="lg:col-span-2 bg-slate-800 rounded-xl p-4 border border-slate-700">
       <div class="flex items-center justify-between mb-4"><button onclick="changeMonth(-1)" class="p-2 hover:bg-slate-700 rounded-lg">â—€</button>
        <h2 id="calendar-month" class="text-xl font-semibold"></h2><button onclick="changeMonth(1)" class="p-2 hover:bg-slate-700 rounded-lg">â–¶</button>
       </div>
       <div class="grid grid-cols-7 gap-1 text-center text-sm mb-2">
        <div class="text-slate-400 font-medium py-2">
         Dom
        </div>
        <div class="text-slate-400 font-medium py-2">
         Lun
        </div>
        <div class="text-slate-400 font-medium py-2">
         Mar
        </div>
        <div class="text-slate-400 font-medium py-2">
         MiÃ©
        </div>
        <div class="text-slate-400 font-medium py-2">
         Jue
        </div>
        <div class="text-slate-400 font-medium py-2">
         Vie
        </div>
        <div class="text-slate-400 font-medium py-2">
         SÃ¡b
        </div>
       </div>
       <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
      </div><!-- Quick Actions -->
      <div class="space-y-4">
       <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <h3 class="font-semibold mb-3 flex items-center gap-2">â• Nueva Cita RÃ¡pida</h3>
        <div class="space-y-2"><label class="block text-sm font-medium">Seleccione Doctor</label> <select id="quick-doctor-select" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm mb-2"> <option value="">Seleccione doctor...</option> </select> <button onclick="openNewAppointmentFromCalendar()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-4 rounded-lg font-medium transition-all"> Nueva Cita </button>
        </div>
       </div>
       <!-- Simple Data Entry Form -->
       <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <h3 class="font-semibold mb-3">ğŸ“ Ingresar Dato</h3>
        <form id="custom-data-form" onsubmit="event.preventDefault(); saveCustomData();" class="space-y-2">
          <input type="text" id="custom-input" placeholder="Ingrese un dato..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" required>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg">Agregar</button>
            <button type="button" onclick="clearCustomData()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">Limpiar</button>
          </div>
        </form>
        <div id="custom-data-list" class="mt-3 text-sm text-slate-400 max-h-40 overflow-y-auto scrollbar-thin"></div>
       </div>
       <div class="bg-slate-800 rounded-xl p-4 border border-slate-700"><button onclick="showSection('doctors')" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg font-medium transition-all"> â• Agregar Doctor </button>
       </div>
       <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <h3 class="font-semibold mb-3">ğŸ“Š Resumen del DÃ­a</h3>
        <div id="day-summary" class="space-y-2 text-sm">
         <p class="text-slate-400">Seleccione un dÃ­a para ver detalles</p>
        </div>
       </div>
      </div>
     </div>
    </section><!-- Appointments List Section -->
    <section id="section-appointments" class="section-content hidden">
     <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ“‹ Lista de Citas</h2>
       <div class="flex gap-2"><button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-all">ğŸ“„ PDF</button> <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-all">ğŸ“Š Excel</button>
       </div>
      </div>
      <div class="grid md:grid-cols-4 gap-3 mb-4">
        <input type="text" id="search-appointment" placeholder="ğŸ” Buscar por nombre de paciente..." class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" oninput="filterAppointments()">
        <select id="filter-status" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterAppointments()"> <option value="">Todos los estados</option> <option value="programada">Programada</option> <option value="triaje">En Triaje</option> <option value="diagnostico">En DiagnÃ³stico</option> <option value="completada">Completada</option> <option value="cancelada">Cancelada</option> </select>
        <select id="filter-doctor" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterAppointments()"> <option value="">Todos los doctores</option> </select>
        <select id="filter-expediente" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterAppointments()"><option value="">Todos expedientes</option><option value="enviado">Enviado</option><option value="recibido">Recibido</option><option value="sin">Sin expediente</option></select>
        <select id="filter-expediente" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterAppointments()"><option value="">Todos expedientes</option><option value="enviado">Enviado</option><option value="sin">Sin expediente</option></select>
      </div>
      <div class="flex gap-2 mb-4">
        <input type="date" id="filter-date-from" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm flex-1" onchange="filterAppointments()" placeholder="Desde">
        <input type="date" id="filter-date-to" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm flex-1" onchange="filterAppointments()" placeholder="Hasta">
        <button onclick="receiveAllSentByDate()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm">ğŸ“¥ Marcar como recibido (fecha)</button>
        <input type="file" id="import-excel" accept=".xlsx,.xls" style="display:none" />
        <input type="file" id="import-csv" accept=".csv" style="display:none" />
        <button onclick="showImportOptions()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">ğŸ“¤ Importar</button>
        <button onclick="exportAppointmentsExcel()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm">ğŸ“Š Exportar Excel</button>
        <button onclick="exportAppointmentsCSV()" class="bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg text-sm">ğŸ“Š Exportar Access/CSV</button>
      </div>
      </div>
      <p id="appointments-count" class="text-sm text-slate-400 mb-2"></p>
      <div id="appointments-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin"></div>
      <div id="imported-csv-table" class="mt-4"></div>
      <button id="export-imported-csv-pdf" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm mt-2">ğŸ“„ Exportar tabla importada a PDF</button>
      <!-- html2pdf.js para exportar tabla a PDF -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
     </div>
    </section><!-- Triage Pending Section -->
    <section id="section-triage-pending" class="section-content hidden">
     <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
      <h2 class="text-xl font-semibold mb-4">ğŸ©º Triajes Pendientes</h2>
      <div id="triage-pending-list" class="space-y-2"></div>
     </div>
    </section><!-- Triage Completed Section -->
    <section id="section-triage-completed" class="section-content hidden">
     <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
      <h2 class="text-xl font-semibold mb-4">âœ… Triajes Realizados</h2>
      <div class="grid md:grid-cols-3 gap-3 mb-4"><input type="text" id="search-triage-completed" placeholder="ğŸ” Buscar por nombre de paciente..." class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" oninput="filterTriagesCompleted()"> <select id="filter-triage-status" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterTriagesCompleted()"> <option value="">Todos los estados</option> <option value="triaje">Solo Triaje</option> <option value="diagnostico">Con DiagnÃ³stico</option> <option value="completada">Con Referencia</option> </select> <select id="filter-triage-doctor" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterTriagesCompleted()"> <option value="">Todos los doctores</option> </select>
      </div>
      <p id="triage-completed-count" class="text-sm text-slate-400 mb-2"></p>
      <div id="triage-completed-list" class="space-y-2"></div>
     </div>
    </section><!-- Diagnosis Pending Section -->
    <section id="section-diagnosis-pending" class="section-content hidden">
     <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
      <h2 class="text-xl font-semibold mb-4">ğŸ“‹ DiagnÃ³sticos Pendientes</h2>
      <div id="diagnosis-pending-list" class="space-y-2"></div>
     </div>
    </section><!-- Reassign Section -->
    <section id="section-reassign" class="section-content hidden">
     <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ”„ Reasignar Citas</h2>
      <div class="flex gap-2"><button onclick="autoReassignAll(this)" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2"> ğŸ¤– Reasignar Todas AutomÃ¡ticamente </button> <button onclick="contactAllReassign()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2"> ğŸ“ Contactar a Todos </button>
       </div>
      </div>
      <div class="grid md:grid-cols-3 gap-3 mb-4"><input type="text" id="reassign-search" placeholder="ğŸ” Buscar por nombre o identidad..." class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" oninput="filterReassignList()"> <select id="reassign-filter-doctor" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterReassignList()"> <option value="">Todos los doctores</option> </select> <input type="date" id="reassign-filter-date" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterReassignList()">
      </div>
      <p id="reassign-count" class="text-sm text-slate-400 mb-2"></p>
      <div id="reassign-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin"></div>
     </div>
    </section><!-- Doctors Section -->
    <section id="section-doctors" class="section-content hidden">
     <div class="grid lg:grid-cols-2 gap-4"><!-- Add Doctor Form -->
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
       <h2 class="text-xl font-semibold mb-4">ğŸ‘¨â€âš•ï¸ Agregar Doctor</h2>
       <form id="doctor-form" class="space-y-4" onsubmit="event.preventDefault(); saveDoctor();">
        <div><label class="block text-sm font-medium mb-1">Nombre del Doctor</label> <input type="text" id="doctor-name" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Dr. Juan PÃ©rez">
        </div>
        <div><label class="block text-sm font-medium mb-1">Especialidad</label> <input type="text" id="doctor-specialty" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Escriba la especialidad">
        </div>
        <div><label class="block text-sm font-medium mb-1">Correo ElectrÃ³nico</label> <input type="email" id="doctor-email" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="doctor@email.com">
        </div>
        <div><label class="block text-sm font-medium mb-1">Servicios MÃ©dicos (escriba cada servicio)</label>
         <div id="services-list" class="space-y-2 mb-2"></div>
         <div class="flex gap-2"><input type="text" id="service-name" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="Ej: Consulta General"> <input type="number" id="service-price" min="0" step="0.01" class="w-32 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" placeholder="Precio"> <button type="button" onclick="addService()" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded-lg text-sm">+ Agregar</button>
         </div>
        </div>
        <div><label class="block text-sm font-medium mb-1">MÃ¡ximo de Citas por DÃ­a</label> <input type="number" id="doctor-max" required min="1" max="50" value="10" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
        </div>
        <div><label class="block text-sm font-medium mb-2">DÃ­as Disponibles</label>
         <div class="grid grid-cols-4 gap-2"><label class="flex items-center gap-2 text-sm"><input type="checkbox" value="0" class="day-checkbox rounded"> Dom</label> <label class="flex items-center gap-2 text-sm"><input type="checkbox" value="1" class="day-checkbox rounded" checked> Lun</label> <label class="flex items-center gap-2 text-sm"><input type="checkbox" value="2" class="day-checkbox rounded" checked> Mar</label> <label class="flex items-center gap-2 text-sm"><input type="checkbox" value="3" class="day-checkbox rounded" checked> MiÃ©</label> <label class="flex items-center gap-2 text-sm"><input type="checkbox" value="4" class="day-checkbox rounded" checked> Jue</label> <label class="flex items-center gap-2 text-sm"><input type="checkbox" value="5" class="day-checkbox rounded" checked> Vie</label> <label class="flex items-center gap-2 text-sm"><input type="checkbox" value="6" class="day-checkbox rounded"> SÃ¡b</label>
         </div>
        </div>
        <div><label class="block text-sm font-medium mb-2">Vacaciones</label>
         <div id="vacation-list" class="space-y-2 mb-2"></div>
         <div class="flex gap-2"><input type="date" id="vacation-start" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm"> <input type="date" id="vacation-end" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm"> <button type="button" onclick="addVacation()" class="bg-amber-600 hover:bg-amber-700 px-3 py-2 rounded-lg text-sm">+ Agregar</button>
         </div>
        </div><button type="submit" id="save-doctor-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium transition-all"> Guardar Doctor </button>
       </form>
      </div><!-- Doctors List -->
      <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
       <h2 class="text-xl font-semibold mb-4">ğŸ“‹ Lista de Doctores</h2>
       <div id="doctors-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin"></div>
      </div>
     </div>
    </section><!-- Mora QuirÃºrgica Section -->
    <section id="section-mora" class="section-content hidden">
     <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
      <h2 class="text-xl font-semibold mb-4">ğŸ“Š AnÃ¡lisis de Mora QuirÃºrgica</h2>
      <div class="grid md:grid-cols-3 gap-4 mb-6">
       <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-4">
        <p class="text-blue-100 text-sm">Total en Espera</p>
        <p id="mora-total" class="text-3xl font-bold">0</p>
       </div>
       <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-xl p-4">
        <p class="text-amber-100 text-sm">Promedio de DÃ­as</p>
        <p id="mora-average" class="text-3xl font-bold">0</p>
       </div>
       <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-4">
        <p class="text-red-100 text-sm">CrÃ­ticos (+60 dÃ­as)</p>
        <p id="mora-critical" class="text-3xl font-bold">0</p>
       </div>
      </div>
      <div id="mora-list" class="space-y-2"></div>
     </div>
    </section><!-- Finance Section -->
    <section id="section-finance" class="section-content hidden">
     <div class="space-y-6"><!-- Financial Summary Cards -->
      <div class="grid md:grid-cols-4 gap-4">
       <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl p-4 border border-green-500">
        <p class="text-green-100 text-sm mb-1">ğŸ’° Total Ingresos</p>
        <p id="total-income" class="text-3xl font-bold text-white">L.0.00</p>
        <p class="text-green-200 text-xs mt-1">Pagos completados</p>
       </div>
       <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-4 border border-red-500">
        <p class="text-red-100 text-sm mb-1">ğŸ’¸ Total Egresos</p>
        <p id="total-expenses" class="text-3xl font-bold text-white">L.0.00</p>
        <p class="text-red-200 text-xs mt-1">Gastos registrados</p>
       </div>
       <div id="balance-card" class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-4 border border-blue-500">
        <p class="text-blue-100 text-sm mb-1">ğŸ“Š Balance Neto</p>
        <p id="net-balance" class="text-3xl font-bold text-white">L.0.00</p>
        <p class="text-blue-200 text-xs mt-1">Ingresos - Egresos</p>
       </div>
       <div class="bg-gradient-to-br from-amber-600 to-amber-700 rounded-xl p-4 border border-amber-500">
        <p class="text-amber-100 text-sm mb-1">â³ Por Cobrar</p>
        <p id="pending-payments" class="text-3xl font-bold text-white">L.0.00</p>
        <p class="text-amber-200 text-xs mt-1">Pagos pendientes</p>
       </div>
      </div><!-- Tabs -->
      <div class="flex gap-2 border-b border-slate-700"><button onclick="showFinanceTab('payments')" class="finance-tab px-6 py-3 font-medium border-b-2 border-emerald-600 text-emerald-400" data-tab="payments"> ğŸ“Š Reportes de Pagos </button> <button onclick="showFinanceTab('expenses')" class="finance-tab px-6 py-3 font-medium border-b-2 border-transparent text-slate-400 hover:text-white" data-tab="expenses"> ğŸ“’ Contabilidad (Egresos) </button>
      </div><!-- Payments Tab -->
      <div id="finance-tab-payments" class="finance-tab-content">
       <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
         <h2 class="text-xl font-semibold">ğŸ’° Reportes de Pagos (Ingresos)</h2>
         <div class="flex gap-2"><button onclick="exportPaymentsPDF()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm font-medium transition-all">ğŸ“„ PDF</button> <button onclick="exportPaymentsExcel()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium transition-all">ğŸ“Š Excel</button>
         </div>
        </div><!-- Summary Stats -->
        <div class="grid md:grid-cols-4 gap-3 mb-4">
         <div class="bg-slate-700 rounded-lg p-3">
          <p class="text-xs text-slate-400">Total Cobrado</p>
          <p id="payments-completed" class="text-xl font-bold text-green-400">L.0.00</p>
         </div>
         <div class="bg-slate-700 rounded-lg p-3">
          <p class="text-xs text-slate-400">Total Pendiente</p>
          <p id="payments-pending" class="text-xl font-bold text-amber-400">L.0.00</p>
         </div>
         <div class="bg-slate-700 rounded-lg p-3">
          <p class="text-xs text-slate-400">Pagos Hoy</p>
          <p id="payments-today" class="text-xl font-bold text-blue-400">L.0.00</p>
         </div>
         <div class="bg-slate-700 rounded-lg p-3">
          <p class="text-xs text-slate-400">Total de Pagos</p>
          <p id="payments-count" class="text-xl font-bold text-emerald-400">0</p>
         </div>
        </div><!-- Filters -->
        <div class="grid md:grid-cols-3 gap-3 mb-4"><input type="text" id="filter-payment-patient" placeholder="ğŸ” Buscar por paciente..." class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" oninput="filterPayments()"> <select id="filter-payment-doctor" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterPayments()"> <option value="">Todos los doctores</option> </select> <select id="filter-payment-status" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterPayments()"> <option value="">Todos los estados</option> <option value="completado">Completado</option> <option value="pendiente">Pendiente</option> </select>
        </div>
        <div class="flex gap-2 mb-4"><input type="date" id="filter-payment-from" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm flex-1" onchange="filterPayments()" placeholder="Desde"> <input type="date" id="filter-payment-to" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm flex-1" onchange="filterPayments()" placeholder="Hasta">
        </div><!-- Payments List -->
        <div id="payments-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin"></div>
       </div>
      </div><!-- Expenses Tab -->
      <div id="finance-tab-expenses" class="finance-tab-content hidden">
       <div class="grid lg:grid-cols-2 gap-4"><!-- Add Expense Form -->
        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
         <h2 class="text-xl font-semibold mb-4">â• Registrar Gasto</h2>
         <form id="expense-form" class="space-y-4" onsubmit="event.preventDefault(); saveExpense();">
          <div><label class="block text-sm font-medium mb-1">Tipo de Gasto</label> <select id="expense-type" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="">Seleccione tipo...</option> <option value="salarios">ğŸ’¼ Salarios de Empleados</option> <option value="servicios">âš¡ Servicios PÃºblicos (Luz, Agua, etc.)</option> <option value="medicamentos">ğŸ’Š Medicamentos e Insumos</option> <option value="equipo">ğŸ¥ Equipo MÃ©dico</option> <option value="mantenimiento">ğŸ”§ Mantenimiento</option> <option value="limpieza">ğŸ§¹ Limpieza y Saneamiento</option> <option value="papeleria">ğŸ“„ PapelerÃ­a y Oficina</option> <option value="otros">ğŸ“¦ Otros</option> </select>
          </div>
          <div><label class="block text-sm font-medium mb-1">DescripciÃ³n</label> <input type="text" id="expense-description" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Detalle del gasto">
          </div>
          <div><label class="block text-sm font-medium mb-1">Monto (Lempiras)</label> <input type="number" id="expense-amount" required min="0" step="0.01" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="0.00">
          </div>
          <div><label class="block text-sm font-medium mb-1">Fecha del Gasto</label> <input type="date" id="expense-date" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
          </div>
          <div><label class="block text-sm font-medium mb-1">Nombre del Empleado (opcional)</label> <input type="text" id="expense-employee" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Solo para salarios">
          </div>
          <div><label class="block text-sm font-medium mb-1">Notas Adicionales</label> <textarea id="expense-notes" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 h-20" placeholder="Observaciones..."></textarea>
          </div><button type="submit" id="save-expense-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium transition-all"> Guardar Gasto </button>
         </form>
        </div><!-- Expenses List -->
        <div class="bg-slate-800 rounded-xl p-4 border border-slate-700">
         <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold">ğŸ“‹ Lista de Gastos</h2>
          <div class="flex gap-2"><button onclick="exportExpensesPDF()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-lg text-sm font-medium transition-all">ğŸ“„ PDF</button> <button onclick="exportExpensesExcel()" class="bg-green-600 hover:bg-green-700 px-3 py-2 rounded-lg text-sm font-medium transition-all">ğŸ“Š Excel</button>
          </div>
         </div><!-- Filters -->
         <div class="grid gap-2 mb-4"><select id="filter-expense-type" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" onchange="filterExpenses()"> <option value="">Todos los tipos</option> <option value="salarios">Salarios</option> <option value="servicios">Servicios PÃºblicos</option> <option value="medicamentos">Medicamentos</option> <option value="equipo">Equipo MÃ©dico</option> <option value="mantenimiento">Mantenimiento</option> <option value="limpieza">Limpieza</option> <option value="papeleria">PapelerÃ­a</option> <option value="otros">Otros</option> </select>
          <div class="flex gap-2"><input type="date" id="filter-expense-from" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm flex-1" onchange="filterExpenses()"> <input type="date" id="filter-expense-to" class="bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm flex-1" onchange="filterExpenses()">
          </div>
         </div>
         <p id="expenses-count" class="text-sm text-slate-400 mb-2"></p><!-- Expenses List -->
         <div id="expenses-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-thin"></div>
        </div>
       </div>
      </div>
     </div>
    </section><!-- Settings Section -->
    <section id="section-settings" class="section-content hidden">
     <div class="space-y-6">
      <!-- Tarjeta de GestiÃ³n de Perfiles eliminada -->

      <!-- System Settings -->
      <div class="bg-slate-800 rounded-xl p-6 border border-slate-700">
        <h2 class="text-xl font-semibold mb-4">âš™ï¸ ConfiguraciÃ³n del Sistema</h2>
        <form id="settings-form" class="space-y-4" onsubmit="event.preventDefault(); saveSettings();">
         <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ¥ Nombre del Hospital</label> 
            <input type="text" id="settings-hospital" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Hospital BÃ¡sico San Marcos de Ocotepeque">
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">ğŸ“± TÃ­tulo del Sistema</label> 
            <input type="text" id="settings-system" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Sistema de Citas MÃ©dicas">
          </div>
         </div>
         <div>
          <label class="block text-sm font-medium mb-2">ğŸ–¼ï¸ URL del Logo</label> 
          <input type="url" id="settings-logo" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="https://ejemplo.com/logo.png">
          <p class="text-xs text-slate-400 mt-1">La URL debe estar accesible en internet (ej: HTTPS)</p>
         </div>
         <button type="submit" id="save-settings-btn" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium transition-all">
           ğŸ’¾ Guardar ConfiguraciÃ³n
         </button>
        </form>
      </div>
     </div>
    </section>

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 p-4 no-print">
    <div class="bg-slate-800 rounded-xl max-w-md w-full animate-slide">
      <div class="p-6">
        <h2 class="text-xl font-semibold mb-4">ğŸ” Iniciar SesiÃ³n</h2>
        <form id="login-form" onsubmit="event.preventDefault(); loginUser();" class="space-y-3">
          <div>
            <label class="block text-sm font-medium mb-1">Usuario</label>
            <input id="login-username" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" required>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">ContraseÃ±a</label>
            <input id="login-password" type="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" required>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg">Entrar</button>
          </div>
          <p id="login-error" class="text-red-400 text-sm hidden"></p>
        </form>
      </div>
    </div>
  </div>

  <!-- User Management Modal -->
  <div id="user-management-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print overflow-y-auto">
    <div class="bg-slate-800 rounded-xl max-w-4xl w-full max-h-[95%] overflow-y-auto scrollbar-thin animate-slide my-4">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-2xl font-bold">ğŸ‘¥ GestiÃ³n de Perfiles de Usuario</h2>
            <p class="text-sm text-slate-400 mt-1">Crear, editar y administrar perfiles de acceso al sistema</p>
          </div>
          <button onclick="closeModal('user-management-modal')" class="text-slate-400 hover:text-white text-3xl">Ã—</button>
        </div>
        
        <!-- Tabs Navigation -->
        <div class="flex gap-2 mb-6 border-b border-slate-700">
          <button onclick="switchUserTab('create')" class="user-tab px-6 py-3 font-medium border-b-2 border-emerald-600 text-emerald-400" data-tab="create">
            â• Crear Nuevo Perfil
          </button>
          <button onclick="switchUserTab('existing')" class="user-tab px-6 py-3 font-medium border-b-2 border-transparent text-slate-400 hover:text-white" data-tab="existing">
            ğŸ“‹ Perfiles Existentes
          </button>
          <button onclick="switchUserTab('templates')" class="user-tab px-6 py-3 font-medium border-b-2 border-transparent text-slate-400 hover:text-white" data-tab="templates">
            ğŸ¢ Plantillas de Rol
          </button>
        </div>

        <!-- Create/Edit Tab -->
        <div id="tab-create" class="user-tab-content">
          <div class="bg-slate-700/30 rounded-lg p-6 border border-slate-700">
            <h3 class="font-bold mb-4 text-lg">â• Crear o Editar Perfil de Usuario</h3>
            <form id="user-form" onsubmit="event.preventDefault(); saveUserFromForm();" class="grid md:grid-cols-2 gap-4">
              <input type="hidden" id="user-edit-username">
              
              <div class="md:col-span-2">
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium mb-2">ğŸ‘¤ Nombre de Usuario</label>
                    <input id="user-username" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-emerald-500" placeholder="usuario@hospital">
                    <p class="text-xs text-slate-400 mt-1">Usado para iniciar sesiÃ³n en el sistema</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">ğŸ” ContraseÃ±a</label>
                    <input id="user-password" type="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-emerald-500" placeholder="Dejar en blanco para no cambiar">
                    <p class="text-xs text-slate-400 mt-1">MÃ­nimo 6 caracteres recomendado</p>
                  </div>
                </div>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium mb-2">âœ“ Confirmar ContraseÃ±a</label>
                <input id="user-password-confirm" type="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-emerald-500" placeholder="Repetir contraseÃ±a">
              </div>

              <div>
                <label class="block text-sm font-medium mb-2">ğŸ­ Rol o Perfil</label>
                <select id="user-role" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 focus:outline-none focus:border-emerald-500" onchange="updateRoleDescription()">
                  <option value="admin">ğŸ‘‘ Administrador (acceso total)</option>
                  <option value="medico">ğŸ‘¨â€âš•ï¸ MÃ©dico (citas, triajes, diagnÃ³sticos)</option>
                  <option value="enfermeria">ğŸ’‰ EnfermerÃ­a (triajes y citas)</option>
                  <option value="recepcion">ğŸ“ RecepciÃ³n (citas y calendario)</option>
                  <option value="custom">âš™ï¸ Personalizado (configurable)</option>
                </select>
                <p id="role-description" class="text-xs text-slate-400 mt-2">Acceso administrativo total al sistema</p>
              </div>

              <div id="permissions-list" class="hidden md:col-span-2">
                <label class="block text-sm font-medium mb-3">ğŸ”’ Permisos Personalizados</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-slate-800 rounded p-4">
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="calendar" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ“… Calendario</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="appointments" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ“‹ Citas</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="triage-pending" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ©º Triajes</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="diagnosis-pending" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ“Š DiagnÃ³sticos</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="doctors" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ‘¨â€âš•ï¸ Doctores</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="finance" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ’° Finanzas</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="settings" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">âš™ï¸ ConfiguraciÃ³n</span>
                  </label>
                  <label class="flex items-center gap-2 cursor-pointer hover:bg-slate-700 p-2 rounded">
                    <input type="checkbox" value="reassign" class="perm-checkbox rounded bg-slate-700 border-slate-600 accent-emerald-600">
                    <span class="text-sm">ğŸ”„ Reasignar Citas</span>
                  </label>
                </div>
              </div>

              <div class="md:col-span-2 flex gap-3 pt-4">
                <button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 px-6 py-3 rounded-lg font-medium transition-all">
                  âœ“ Guardar Perfil
                </button>
                <button type="button" onclick="resetUserForm()" class="flex-1 bg-slate-600 hover:bg-slate-500 px-6 py-3 rounded-lg font-medium transition-all">
                  ğŸ”„ Limpiar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Existing Users Tab -->
        <div id="tab-existing" class="user-tab-content hidden">
          <div class="space-y-2">
            <div class="flex gap-2">
              <button onclick="exportUsers()" class="bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                ğŸ“¤ Exportar Todos (JSON)
              </button>
              <button onclick="document.getElementById('import-users-file').click()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                ğŸ“¥ Importar (JSON)
              </button>
              <input id="import-users-file" type="file" accept="application/json" class="hidden" onchange="importUsers(event)">
            </div>
            <div id="users-list" class="space-y-2 max-h-[55vh] overflow-y-auto scrollbar-thin"></div>
          </div>
        </div>

        <!-- Templates Tab -->
        <div id="tab-templates" class="user-tab-content hidden">
          <div class="grid md:grid-cols-2 gap-4">
            <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-slate-700/50 transition-all" onclick="applyTemplate('medico')">
              <h4 class="font-bold text-lg mb-2">ğŸ‘¨â€âš•ï¸ Perfil de MÃ©dico</h4>
              <p class="text-sm text-slate-400 mb-3">Acceso completo a citas, triajes y diagnÃ³sticos</p>
              <div class="text-xs text-emerald-400 space-y-1">
                <p>âœ“ Calendario</p>
                <p>âœ“ Lista de Citas</p>
                <p>âœ“ Triajes Pendientes</p>
                <p>âœ“ DiagnÃ³sticos</p>
              </div>
            </div>

            <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-slate-700/50 transition-all" onclick="applyTemplate('enfermeria')">
              <h4 class="font-bold text-lg mb-2">ğŸ’‰ Perfil de EnfermerÃ­a</h4>
              <p class="text-sm text-slate-400 mb-3">Acceso a citas, triajes y datos de pacientes</p>
              <div class="text-xs text-emerald-400 space-y-1">
                <p>âœ“ Calendario</p>
                <p>âœ“ Lista de Citas</p>
                <p>âœ“ Triajes Pendientes</p>
              </div>
            </div>

            <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-slate-700/50 transition-all" onclick="applyTemplate('recepcion')">
              <h4 class="font-bold text-lg mb-2">ğŸ“ Perfil de RecepciÃ³n</h4>
              <p class="text-sm text-slate-400 mb-3">Acceso bÃ¡sico para gestionar citas</p>
              <div class="text-xs text-emerald-400 space-y-1">
                <p>âœ“ Calendario</p>
                <p>âœ“ Lista de Citas</p>
                <p>âœ“ Reasignar Citas</p>
              </div>
            </div>

            <div class="bg-slate-700/30 rounded-lg p-4 border border-slate-700 cursor-pointer hover:border-emerald-500 hover:bg-slate-700/50 transition-all" onclick="applyTemplate('admin')">
              <h4 class="font-bold text-lg mb-2">ğŸ‘‘ Perfil de Administrador</h4>
              <p class="text-sm text-slate-400 mb-3">Acceso total a todas las funciones</p>
              <div class="text-xs text-emerald-400 space-y-1">
                <p>âœ“ Acceso Total</p>
                <p>âœ“ GestiÃ³n de Usuarios</p>
                <p>âœ“ ConfiguraciÃ³n del Sistema</p>
                <p>âœ“ Finanzas</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
   </main><!-- New Appointment Modal -->
   <div id="appointment-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print overflow-y-auto">
    <div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90%] overflow-y-auto scrollbar-thin animate-slide my-4">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">â• Nueva Cita</h2><button onclick="closeModal('appointment-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <form id="appointment-form" class="space-y-4" onsubmit="event.preventDefault(); saveAppointment();">
       <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">Nombre del Paciente</label> <input type="text" id="apt-patient-name" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
        </div>
        <div><label class="block text-sm font-medium mb-1">NÃºmero de Identidad</label> <input type="text" id="apt-patient-id" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="0000-0000-00000">
        </div>
       </div>
       <div><label class="block text-sm font-medium mb-1">TelÃ©fono de Contacto</label> <input type="tel" id="apt-phone" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="9999-9999">
       </div>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">Fecha de Nacimiento</label> <input type="date" id="apt-birthdate" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" onchange="calculateAge()">
        </div>
        <div><label class="block text-sm font-medium mb-1">Edad</label> <input type="text" id="apt-age" readonly class="w-full bg-slate-600 border border-slate-500 rounded-lg px-3 py-2 text-slate-300" placeholder="Se calcula automÃ¡ticamente">
        </div>
       </div>
       <div><label class="block text-sm font-medium mb-1">Origen de la Cita</label> <select id="apt-origin" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="">Seleccione origen...</option> <option value="consulta_externa">Consulta Externa</option> <option value="emergencia">Emergencia</option> <option value="sala">Por medio de la Sala</option> <option value="referencia_centro_salud">Referencia - Centro de Salud</option> <option value="referencia_clinica_privada">Referencia - ClÃ­nica Privada</option> </select>
       </div>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">Departamento</label> <select id="apt-department" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" onchange="updateMunicipalities()"> <option value="">Seleccione departamento...</option> </select>
        </div>
        <div><label class="block text-sm font-medium mb-1">Municipio</label> <select id="apt-municipality" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="">Seleccione municipio...</option> </select>
        </div>
       </div>
       <div><label class="block text-sm font-medium mb-1">Barrio o Aldea</label> <input type="text" id="apt-neighborhood" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Ingrese barrio o aldea">
       </div>
       <div><label class="block text-sm font-medium mb-1">Doctor</label> <select id="apt-doctor" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" onchange="findAvailableSlot()"> <option value="">Seleccione doctor...</option> </select>
       </div>
       <div class="bg-slate-700/50 rounded-lg p-4"><label class="block text-sm font-medium mb-2">ProgramaciÃ³n de Cita</label>
        <div class="grid md:grid-cols-2 gap-4">
         <div><label class="block text-xs text-slate-400 mb-1">DÃ­as para la cita</label>
          <div class="flex gap-2"><input type="number" id="apt-days" min="1" max="365" value="30" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <button type="button" onclick="findAvailableSlot()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">Buscar Cupo</button>
          </div>
         </div>
         <div><label class="block text-xs text-slate-400 mb-1">Fecha Encontrada</label> <input type="date" id="apt-date" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
         </div>
        </div>
        <div class="mt-2"><label class="block text-xs text-slate-400 mb-1">Hora</label> <select id="apt-time" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="07:00">07:00 AM</option> <option value="07:30">07:30 AM</option> <option value="08:00">08:00 AM</option> <option value="08:30">08:30 AM</option> <option value="09:00">09:00 AM</option> <option value="09:30">09:30 AM</option> <option value="10:00">10:00 AM</option> <option value="10:30">10:30 AM</option> <option value="11:00">11:00 AM</option> <option value="11:30">11:30 AM</option> <option value="13:00">01:00 PM</option> <option value="13:30">01:30 PM</option> <option value="14:00">02:00 PM</option> <option value="14:30">02:30 PM</option> <option value="15:00">03:00 PM</option> </select>
        </div>
        <p id="slot-info" class="text-sm text-emerald-400 mt-2"></p><!-- Available Slots List -->
        <div id="available-slots-list" class="mt-4"></div>
       </div>
       <div class="flex gap-2"><button type="submit" id="save-apt-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium transition-all"> Guardar Cita </button> <button type="button" onclick="closeModal('appointment-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium transition-all"> Cancelar </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Print/Download Modal -->
   <div id="print-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print">
    <div class="bg-slate-800 rounded-xl max-w-md w-full animate-slide">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold">âœ… Cita Guardada</h2><button onclick="closeModal('print-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <p class="text-slate-300 mb-4">La cita ha sido guardada exitosamente. Â¿QuÃ© desea hacer?</p>
      <div class="space-y-2"><button onclick="printTicket()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2"> ğŸ–¨ï¸ Imprimir Ticket (58mm) </button> <button onclick="downloadPDF()" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2"> ğŸ“„ Descargar PDF Simple </button> <button onclick="downloadCompletePDF()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2"> ğŸ“„ Descargar PDF Completo </button> <button onclick="closeModal('print-modal')" class="w-full bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium transition-all"> Cerrar </button>
      </div>
     </div>
    </div>
   </div><!-- Triage Modal -->
   <div id="triage-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print overflow-y-auto">
    <div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90%] overflow-y-auto scrollbar-thin animate-slide my-4">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ©º Triaje MÃ©dico</h2><button onclick="closeModal('triage-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <form id="triage-form" class="space-y-4" onsubmit="event.preventDefault(); saveTriage();"><input type="hidden" id="triage-apt-id">
       <div class="bg-blue-600/20 border border-blue-600 rounded-lg p-3 mb-4">
        <p class="font-semibold" id="triage-patient-name"></p>
        <p class="text-sm text-slate-300" id="triage-patient-info"></p>
       </div>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium mb-1">PresiÃ³n Arterial</label> <input type="text" id="triage-bp" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="120/80">
        </div>
        <div><label class="block text-sm font-medium mb-1">Frecuencia CardÃ­aca (bpm)</label> <input type="number" id="triage-hr" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="72">
        </div>
        <div><label class="block text-sm font-medium mb-1">Temperatura (Â°C)</label> <input type="number" step="0.1" id="triage-temp" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="36.5">
        </div>
        <div><label class="block text-sm font-medium mb-1">Peso (kg)</label> <input type="number" step="0.1" id="triage-weight" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="70">
        </div>
        <div><label class="block text-sm font-medium mb-1">Altura (cm)</label> <input type="number" id="triage-height" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="170">
        </div>
        <div><label class="block text-sm font-medium mb-1">SaturaciÃ³n Oâ‚‚ (%)</label> <input type="number" id="triage-oxygen" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="98">
        </div>
       </div>
       <div><label class="block text-sm font-medium mb-1">Notas Adicionales</label> <textarea id="triage-notes" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 h-24" placeholder="Observaciones del triaje..."></textarea>
       </div>
       <div class="flex gap-2"><button type="submit" id="save-triage-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium"> Guardar Triaje </button> <button type="button" onclick="printTriageAndContinue()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium"> Imprimir y Continuar </button> <button type="button" onclick="closeModal('triage-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium"> Cancelar </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Diagnosis Modal -->
   <div id="diagnosis-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print overflow-y-auto">
    <div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90%] overflow-y-auto scrollbar-thin animate-slide my-4">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ“‹ DiagnÃ³stico MÃ©dico</h2><button onclick="closeModal('diagnosis-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <form id="diagnosis-form" class="space-y-4" onsubmit="event.preventDefault(); saveDiagnosis();"><input type="hidden" id="diagnosis-apt-id">
       <div class="bg-blue-600/20 border border-blue-600 rounded-lg p-3 mb-4">
        <p class="font-semibold" id="diagnosis-patient-name"></p>
        <p class="text-sm text-slate-300" id="diagnosis-patient-info"></p>
        <div id="diagnosis-triage-info" class="text-xs text-slate-400 mt-2"></div>
       </div>
       <div><label class="block text-sm font-medium mb-1">Servicio MÃ©dico</label> <select id="diagnosis-service" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="">Seleccione servicio...</option> </select>
        <p class="text-xs text-emerald-400 mt-1" id="service-price-display"></p>
       </div>
       <div><label class="block text-sm font-medium mb-1">DiagnÃ³stico</label> <textarea id="diagnosis-text" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 h-32" placeholder="Escriba el diagnÃ³stico mÃ©dico..."></textarea>
       </div>
       <div class="flex gap-2"><button type="submit" id="save-diagnosis-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium"> Guardar y Procesar Pago </button> <button type="button" onclick="closeModal('diagnosis-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium"> Cancelar </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Reference Modal -->
   <div id="reference-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print overflow-y-auto">
    <div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90%] overflow-y-auto scrollbar-thin animate-slide my-4">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ¥ Referencia MÃ©dica</h2><button onclick="closeModal('reference-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <form id="reference-form" class="space-y-4" onsubmit="event.preventDefault(); saveReference();"><input type="hidden" id="reference-apt-id">
       <div class="bg-red-600/20 border border-red-600 rounded-lg p-3 mb-4">
        <p class="font-semibold" id="reference-patient-name"></p>
        <p class="text-sm text-slate-300" id="reference-patient-info"></p>
        <div id="reference-diagnosis-info" class="text-xs text-slate-300 mt-2 p-2 bg-slate-700 rounded"></div>
       </div>
       <div><label class="block text-sm font-medium mb-1">Hospital/Centro de Referencia</label> <input type="text" id="reference-hospital" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Hospital Regional, Centro Especializado...">
       </div>
       <div><label class="block text-sm font-medium mb-1">Motivo de Referencia</label> <textarea id="reference-reason" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 h-24" placeholder="Describa el motivo de la referencia..."></textarea>
       </div>
       <div class="flex gap-2"><button type="submit" id="save-reference-btn" class="flex-1 bg-red-600 hover:bg-red-700 py-3 rounded-lg font-medium"> Generar Referencia </button> <button type="button" onclick="closeModal('reference-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium"> Cancelar </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Print Options Modal -->
    <!-- Prescription Modal -->
    <div id="prescription-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print overflow-y-auto">
      <div class="bg-slate-800 rounded-xl max-w-2xl w-full max-h-[90%] overflow-y-auto scrollbar-thin animate-slide my-4">
        <div class="p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">ğŸ’Š Generar Receta MÃ©dica</h2>
            <button onclick="closeModal('prescription-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
          </div>
          <form id="prescription-form" class="space-y-4" onsubmit="event.preventDefault(); generatePrescription();">
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Buscar Paciente</label>
                <input list="patients-list" id="presc-patient" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Escriba nombre del paciente...">
                <datalist id="patients-list"></datalist>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">NÃºmero de Identidad</label>
                <input type="text" id="presc-id" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="0000-0000-00000">
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 mt-2">
              <div>
                <label class="block text-sm font-medium mb-1">MÃ©dico (seleccione)</label>
                <select id="prescription-doctor" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"></select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Nombre del MÃ©dico</label>
                <input type="text" id="presc-doctor-name" readonly class="w-full bg-slate-600 border border-slate-500 rounded-lg px-3 py-2 text-slate-300" placeholder="Se rellena automÃ¡ticamente">
              </div>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium mb-1">Agregar Medicamento</label>
              <div class="grid md:grid-cols-4 gap-2">
                <div>
                  <input list="meds-list" id="presc-med-name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Medicamento...">
                  <datalist id="meds-list"></datalist>
                </div>
                <div>
                  <input id="presc-med-dose" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2" placeholder="Dosis (ej. 500 mg)">
                </div>
                <div>
                  <select id="presc-med-frequency" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
                    <option value="">Frecuencia...</option>
                    <option value="Cada 8 horas">Cada 8 horas</option>
                    <option value="Cada 12 horas">Cada 12 horas</option>
                    <option value="Cada 24 horas">Cada 24 horas</option>
                    <option value="Una vez al dÃ­a">Una vez al dÃ­a</option>
                    <option value="SegÃºn indicaciÃ³n">SegÃºn indicaciÃ³n</option>
                  </select>
                </div>
                <div class="flex items-center">
                  <button type="button" onclick="addMedicationToList()" class="w-full bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg">+ AÃ±adir</button>
                </div>
              </div>
              <div id="presc-meds-list" class="mt-3 space-y-2 text-sm"></div>
              <p class="text-xs text-slate-400 mt-2">TambiÃ©n puede usar el Ã¡rea de notas si necesita instrucciones libres.</p>
              <div class="mt-2">
                <label class="block text-sm font-medium mb-1">Notas Adicionales</label>
                <textarea id="presc-notes" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 h-20" placeholder="Observaciones..."></textarea>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Notas Adicionales</label>
              <textarea id="presc-notes" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 h-20" placeholder="Observaciones..."></textarea>
            </div>
            <div id="prescription-view" class="hidden">
              <div id="prescription-printable" class="bg-white text-black p-4 rounded"></div>
            </div>
            <div id="prescription-actions" class="hidden flex gap-2">
              <button type="button" onclick="printPrescription()" class="flex-1 bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium">ğŸ–¨ï¸ Imprimir</button>
              <button type="button" onclick="closeModal('prescription-modal')" class="flex-1 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium">Cerrar</button>
            </div>
            <div class="flex gap-2">
              <button type="submit" id="generate-presc-btn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium"> Generar Receta </button>
              <button type="button" onclick="closeModal('prescription-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
   <div id="print-options-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print">
    <div class="bg-slate-800 rounded-xl max-w-md w-full animate-slide">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold" id="print-options-title">Opciones de ImpresiÃ³n</h2><button onclick="closeModal('print-options-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div><input type="hidden" id="print-apt-id"> <input type="hidden" id="print-type">
      <div class="space-y-2"><button onclick="printDocument()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2"> ğŸ–¨ï¸ Imprimir </button> <button onclick="downloadDocumentPDF()" class="w-full bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2"> ğŸ“„ Descargar PDF </button> <button onclick="generatePDFLink()" class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2"> ğŸ”— Generar Enlace PDF </button> <button onclick="closeModal('print-options-modal')" class="w-full bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium transition-all"> Cerrar </button>
      </div>
   </div><!-- Reassign Modal -->
   <div id="reassign-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print">
    <div class="bg-slate-800 rounded-xl max-w-md w-full animate-slide">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ”„ Reasignar Cita</h2><button onclick="closeModal('reassign-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <form id="reassign-form" class="space-y-4" onsubmit="event.preventDefault(); confirmReassign();"><input type="hidden" id="reassign-id">
       <div><label class="block text-sm font-medium mb-1">Doctor</label> <select id="reassign-doctor-select" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="">Seleccione doctor...</option> </select>
       </div>
       <div><label class="block text-sm font-medium mb-1">Nueva Fecha</label> <input type="date" id="reassign-date" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2">
       </div>
       <div><label class="block text-sm font-medium mb-1">Nueva Hora</label> <select id="reassign-time" required class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2"> <option value="07:00">07:00 AM</option> <option value="08:00">08:00 AM</option> <option value="09:00">09:00 AM</option> <option value="10:00">10:00 AM</option> <option value="11:00">11:00 AM</option> <option value="13:00">01:00 PM</option> <option value="14:00">02:00 PM</option> <option value="15:00">03:00 PM</option> </select>
       </div>
       <div class="bg-blue-600/20 rounded p-3 text-xs text-blue-300 border border-blue-500">
        <strong>ğŸ’¡ Consejo:</strong> Las citas reasignadas permanecerÃ¡n visibles en la lista con un color diferente. PodrÃ¡ enviar mensaje de confirmaciÃ³n al paciente.
       </div>
       <div class="flex gap-2"><button type="submit" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium">Confirmar</button> <button type="button" onclick="closeModal('reassign-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium">Cancelar</button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Email Modal -->
   <div id="email-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50 p-4 no-print">
    <div class="bg-slate-800 rounded-xl max-w-lg w-full animate-slide">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-semibold">ğŸ“§ Enviar Calendario al Doctor</h2><button onclick="closeModal('email-modal')" class="text-slate-400 hover:text-white text-2xl">Ã—</button>
      </div>
      <div id="email-preview" class="bg-slate-900 rounded-lg p-4 text-sm max-h-64 overflow-y-auto scrollbar-thin mb-4"></div>
      <p class="text-slate-400 text-sm mb-4">El calendario serÃ¡ enviado al correo del doctor seleccionado.</p>
      <div class="flex gap-2"><button onclick="sendCalendarEmail()" class="flex-1 bg-emerald-600 hover:bg-emerald-700 py-3 rounded-lg font-medium">Enviar Correo</button> <button onclick="closeModal('email-modal')" class="px-6 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium">Cancelar</button>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Honduras Departments and Municipalities Data
    const hondurasData = {
      "AtlÃ¡ntida": ["La Ceiba", "El Porvenir", "Esparta", "Jutiapa", "La Masica", "San Francisco", "Tela", "Arizona"],
      "ColÃ³n": ["Trujillo", "Balfate", "Iriona", "LimÃ³n", "SabÃ¡", "Santa Fe", "Santa Rosa de AguÃ¡n", "Sonaguera", "Tocoa", "Bonito Oriental"],
      "Comayagua": ["Comayagua", "Ajuterique", "El Rosario", "EsquÃ­as", "Humuya", "La Libertad", "LamanÃ­", "La Trinidad", "LejamanÃ­", "MeÃ¡mbar", "Minas de Oro", "Ojos de Agua", "San JerÃ³nimo", "San JosÃ© de Comayagua", "San JosÃ© del Potrero", "San Luis", "San SebastiÃ¡n", "Siguatepeque", "Villa de San Antonio", "Las Lajas", "TaulabÃ©"],
      "CopÃ¡n": ["Santa Rosa de CopÃ¡n", "CabaÃ±as", "ConcepciÃ³n", "CopÃ¡n Ruinas", "CorquÃ­n", "Cucuyagua", "Dolores", "Dulce Nombre", "El ParaÃ­so", "Florida", "La Jigua", "La UniÃ³n", "Nueva Arcadia", "San AgustÃ­n", "San Antonio", "San JerÃ³nimo", "San JosÃ©", "San Juan de Opoa", "San NicolÃ¡s", "San Pedro", "Santa Rita", "Trinidad de CopÃ¡n", "Veracruz"],
      "CortÃ©s": ["San Pedro Sula", "Choloma", "Omoa", "Pimienta", "Potrerillos", "Puerto CortÃ©s", "San Antonio de CortÃ©s", "San Francisco de Yojoa", "San Manuel", "Santa Cruz de Yojoa", "Villanueva", "La Lima"],
      "Choluteca": ["Choluteca", "Apacilagua", "ConcepciÃ³n de MarÃ­a", "Duyure", "El Corpus", "El Triunfo", "Marcovia", "Morolica", "NamasigÃ¼e", "Orocuina", "Pespire", "San Antonio de Flores", "San Isidro", "San JosÃ©", "San Marcos de ColÃ³n", "Santa Ana de Yusguare"],
      "El ParaÃ­so": ["YuscarÃ¡n", "Alauca", "DanlÃ­", "El ParaÃ­so", "GÃ¼inope", "Jacaleapa", "Liure", "MorocelÃ­", "OropolÃ­", "Potrerillos", "San Antonio de Flores", "San Lucas", "San MatÃ­as", "Soledad", "Teupasenti", "Texiguat", "Trojes", "Vado Ancho"],
      "Francisco MorazÃ¡n": ["Tegucigalpa", "AlubarÃ©n", "Cedros", "CurarÃ©n", "El Porvenir", "Guaimaca", "La Libertad", "La Venta", "Lepaterique", "Maraita", "Marale", "Nueva Armenia", "Ojojona", "Orica", "Reitoca", "Sabanagrande", "San Antonio de Oriente", "San Buenaventura", "San Ignacio", "San Juan de Flores", "San Miguelito", "Santa Ana", "Santa LucÃ­a", "Talanga", "Tatumbla", "Valle de Ãngeles", "Villa de San Francisco", "Vallecillo"],
      "Gracias a Dios": ["Puerto Lempira", "Brus Laguna", "Ahuas", "Juan Francisco Bulnes", "RamÃ³n Villeda Morales", "Wampusirpi"],
      "IntibucÃ¡": ["La Esperanza", "Camasca", "Colomoncagua", "ConcepciÃ³n", "Dolores", "IntibucÃ¡", "JesÃºs de Otoro", "Magdalena", "Masaguara", "San Antonio", "San Isidro", "San Juan", "San Marcos de la Sierra", "San Miguel Guancapla", "Santa LucÃ­a", "Yamaranguila", "San Francisco de Opalaca"],
      "Islas de la BahÃ­a": ["RoatÃ¡n", "Guanaja", "JosÃ© Santos Guardiola", "Utila"],
      "La Paz": ["La Paz", "Aguanqueterique", "CabaÃ±as", "Cane", "Chinacla", "Guajiquiro", "Lauterique", "Marcala", "Mercedes de Oriente", "Opatoro", "San Antonio del Norte", "San JosÃ©", "San Juan", "San Pedro de Tutule", "Santa Ana", "Santa Elena", "Santa MarÃ­a", "Santiago de Puringla", "Yarula"],
      "Lempira": ["Gracias", "BelÃ©n", "Candelaria", "Cololaca", "Erandique", "Gualcince", "Guarita", "La Campa", "La Iguala", "Las Flores", "La UniÃ³n", "La Virtud", "Lepaera", "Mapulaca", "Piraera", "San AndrÃ©s", "San Francisco", "San Juan Guarita", "San Manuel Colohete", "San Rafael", "San SebastiÃ¡n", "Santa Cruz", "Talgua", "Tambla", "TomalÃ¡", "Valladolid", "Virginia", "San Marcos de CaiquÃ­n"],
      "Ocotepeque": ["Ocotepeque", "BelÃ©n Gualcho", "ConcepciÃ³n", "Dolores MerendÃ³n", "Fraternidad", "La EncarnaciÃ³n", "La Labor", "Lucerna", "Mercedes", "San Fernando", "San Francisco del Valle", "San Jorge", "San Marcos", "Santa Fe", "Sensenti", "Sinuapa"],
      "Olancho": ["Juticalpa", "Campamento", "Catacamas", "Concordia", "Dulce Nombre de CulmÃ­", "El Rosario", "Esquipulas del Norte", "Gualaco", "Guarizama", "Guata", "Guayape", "Jano", "La UniÃ³n", "Mangulile", "Manto", "SalamÃ¡", "San Esteban", "San Francisco de Becerra", "San Francisco de La Paz", "Santa MarÃ­a del Real", "Silca", "YocÃ³n", "Patuca"],
      "Santa BÃ¡rbara": ["Santa BÃ¡rbara", "Arada", "Atima", "Azacualpa", "Ceguaca", "ConcepciÃ³n del Norte", "ConcepciÃ³n del Sur", "Chinda", "El NÃ­spero", "Gualala", "Ilama", "Las Vegas", "Macuelizo", "Naranjito", "Nuevo Celilac", "Petoa", "ProtecciÃ³n", "QuimistÃ¡n", "San Francisco de Ojuera", "San JosÃ© de Colinas", "San Luis", "San Marcos", "San NicolÃ¡s", "San Pedro Zacapa", "Santa Rita", "Trinidad", "San Vicente Centenario"],
      "Valle": ["Nacaome", "Alianza", "Amapala", "Aramecina", "Caridad", "GoascorÃ¡n", "Langue", "San Francisco de Coray", "San Lorenzo"],
      "Yoro": ["Yoro", "Arenal", "El Negrito", "El Progreso", "JocÃ³n", "MorazÃ¡n", "Olanchito", "Santa Rita", "Sulaco", "Victoria", "Yorito"]
    };

    // State
    let allData = [];
    let doctors = [];
    let appointments = [];
    let expenses = [];
    let settings = null;
    let currentMonth = new Date();
    let selectedDate = null;
    let lastSavedAppointment = null;
    let tempVacations = [];
    let tempServices = [];
    let editingDoctorId = null;
    let currentTriageApt = null;
    let currentDiagnosisApt = null;

    const defaultConfig = {
      hospital_name: "Hospital BÃ¡sico San Marcos de Ocotepeque",
      system_title: "Sistema de Citas MÃ©dicas",
      logo_url: "",
      primary_color: "#059669",
      secondary_color: "#1e293b",
      text_color: "#ffffff",
      accent_color: "#0ea5e9",
      surface_color: "#334155"
    };

    // Local persistence helpers
    const LOCAL_KEY = 'citas_publicas_data_v1';

    function saveAllToLocal() {
      try {
        const payload = {
          doctors,
          appointments,
          expenses,
          settings
        };
        localStorage.setItem(LOCAL_KEY, JSON.stringify(payload));
      } catch (err) {
        console.error('Error saving to localStorage', err);
      }
    }

    function loadAllFromLocal() {
      try {
        const raw = localStorage.getItem(LOCAL_KEY);
        if (!raw) return [];
        const obj = JSON.parse(raw || '{}');
        const out = [];
        if (Array.isArray(obj.doctors)) out.push(...obj.doctors.map(d => ({ ...d, type: 'doctor' })));
        if (Array.isArray(obj.appointments)) out.push(...obj.appointments.map(a => ({ ...a, type: 'appointment' })));
        if (Array.isArray(obj.expenses)) out.push(...obj.expenses.map(e => ({ ...e, type: 'expense' })));
        if (obj.settings) out.push({ ...obj.settings, type: 'settings' });
        return out;
      } catch (err) {
        console.error('Error loading from localStorage', err);
        return [];
      }
    }

    // Try to sync local-only records (those with __backendId starting with 'local-') to the server
    async function trySyncLocal() {
      if (!window.dataSdk || typeof window.dataSdk.create !== 'function') return;
      // Sync doctors
      for (const doc of [...doctors]) {
        if (doc.__backendId && String(doc.__backendId).startsWith('local-')) {
          try {
            const payload = { ...doc };
            delete payload.__backendId;
            const res = await window.dataSdk.create(payload);
            if (res && res.isOk) {
              // Remove local-only marker and rely on SDK to refresh data via dataHandler
              const idx = doctors.findIndex(d => d.__backendId === doc.__backendId);
              if (idx !== -1) doctors.splice(idx, 1);
              showToast('Doctor sincronizado con servidor', 'success');
            }
          } catch (e) {
            console.warn('No se pudo sincronizar doctor', doc.__backendId, e);
          }
        }
      }

      // Sync appointments
      for (const apt of [...appointments]) {
        if (apt.__backendId && String(apt.__backendId).startsWith('local-')) {
          try {
            const payload = { ...apt };
            delete payload.__backendId;
            const res = await window.dataSdk.create(payload);
            if (res && res.isOk) {
              const idx = appointments.findIndex(a => a.__backendId === apt.__backendId);
              if (idx !== -1) appointments.splice(idx, 1);
              showToast('Cita sincronizada con servidor', 'success');
            }
          } catch (e) {
            console.warn('No se pudo sincronizar cita', apt.__backendId, e);
          }
        }
      }

      // Sync expenses
      for (const exp of [...expenses]) {
        if (exp.__backendId && String(exp.__backendId).startsWith('local-')) {
          try {
            const payload = { ...exp };
            delete payload.__backendId;
            const res = await window.dataSdk.create(payload);
            if (res && res.isOk) {
              const idx = expenses.findIndex(e => e.__backendId === exp.__backendId);
              if (idx !== -1) expenses.splice(idx, 1);
              showToast('Gasto sincronizado con servidor', 'success');
            }
          } catch (e) {
            console.warn('No se pudo sincronizar gasto', exp.__backendId, e);
          }
        }
      }

      // Sync settings
      if (settings && settings.__backendId && String(settings.__backendId).startsWith('local-')) {
        try {
          const payload = { ...settings };
          delete payload.__backendId;
          const res = await window.dataSdk.create(payload);
          if (res && res.isOk) {
            showToast('ConfiguraciÃ³n sincronizada con servidor', 'success');
            settings = null; // server dataHandler should repopulate
          }
        } catch (e) {
          console.warn('No se pudo sincronizar settings', e);
        }
      }

      // After attempts, save remaining local state
      saveAllToLocal();
      // Request SDK to refresh if available
      if (window.dataSdk && typeof window.dataSdk.refresh === 'function') {
        try { window.dataSdk.refresh(); } catch (e) { /* ignore */ }
      }
    }

    // Data Handler
    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        doctors = data.filter(d => d.type === 'doctor');
        appointments = data.filter(d => d.type === 'appointment');
        expenses = data.filter(d => d.type === 'expense');
        settings = data.find(d => d.type === 'settings');
        
        loadSettings();
        updateDoctorSelect();
        updateDoctorFilter();
        updateFilterDoctorSelect();
        renderCalendar();
        renderDoctorsList();
        renderAppointmentsList();
        renderReassignList();
        renderMoraAnalysis();
        updateAvailableSlots();
        renderTriagePending();
        renderTriagesCompleted();
        renderDiagnosisPending();
        renderFinanceSummary();
        renderPaymentsList();
        renderExpensesList();
        // Keep a local copy so data persists when SDK is not present
        try { saveAllToLocal(); } catch (e) { /* ignore */ }
      }
    };

    // Initialize
    async function init() {
      populateDepartments();
      showSection('calendar');
      renderCalendar();
      
      // Set today's date in expense form
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById('expense-date')) {
        document.getElementById('expense-date').value = today;
      }

      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to init data SDK');
        } else {
          // Check if we need to add sample doctors
          await addSampleDoctorsIfNeeded();
          // Try to sync any local changes now that the SDK is available
          try { await trySyncLocal(); } catch (e) { /* ignore */ }
        }
      } else {
        // No SDK available â€” load from localStorage
        const local = loadAllFromLocal();
        if (local.length > 0) {
          dataHandler.onDataChanged(local);
        } else {
          await addSampleDoctorsIfNeeded();
        }
      }

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            document.getElementById('hospital-title').textContent = config.hospital_name || defaultConfig.hospital_name;
            document.getElementById('system-subtitle').textContent = config.system_title || defaultConfig.system_title;
            
            const logoImg = document.getElementById('hospital-logo');
            const defaultLogo = document.getElementById('default-logo');
            if (config.logo_url) {
              logoImg.src = config.logo_url;
              logoImg.classList.remove('hidden');
              defaultLogo.style.display = 'none';
            } else {
              logoImg.classList.add('hidden');
              defaultLogo.style.display = 'flex';
            }
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              { get: () => config.primary_color || defaultConfig.primary_color, set: (v) => window.elementSdk.setConfig({ primary_color: v }) },
              { get: () => config.secondary_color || defaultConfig.secondary_color, set: (v) => window.elementSdk.setConfig({ secondary_color: v }) },
              { get: () => config.text_color || defaultConfig.text_color, set: (v) => window.elementSdk.setConfig({ text_color: v }) },
              { get: () => config.accent_color || defaultConfig.accent_color, set: (v) => window.elementSdk.setConfig({ accent_color: v }) },
              { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => window.elementSdk.setConfig({ surface_color: v }) }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ["hospital_name", config.hospital_name || defaultConfig.hospital_name],
            ["system_title", config.system_title || defaultConfig.system_title]
          ])
        });
      }
      // Render any custom data saved in localStorage
      if (typeof renderCustomDataList === 'function') renderCustomDataList();
      // Listen for network regained and periodically try to sync local changes
      window.addEventListener('online', () => { trySyncLocal(); });
      setInterval(() => { if (window.dataSdk) trySyncLocal(); }, 30000);
    }

    // Load Settings
    function loadSettings() {
      if (settings) {
        document.getElementById('hospital-title').textContent = settings.hospital_name || defaultConfig.hospital_name;
        document.getElementById('system-subtitle').textContent = settings.system_title || defaultConfig.system_title;
        
        document.getElementById('settings-logo').value = settings.logo_url || '';
        document.getElementById('settings-hospital').value = settings.hospital_name || '';
        document.getElementById('settings-system').value = settings.system_title || '';
        
        const logoImg = document.getElementById('hospital-logo');
        const defaultLogo = document.getElementById('default-logo');
        if (settings.logo_url) {
          logoImg.src = settings.logo_url;
          logoImg.classList.remove('hidden');
          defaultLogo.style.display = 'none';
        } else {
          logoImg.classList.add('hidden');
          defaultLogo.style.display = 'flex';
        }
      }
    }

    // Save Settings
    async function saveSettings() {
      const btn = document.getElementById('save-settings-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      const settingsData = {
        type: 'settings',
        logo_url: document.getElementById('settings-logo').value,
        hospital_name: document.getElementById('settings-hospital').value,
        system_title: document.getElementById('settings-system').value,
        updated_at: new Date().toISOString()
      };

      try {
        if (window.dataSdk && typeof window.dataSdk.create === 'function') {
          let result;
          if (settings) {
            result = await window.dataSdk.update({ ...settings, ...settingsData });
          } else {
            result = await window.dataSdk.create(settingsData);
          }

          btn.disabled = false;
          btn.textContent = 'Guardar ConfiguraciÃ³n';

          if (result && result.isOk) {
            showToast('ConfiguraciÃ³n guardada exitosamente', 'success');
            return;
          } else {
            console.error('dataSdk save settings error', result);
            showToast('Error al guardar configuraciÃ³n (SDK)', 'error');
            return;
          }
        }

        // Fallback: save to local
        settings = { ...settingsData };
        loadSettings();
        saveAllToLocal();
        btn.disabled = false;
        btn.textContent = 'Guardar ConfiguraciÃ³n';
        showToast('ConfiguraciÃ³n guardada (local)', 'success');
      } catch (err) {
        console.error('Error saving settings:', err);
        btn.disabled = false;
        btn.textContent = 'Guardar ConfiguraciÃ³n';
        showToast('Error al guardar configuraciÃ³n', 'error');
      }
    }

    // Calculate Age
    function calculateAge() {
      const birthdate = document.getElementById('apt-birthdate').value;
      if (!birthdate) {
        document.getElementById('apt-age').value = '';
        return;
      }
      
      const today = new Date();
      const birth = new Date(birthdate);
      
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      
      document.getElementById('apt-age').value = age + ' aÃ±os';
    }

    // Populate Departments
    function populateDepartments() {
      const select = document.getElementById('apt-department');
      select.innerHTML = '<option value="">Seleccione departamento...</option>';
      Object.keys(hondurasData).sort().forEach(dept => {
        select.innerHTML += `<option value="${dept}">${dept}</option>`;
      });
    }

    // Update Municipalities
    function updateMunicipalities() {
      const dept = document.getElementById('apt-department').value;
      const munSelect = document.getElementById('apt-municipality');
      munSelect.innerHTML = '<option value="">Seleccione municipio...</option>';
      
      if (dept && hondurasData[dept]) {
        hondurasData[dept].forEach(mun => {
          munSelect.innerHTML += `<option value="${mun}">${mun}</option>`;
        });
      }
    }

    // Show Section
    function showSection(section) {
      document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(`section-${section}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-emerald-600');
        if (btn.dataset.section === section) {
          btn.classList.add('bg-emerald-600');
        }
      });
    }

    // Ensure `showSection` is available and nav buttons work even if inline handlers fail
    try {
      window.showSection = showSection;
      document.addEventListener('click', (e) => {
        const btn = e.target.closest && e.target.closest('.nav-btn');
        if (!btn) return;
        const sec = btn.dataset && btn.dataset.section;
        if (sec && typeof window.showSection === 'function') window.showSection(sec);
      });
    } catch (err) { console.warn('Nav binding fallback failed', err); }

    // Calendar Functions
    function changeMonth(delta) {
      currentMonth.setMonth(currentMonth.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const monthLabel = document.getElementById('calendar-month');
      
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();
      
      const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
      monthLabel.textContent = `${months[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      grid.innerHTML = '';
      
      // Empty cells
      for (let i = 0; i < firstDay; i++) {
        grid.innerHTML += '<div class="p-2"></div>';
      }
      
      // Days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dateObj = new Date(year, month, day);
        const dayOfWeek = dateObj.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const dayAppointments = appointments.filter(a => a.date === dateStr && a.status !== 'cancelada');
        const isToday = new Date().toDateString() === dateObj.toDateString();
        
        const selectedDoctor = document.getElementById('doctor-filter')?.value;
        
        let availableSlots = 0;
        let totalSlots = 0;
        let isVacation = false;
        
        // Check vacations for selected doctor or all doctors
        if (selectedDoctor) {
          const doctor = doctors.find(d => d.__backendId === selectedDoctor);
          if (doctor) {
            totalSlots = doctor.doctor_max_appointments || 10;
            const doctorApts = dayAppointments.filter(a => a.doctor_id === selectedDoctor);
            availableSlots = totalSlots - doctorApts.length;
            
            // Check if this date is in vacation period
            const vacations = doctor.doctor_vacations ? JSON.parse(doctor.doctor_vacations) : [];
            isVacation = vacations.some(v => dateStr >= v.start && dateStr <= v.end);
          }
        } else {
          doctors.forEach(doc => {
            const docSlots = doc.doctor_max_appointments || 10;
            totalSlots += docSlots;
            const docApts = dayAppointments.filter(a => a.doctor_id === doc.__backendId);
            availableSlots += docSlots - docApts.length;
          });
        }
        
        const isFull = availableSlots <= 0;
        let bgColor = 'bg-slate-700 border-slate-600';
        let displayText = '';
        
        if (isWeekend) {
          bgColor = 'bg-slate-600/50 border-slate-500';
          displayText = '<div class="text-xs text-slate-400 mt-1">Cerrado</div>';
        } else if (isVacation) {
          bgColor = 'bg-amber-600/30 border-amber-500';
          displayText = '<div class="text-xs text-amber-300 mt-1">ğŸ–ï¸ Vacaciones</div>';
        } else if (isFull) {
          bgColor = 'bg-red-600/30 border-red-500';
          displayText = `<div class="text-xs text-red-300 mt-1">${availableSlots}/${totalSlots} cupos</div>`;
        } else if (dayAppointments.length > 0) {
          bgColor = 'bg-emerald-600/20 border-emerald-500';
          displayText = `<div class="text-xs text-emerald-300 mt-1">${availableSlots}/${totalSlots} cupos</div>`;
        } else {
          displayText = `<div class="text-xs text-emerald-300 mt-1">${availableSlots}/${totalSlots} cupos</div>`;
        }
        
        const todayRing = isToday ? 'ring-2 ring-amber-400' : '';
        const cursorClass = (isWeekend || isVacation) ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-slate-600';
        const clickAction = (isWeekend || isVacation) ? '' : `onclick="selectDateAndOpenModal('${dateStr}')"`;
        
        grid.innerHTML += `
          <div ${clickAction} class="p-2 ${bgColor} ${todayRing} border rounded-lg ${cursorClass} transition-all text-center min-h-[60px]">
            <span class="font-medium">${day}</span>
            ${displayText}
          </div>
        `;
      }
    }

    function selectDate(dateStr) {
      selectedDate = dateStr;
      const dayAppointments = appointments.filter(a => a.date === dateStr);
      
      const summary = document.getElementById('day-summary');
      if (dayAppointments.length === 0) {
        summary.innerHTML = '<p class="text-slate-400">No hay citas para este dÃ­a</p>';
      } else {
        summary.innerHTML = dayAppointments.map(apt => `
          <div class="bg-slate-700 rounded p-2">
            <p class="font-medium text-sm">${apt.patient_name}</p>
            <p class="text-xs text-slate-400">${apt.time} - ${apt.doctor_name}</p>
            <span class="text-xs px-2 py-0.5 rounded ${apt.status === 'programada' ? 'bg-blue-600' : apt.status === 'completada' ? 'bg-green-600' : 'bg-red-600'}">${apt.status}</span>
          </div>
        `).join('');
      }
    }

    // Select date and automatically open new appointment modal
    function selectDateAndOpenModal(dateStr) {
      selectDate(dateStr);
      openNewAppointmentModal();
      // Pre-fill the date in the modal
      setTimeout(() => {
        document.getElementById('apt-date').value = dateStr;
      }, 100);
    }

    // Modal Functions
    function openNewAppointmentModal() {
      document.getElementById('appointment-form').reset();
      document.getElementById('apt-department').value = 'Ocotepeque';
      updateMunicipalities();
      document.getElementById('apt-municipality').value = 'San Marcos';
      document.getElementById('appointment-modal').classList.remove('hidden');
      document.getElementById('appointment-modal').classList.add('flex');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
      document.getElementById(modalId).classList.remove('flex');
    }

    // Update Doctor Selects
    function updateDoctorSelect() {
      const select = document.getElementById('apt-doctor');
      select.innerHTML = '<option value="">Seleccione doctor...</option>';
      doctors.forEach(doc => {
        const docApts = appointments.filter(a => a.doctor_id === doc.__backendId && a.status !== 'cancelada');
        const available = (doc.doctor_max_appointments || 10) - docApts.length;
        select.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name} - ${doc.specialty} (${available} cupos hoy)</option>`;
      });
      
      // Also update quick doctor select
      const quickSelect = document.getElementById('quick-doctor-select');
      if (quickSelect) {
        quickSelect.innerHTML = '<option value="">Seleccione doctor...</option>';
        doctors.forEach(doc => {
          const docApts = appointments.filter(a => a.doctor_id === doc.__backendId && a.status !== 'cancelada');
          const available = (doc.doctor_max_appointments || 10) - docApts.length;
          quickSelect.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name} - ${doc.specialty} (${available} cupos)</option>`;
        });
      }
    }

    // Open appointment modal from calendar with pre-selected doctor
    function openNewAppointmentFromCalendar() {
      const selectedDoctor = document.getElementById('quick-doctor-select').value;
      
      if (!selectedDoctor) {
        showToast('Por favor seleccione un doctor primero', 'error');
        return;
      }
      
      document.getElementById('appointment-form').reset();
      document.getElementById('apt-department').value = 'Ocotepeque';
      updateMunicipalities();
      document.getElementById('apt-municipality').value = 'San Marcos';
      document.getElementById('apt-doctor').value = selectedDoctor;
      
      // If a date was selected in calendar, pre-fill it
      if (selectedDate) {
        document.getElementById('apt-date').value = selectedDate;
      }
      
      document.getElementById('appointment-modal').classList.remove('hidden');
      document.getElementById('appointment-modal').classList.add('flex');
    }

    function updateDoctorFilter() {
      const select = document.getElementById('doctor-filter');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Todos los MÃ©dicos</option>';
      doctors.forEach(doc => {
        select.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name}</option>`;
      });
      select.value = currentValue;
      select.onchange = () => {
        renderCalendar();
        updateAvailableSlots();
      };
    }

    function updateFilterDoctorSelect() {
      const select = document.getElementById('filter-doctor');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Todos los doctores</option>';
      doctors.forEach(doc => {
        select.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name}</option>`;
      });
      select.value = currentValue;
    }

    function updateAvailableSlots() {
      const selectedDoctor = document.getElementById('doctor-filter')?.value;
      const slotsEl = document.getElementById('available-slots');
      
      if (selectedDoctor) {
        const doctor = doctors.find(d => d.__backendId === selectedDoctor);
        if (doctor) {
          const today = new Date().toISOString().split('T')[0];
          const todayApts = appointments.filter(a => a.doctor_id === selectedDoctor && a.date === today && a.status !== 'cancelada');
          const available = (doctor.doctor_max_appointments || 10) - todayApts.length;
          slotsEl.textContent = `Hoy: ${available} cupos disponibles`;
        }
      } else {
        const totalSlots = doctors.reduce((sum, doc) => sum + (doc.doctor_max_appointments || 10), 0);
        const today = new Date().toISOString().split('T')[0];
        const usedSlots = appointments.filter(a => a.date === today && a.status !== 'cancelada').length;
        slotsEl.textContent = `Total hoy: ${totalSlots - usedSlots} cupos`;
      }
    }

    // Find Available Slot - Updated to show 15 slots and skip weekends/vacations
    function findAvailableSlot() {
      const days = parseInt(document.getElementById('apt-days').value) || 30;
      const doctorId = document.getElementById('apt-doctor').value;
      
      if (!doctorId) {
        document.getElementById('slot-info').textContent = 'âš ï¸ Seleccione un doctor primero';
        document.getElementById('available-slots-list').innerHTML = '';
        return;
      }
      
      const doctor = doctors.find(d => d.__backendId === doctorId);
      if (!doctor) return;
      
      const availableDays = doctor.doctor_available_days ? JSON.parse(doctor.doctor_available_days) : [1,2,3,4,5];
      const vacations = doctor.doctor_vacations ? JSON.parse(doctor.doctor_vacations) : [];
      const maxSlots = doctor.doctor_max_appointments || 10;
      
      const startDate = new Date();
      startDate.setDate(startDate.getDate() + days);
      
      let availableSlots = [];
      let searchDate = new Date(startDate);
      
      // Find 15 available slots
      for (let i = 0; i < 365 && availableSlots.length < 15; i++) {
        const dateStr = searchDate.toISOString().split('T')[0];
        const dayOfWeek = searchDate.getDay();
        
        // Skip weekends
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          searchDate.setDate(searchDate.getDate() + 1);
          continue;
        }
        
        // Check if available day
        const isAvailableDay = availableDays.includes(dayOfWeek);
        
        // Check vacations
        const isVacation = vacations.some(v => dateStr >= v.start && dateStr <= v.end);
        
        if (isAvailableDay && !isVacation) {
          const dayApts = appointments.filter(a => a.date === dateStr && a.doctor_id === doctorId && a.status !== 'cancelada');
          const available = maxSlots - dayApts.length;
          
          if (available > 0) {
            availableSlots.push({
              date: dateStr,
              available: available,
              total: maxSlots
            });
          }
        }
        
        searchDate.setDate(searchDate.getDate() + 1);
      }
      
      if (availableSlots.length > 0) {
        document.getElementById('apt-date').value = availableSlots[0].date;
        document.getElementById('slot-info').textContent = `âœ“ Se encontraron ${availableSlots.length} fechas disponibles`;
        
        // Show list of available slots
        const slotsList = document.getElementById('available-slots-list');
        slotsList.innerHTML = `
          <div class="border-t border-slate-600 pt-3 mt-2">
            <p class="text-xs font-medium text-slate-300 mb-2">PrÃ³ximos 15 cupos disponibles:</p>
            <div class="grid grid-cols-3 gap-2 max-h-48 overflow-y-auto scrollbar-thin">
              ${availableSlots.map(slot => `
                <button type="button" onclick="document.getElementById('apt-date').value='${slot.date}'" class="text-xs bg-slate-700 hover:bg-emerald-600 px-2 py-2 rounded border border-slate-600 hover:border-emerald-500 transition-all">
                  ${slot.date}<br>
                  <span class="text-emerald-400">${slot.available}/${slot.total}</span>
                </button>
              `).join('')}
            </div>
          </div>
        `;
      } else {
        document.getElementById('slot-info').textContent = 'âš ï¸ No se encontraron cupos disponibles';
        document.getElementById('available-slots-list').innerHTML = '';
      }
    }

    // Save Appointment
    async function saveAppointment() {
      if (appointments.length >= 999) {
        showToast('LÃ­mite de 999 registros alcanzado', 'error');
        return;
      }

      const btn = document.getElementById('save-apt-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      const doctorId = document.getElementById('apt-doctor').value;
      const doctor = doctors.find(d => d.__backendId === doctorId);
      const selectedDate = document.getElementById('apt-date').value;
      
      // Validate not weekend
      const dateObj = new Date(selectedDate + 'T00:00:00');
      const dayOfWeek = dateObj.getDay();
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        showToast('No se pueden agendar citas en fines de semana', 'error');
        btn.disabled = false;
        btn.textContent = 'Guardar Cita';
        return;
      }
      
      // Validate not in vacation
      if (doctor) {
        const vacations = doctor.doctor_vacations ? JSON.parse(doctor.doctor_vacations) : [];
        const isVacation = vacations.some(v => selectedDate >= v.start && selectedDate <= v.end);
        if (isVacation) {
          showToast('El doctor estÃ¡ de vacaciones en esa fecha', 'error');
          btn.disabled = false;
          btn.textContent = 'Guardar Cita';
          return;
        }
      }
      
      // Calculate age
      const birthdate = document.getElementById('apt-birthdate').value;
      let age = 0;
      if (birthdate) {
        const today = new Date();
        const birth = new Date(birthdate);
        age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
          age--;
        }
      }
      
      const newAppointment = {
        type: 'appointment',
        patient_name: document.getElementById('apt-patient-name').value,
        patient_id: document.getElementById('apt-patient-id').value,
        patient_phone: document.getElementById('apt-phone').value || '',
        patient_birthdate: birthdate,
        patient_age: age,
        department: document.getElementById('apt-department').value,
        municipality: document.getElementById('apt-municipality').value,
        neighborhood: document.getElementById('apt-neighborhood').value || '',
        doctor_id: doctorId,
        doctor_name: doctor ? doctor.doctor_name : '',
        specialty: doctor ? doctor.specialty : '',
        date: selectedDate,
        time: document.getElementById('apt-time').value,
        origin: document.getElementById('apt-origin').value,
        status: 'programada',
        surgical_delay: parseInt(document.getElementById('apt-days').value) || 0,
        created_at: new Date().toISOString(),
        triage_blood_pressure: '',
        triage_heart_rate: '',
        triage_temperature: '',
        triage_weight: '',
        triage_height: '',
        triage_oxygen: '',
        triage_notes: '',
        triage_date: '',
        diagnosis: '',
        diagnosis_date: '',
        reference_hospital: '',
        reference_reason: '',
        reference_date: '',
        payment_amount: 0,
        payment_date: '',
        payment_status: 'pendiente',
        reassigned: false,
        original_date: '',
        original_time: ''
      };

      try {
        if (window.dataSdk && typeof window.dataSdk.create === 'function') {
          const result = await window.dataSdk.create(newAppointment);
          btn.disabled = false;
          btn.textContent = 'Guardar Cita';

          if (result && result.isOk) {
            lastSavedAppointment = newAppointment;
            closeModal('appointment-modal');
            setTimeout(() => { printTicket(); }, 500);
            document.getElementById('print-modal').classList.remove('hidden');
            document.getElementById('print-modal').classList.add('flex');
            return;
          } else {
            console.error('dataSdk create appointment error', result);
            showToast('Error al guardar la cita (SDK)', 'error');
            return;
          }
        }

        // Fallback: save locally
        const localId = 'local-apt-' + Date.now();
        const aptToSave = { ...newAppointment, __backendId: localId };
        appointments.push(aptToSave);
        saveAllToLocal();

        btn.disabled = false;
        btn.textContent = 'Guardar Cita';
        lastSavedAppointment = aptToSave;
        closeModal('appointment-modal');
        setTimeout(() => { printTicket(); }, 500);
        document.getElementById('print-modal').classList.remove('hidden');
        document.getElementById('print-modal').classList.add('flex');
        renderAppointmentsList();
        renderCalendar();
      } catch (err) {
        console.error('Error saving appointment:', err);
        btn.disabled = false;
        btn.textContent = 'Guardar Cita';
        showToast('Error al guardar la cita', 'error');
      }
    }

    // Convert date to Spanish text format
    function dateToSpanishText(dateStr) {
      const months = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                      'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
      const days = ['domingo', 'lunes', 'martes', 'miÃ©rcoles', 'jueves', 'viernes', 'sÃ¡bado'];
      
      const date = new Date(dateStr + 'T00:00:00');
      const dayName = days[date.getDay()];
      const day = date.getDate();
      const month = months[date.getMonth()];
      const year = date.getFullYear();
      
      return `${dayName} ${day} de ${month} del ${year}`;
    }

    // Print Appointment Ticket
    function printAppointmentTicket(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) {
        showToast('Error: No se encontrÃ³ la cita', 'error');
        return;
      }
      
      const patientHistory = appointments
        .filter(a => a.patient_id === apt.patient_id && a.__backendId !== aptId)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);

      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const dateInText = dateToSpanishText(apt.date);

      const ticketHtml = `
        <div style="width: 58mm; font-family: monospace; font-size: 10px; padding: 5mm;">
          <div style="text-align: center; margin-bottom: 3mm;">
            <strong style="font-size: 12px;">${hospitalName.toUpperCase()}</strong><br>
            <span style="font-size: 9px;">Sistema de Citas MÃ©dicas</span><br>
            <span style="font-size: 8px;">================================</span>
          </div>
          
          <div style="margin-bottom: 2mm;">
            <strong>DATOS DEL PACIENTE</strong><br>
            Nombre: ${apt.patient_name}<br>
            ID: ${apt.patient_id}<br>
            Edad: ${apt.patient_age} aÃ±os<br>
            Depto: ${apt.department}<br>
            Mun: ${apt.municipality}<br>
            ${apt.neighborhood ? `Barrio/Aldea: ${apt.neighborhood}<br>` : ''}
            ${apt.patient_phone ? `Tel: ${apt.patient_phone}<br>` : ''}
          </div>
          
          <div style="margin-bottom: 2mm;">
            <span style="font-size: 8px;">--------------------------------</span><br>
            <strong>DATOS DE LA CITA</strong><br>
            <strong style="font-size: 11px; text-transform: capitalize;">Su cita es el:</strong><br>
            <strong style="font-size: 10px; text-transform: capitalize;">${dateInText}</strong><br>
            Hora: <strong style="font-size: 12px;">${apt.time}</strong><br>
            <span style="font-size: 8px;">--------------------------------</span><br>
            Doctor: ${apt.doctor_name}<br>
            Especialidad: ${apt.specialty}<br>
            Origen: ${originLabels[apt.origin] || apt.origin}<br>
          </div>
          
          ${patientHistory.length > 0 ? `
          <div style="margin-bottom: 2mm;">
            <span style="font-size: 8px;">--------------------------------</span><br>
            <strong>HISTORIAL (Ãšltimas 3)</strong><br>
            ${patientHistory.map(h => `${h.date} - ${h.doctor_name}`).join('<br>')}
          </div>
          ` : ''}
          
          <div style="text-align: center; margin-top: 3mm;">
            <span style="font-size: 8px;">================================</span><br>
            <span style="font-size: 7px;">Generado: ${new Date().toLocaleString()}</span><br>
            <span style="font-size: 8px;">Â¡Gracias por su visita!</span><br>
            <span style="font-size: 7px;">Presentarse 15 min antes</span>
          </div>
        </div>
      `;

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('Por favor permita las ventanas emergentes para imprimir', 'error');
        return;
      }
      
      printWindow.document.write(`
        <html>
          <head>
            <title>Ticket de Cita - ${hospitalName}</title>
            <meta charset="UTF-8">
            <style>
              @media print {
                @page { 
                  margin: 0; 
                  size: 58mm auto; 
                }
                body { 
                  margin: 0; 
                  padding: 0; 
                }
              }
              body {
                margin: 0;
                padding: 0;
                background: white;
              }
            <!-- view-transition handled in style.css -->
            ${ticketHtml}
            <script>
              window.onload = function() { 
                setTimeout(function() {
                  window.print();
                }, 500);
              };
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
      
      showToast('âœ… Ticket abierto para impresiÃ³n', 'success');
    }

    // Create New Appointment for Existing Patient
    function createNewAppointmentForPatient(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      
      // Open the appointment modal
      document.getElementById('appointment-form').reset();
      
      // Pre-fill patient information
      document.getElementById('apt-patient-name').value = apt.patient_name;
      document.getElementById('apt-patient-id').value = apt.patient_id;
      document.getElementById('apt-birthdate').value = apt.patient_birthdate;
      document.getElementById('apt-age').value = apt.patient_age + ' aÃ±os';
      document.getElementById('apt-department').value = apt.department;
      updateMunicipalities();
      setTimeout(() => {
        document.getElementById('apt-municipality').value = apt.municipality;
        document.getElementById('apt-neighborhood').value = apt.neighborhood;
      }, 100);
      
      // Set origin to "Por medio de la Sala" by default for follow-up appointments
      document.getElementById('apt-origin').value = 'sala';
      
      // Open modal
      document.getElementById('appointment-modal').classList.remove('hidden');
      document.getElementById('appointment-modal').classList.add('flex');
      
      showToast('Creando nueva cita para ' + apt.patient_name, 'info');
    }

    // Print Ticket
    function printTicket() {
      if (!lastSavedAppointment) return;
      
      const apt = lastSavedAppointment;
      const patientHistory = appointments
        .filter(a => a.patient_id === apt.patient_id)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);

      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const dateInText = dateToSpanishText(apt.date);

      const ticketHtml = `
        <div style="width: 58mm; font-family: monospace; font-size: 10px; padding: 5mm;">
          <div style="text-align: center; margin-bottom: 3mm;">
            <strong style="font-size: 12px;">${hospitalName.toUpperCase()}</strong><br>
            <span style="font-size: 9px;">Sistema de Citas MÃ©dicas</span><br>
            <span style="font-size: 8px;">================================</span>
          </div>
          
          <div style="margin-bottom: 2mm;">
            <strong>DATOS DEL PACIENTE</strong><br>
            Nombre: ${apt.patient_name}<br>
            ID: ${apt.patient_id}<br>
            Edad: ${apt.patient_age} aÃ±os<br>
            Depto: ${apt.department}<br>
            Mun: ${apt.municipality}<br>
            ${apt.neighborhood ? `Barrio/Aldea: ${apt.neighborhood}<br>` : ''}
          </div>
          
          <div style="margin-bottom: 2mm;">
            <span style="font-size: 8px;">--------------------------------</span><br>
            <strong>DATOS DE LA CITA</strong><br>
            <strong style="font-size: 9px; text-transform: capitalize;">Su cita es el:</strong><br>
            <strong style="font-size: 9px; text-transform: capitalize;">${dateInText}</strong><br>
            Hora: <strong>${apt.time}</strong><br>
            <span style="font-size: 8px;">--------------------------------</span><br>
            Doctor: ${apt.doctor_name}<br>
            Especialidad: ${apt.specialty}<br>
            Origen: ${originLabels[apt.origin] || apt.origin}<br>
          </div>
          
          ${patientHistory.length > 0 ? `
          <div style="margin-bottom: 2mm;">
            <span style="font-size: 8px;">--------------------------------</span><br>
            <strong>HISTORIAL (Ãšltimas 3)</strong><br>
            ${patientHistory.map(h => `${h.date} - ${h.doctor_name}`).join('<br>')}
          </div>
          ` : ''}
          
          <div style="text-align: center; margin-top: 3mm;">
            <span style="font-size: 8px;">================================</span><br>
            <span style="font-size: 7px;">Generado: ${new Date().toLocaleString()}</span><br>
            <span style="font-size: 8px;">Â¡Gracias por su visita!</span><br>
            <span style="font-size: 7px;">Presentarse 15 min antes</span>
          </div>
        </div>
      `;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Ticket de Cita - ${hospitalName}</title>
            <style>
              @media print {
                @page { margin: 0; size: 58mm auto; }
                body { margin: 0; padding: 0; }
              }
            </style>
          </head>
          <body style="margin: 0; padding: 0;">
            ${ticketHtml}
            <script>window.onload = function() { window.print(); window.close(); }<\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    // Download PDF
    function downloadPDF() {
      if (!lastSavedAppointment) return;
      
      const apt = lastSavedAppointment;
      const patientHistory = appointments
        .filter(a => a.patient_id === apt.patient_id)
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 3);

      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const dateInText = dateToSpanishText(apt.date);

      const content = `
${'='.repeat(70)}
${hospitalName.toUpperCase()}
COMPROBANTE DE CITA MÃ‰DICA
${'='.repeat(70)}

DATOS DEL PACIENTE
${'-'.repeat(70)}
Nombre:                 ${apt.patient_name}
NÃºmero de Identidad:    ${apt.patient_id}
Edad:                   ${apt.patient_age} aÃ±os
Departamento:           ${apt.department}
Municipio:              ${apt.municipality}
${apt.neighborhood ? `Barrio/Aldea:           ${apt.neighborhood}` : ''}

${'='.repeat(70)}
           SU CITA ESTÃ PROGRAMADA PARA:
${'='.repeat(70)}

     >>> ${dateInText.toUpperCase()} <<<
                 HORA: ${apt.time}

${'='.repeat(70)}

INFORMACIÃ“N DEL MÃ‰DICO
${'-'.repeat(70)}
Doctor:                 ${apt.doctor_name}
Especialidad:           ${apt.specialty}

DATOS ADICIONALES
${'-'.repeat(70)}
Origen de la Cita:      ${originLabels[apt.origin] || apt.origin}
Estado:                 ${apt.status.toUpperCase()}

${patientHistory.length > 0 ? `
HISTORIAL DE CITAS ANTERIORES (Ãšltimas 3)
${'-'.repeat(70)}
${patientHistory.map(h => `  - ${h.date} | ${h.doctor_name} | ${h.specialty}`).join('\n')}
` : ''}

${'='.repeat(70)}
INSTRUCCIONES IMPORTANTES
${'='.repeat(70)}
  * Presentarse 15 minutos antes de su cita
  * Traer documento de identidad original
  * Traer este comprobante el dÃ­a de su cita
  * En caso de no poder asistir, avisar con anticipaciÃ³n

${'='.repeat(70)}
Generado: ${new Date().toLocaleString()}
${hospitalName}
${'='.repeat(70)}
      `;

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cita_${apt.patient_id}_${apt.date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Comprobante descargado exitosamente', 'success');
    }

    // Download Complete PDF
    function downloadCompletePDF() {
      if (!lastSavedAppointment) return;
      
      const apt = lastSavedAppointment;
      const doctor = doctors.find(d => d.__backendId === apt.doctor_id);
      const patientHistory = appointments
        .filter(a => a.patient_id === apt.patient_id)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;

      let content = `
${'='.repeat(80)}
${hospitalName.toUpperCase()}
SISTEMA DE CITAS MÃ‰DICAS - REPORTE COMPLETO
${'='.repeat(80)}

INFORMACIÃ“N DEL PACIENTE
${'='.repeat(80)}
Nombre Completo:        ${apt.patient_name}
NÃºmero de Identidad:    ${apt.patient_id}
Fecha de Nacimiento:    ${apt.patient_birthdate || 'N/A'}
Edad:                   ${apt.patient_age} aÃ±os
Departamento:           ${apt.department}
Municipio:              ${apt.municipality}
Barrio/Aldea:           ${apt.neighborhood || 'N/A'}

DATOS DE LA CITA ACTUAL
${'='.repeat(80)}
ID de Cita:             ${apt.__backendId || 'N/A'}
Fecha de Cita:          ${apt.date}
Hora:                   ${apt.time}
Doctor Asignado:        ${apt.doctor_name}
Especialidad:           ${apt.specialty}
Origen de la Cita:      ${originLabels[apt.origin] || apt.origin}
Estado:                 ${apt.status.toUpperCase()}
DÃ­as de Espera:         ${apt.surgical_delay || 0} dÃ­as
Fecha de CreaciÃ³n:      ${new Date(apt.created_at).toLocaleString()}

`;

      if (doctor) {
        const services = doctor.doctor_services ? JSON.parse(doctor.doctor_services) : [];
        content += `INFORMACIÃ“N DEL DOCTOR
${'='.repeat(80)}
Nombre:                 ${doctor.doctor_name}
Especialidad:           ${doctor.specialty}
Correo ElectrÃ³nico:     ${doctor.doctor_email}
MÃ¡x. Citas por DÃ­a:     ${doctor.doctor_max_appointments || 10}

`;
        if (services.length > 0) {
          content += `SERVICIOS MÃ‰DICOS DISPONIBLES
${'-'.repeat(80)}
${services.map(s => `- ${s.name}: L.${s.price.toFixed(2)}`).join('\n')}

`;
        }
      }

      if (patientHistory.length > 0) {
        content += `HISTORIAL COMPLETO DEL PACIENTE
${'='.repeat(80)}
Total de Citas Registradas: ${patientHistory.length}

${patientHistory.map((h, i) => `
CITA #${i + 1}
${'-'.repeat(80)}
Fecha:          ${h.date} - ${h.time}
Doctor:         ${h.doctor_name}
Especialidad:   ${h.specialty}
Estado:         ${h.status.toUpperCase()}
Origen:         ${originLabels[h.origin] || h.origin}
${h.diagnosis ? `DiagnÃ³stico:    ${h.diagnosis}` : ''}
${h.payment_amount > 0 ? `Pago:           L.${h.payment_amount.toFixed(2)}` : ''}
`).join('\n')}
`;
      }

      content += `
${'='.repeat(80)}
NOTAS IMPORTANTES
${'='.repeat(80)}
- Este documento contiene informaciÃ³n mÃ©dica confidencial
- Presentar en la fecha y hora indicada
- Llegar 15 minutos antes de la cita
- Traer documento de identidad original
- En caso de no poder asistir, avisar con anticipaciÃ³n

${'='.repeat(80)}
Documento generado: ${new Date().toLocaleString()}
${'='.repeat(80)}
      `;

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cita_completa_${apt.patient_id}_${apt.date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('PDF completo descargado exitosamente', 'success');
    }

    // Export to PDF
    function exportToPDF() {
      const filtered = getFilteredAppointments();
      
      if (filtered.length === 0) {
        showToast('No hay citas para exportar', 'error');
        return;
      }
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      
      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const statusLabels = {
        'programada': 'Programada',
        'triaje': 'En Triaje',
        'diagnostico': 'En DiagnÃ³stico',
        'completada': 'Completada',
        'cancelada': 'Cancelada'
      };

      // Create HTML content for PDF
      let htmlContent = `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reporte de Citas - ${hospitalName}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      font-size: 12px;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #059669;
      padding-bottom: 15px;
    }
    .header h1 {
      margin: 0;
      color: #059669;
      font-size: 24px;
    }
    .header h2 {
      margin: 5px 0;
      color: #334155;
      font-size: 18px;
    }
    .filters {
      background: #f1f5f9;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .filters h3 {
      margin: 0 0 10px 0;
      color: #334155;
      font-size: 14px;
    }
    .filters p {
      margin: 5px 0;
      color: #475569;
    }
    .appointment {
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      page-break-inside: avoid;
    }
    .appointment-header {
      background: #059669;
      color: white;
      padding: 8px 12px;
      border-radius: 5px;
      margin: -15px -15px 15px -15px;
      font-weight: bold;
      font-size: 14px;
    }
    .appointment-row {
      display: flex;
      margin-bottom: 8px;
    }
    .appointment-label {
      font-weight: bold;
      width: 150px;
      color: #334155;
    }
    .appointment-value {
      flex: 1;
      color: #475569;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      color: white;
    }
    .status-programada { background: #3b82f6; }
    .status-triaje { background: #8b5cf6; }
    .status-diagnostico { background: #f59e0b; }
    .status-completada { background: #10b981; }
    .status-cancelada { background: #ef4444; }
    .footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 2px solid #cbd5e1;
      text-align: center;
      color: #64748b;
      font-size: 11px;
    }
    @media print {
      body { margin: 10px; }
      .appointment { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>${hospitalName}</h1>
    <h2>Reporte de Citas MÃ©dicas</h2>
  </div>
  
  <div class="filters">
    <h3>ğŸ“Š RESUMEN Y FILTROS APLICADOS</h3>
    ${document.getElementById('search-appointment').value ? `<p><strong>ğŸ” BÃºsqueda:</strong> ${document.getElementById('search-appointment').value}</p>` : ''}
    ${document.getElementById('filter-status').value ? `<p><strong>ğŸ“Œ Estado:</strong> ${statusLabels[document.getElementById('filter-status').value]}</p>` : ''}
    ${document.getElementById('filter-doctor').value ? `<p><strong>ğŸ‘¨â€âš•ï¸ Doctor:</strong> ${doctors.find(d => d.__backendId === document.getElementById('filter-doctor').value)?.doctor_name || ''}</p>` : ''}
    ${document.getElementById('filter-date-from').value ? `<p><strong>ğŸ“… Desde:</strong> ${document.getElementById('filter-date-from').value}</p>` : ''}
    ${document.getElementById('filter-date-to').value ? `<p><strong>ğŸ“… Hasta:</strong> ${document.getElementById('filter-date-to').value}</p>` : ''}
    <p><strong>ğŸ“‹ Total de Citas:</strong> ${filtered.length}</p>
  </div>
`;

      filtered.forEach((apt, i) => {
        htmlContent += `
  <div class="appointment">
    <div class="appointment-header">CITA #${i + 1}</div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ‘¤ Paciente:</div>
      <div class="appointment-value">${apt.patient_name}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ†” Identidad:</div>
      <div class="appointment-value">${apt.patient_id}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ‚ Edad:</div>
      <div class="appointment-value">${apt.patient_age} aÃ±os</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ“ TelÃ©fono:</div>
      <div class="appointment-value">${apt.patient_phone || 'No registrado'}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ“ UbicaciÃ³n:</div>
      <div class="appointment-value">${apt.department}, ${apt.municipality}${apt.neighborhood ? ', ' + apt.neighborhood : ''}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ“… Fecha y Hora:</div>
      <div class="appointment-value">${apt.date} - ${apt.time}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ‘¨â€âš•ï¸ Doctor:</div>
      <div class="appointment-value">${apt.doctor_name}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ¥ Especialidad:</div>
      <div class="appointment-value">${apt.specialty}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">ğŸ“‹ Origen:</div>
      <div class="appointment-value">${originLabels[apt.origin] || apt.origin}</div>
    </div>
    <div class="appointment-row">
      <div class="appointment-label">âš¡ Estado:</div>
      <div class="appointment-value">
        <span class="status-badge status-${apt.status}">${statusLabels[apt.status] || apt.status}</span>
      </div>
    </div>
    ${apt.diagnosis ? `
    <div class="appointment-row">
      <div class="appointment-label">ğŸ©º DiagnÃ³stico:</div>
      <div class="appointment-value">${apt.diagnosis}</div>
    </div>
    ` : ''}
    ${apt.payment_amount > 0 ? `
    <div class="appointment-row">
      <div class="appointment-label">ğŸ’° Pago:</div>
      <div class="appointment-value">L.${apt.payment_amount.toFixed(2)} - ${apt.payment_status}</div>
    </div>
    ` : ''}
    ${apt.reassigned ? `
    <div class="appointment-row">
      <div class="appointment-label">ğŸ”„ Reasignada:</div>
      <div class="appointment-value">Desde ${apt.original_date} ${apt.original_time}</div>
    </div>
    ` : ''}
    ${apt.reference_hospital ? `
    <div class="appointment-row">
      <div class="appointment-label">ğŸ¥ Referencia:</div>
      <div class="appointment-value">${apt.reference_hospital}</div>
    </div>
    ` : ''}
  </div>
`;
      });

      htmlContent += `
  <div class="footer">
    <p><strong>Documento generado:</strong> ${new Date().toLocaleString()}</p>
    <p>${hospitalName} - Sistema de Citas MÃ©dicas</p>
  </div>
</body>
</html>
`;

      // Open in new window for printing/saving as PDF
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('Por favor permita las ventanas emergentes para exportar', 'error');
        return;
      }
      
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      // Wait for content to load, then trigger print dialog
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.focus();
          printWindow.print();
        }, 250);
      };
      
      showToast('Abriendo ventana de impresiÃ³n - Guarde como PDF', 'success');
    }

    // Export to Excel
    function exportToExcel() {
      const filtered = getFilteredAppointments();
      
      if (filtered.length === 0) {
        showToast('No hay citas para exportar', 'error');
        return;
      }
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      
      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const statusLabels = {
        'programada': 'Programada',
        'triaje': 'En Triaje',
        'diagnostico': 'En DiagnÃ³stico',
        'completada': 'Completada',
        'cancelada': 'Cancelada'
      };
      
      // Create CSV with BOM for proper UTF-8 encoding in Excel
      let csv = '\uFEFF'; // BOM for UTF-8
      
      // Header with hospital name
      csv += `${hospitalName}\n`;
      csv += `Reporte de Citas MÃ©dicas\n`;
      csv += `Generado: ${new Date().toLocaleString()}\n`;
      csv += `Total de citas: ${filtered.length}\n\n`;
      
      // Column headers
      csv += `No.,Paciente,Identidad,Edad,TelÃ©fono,Departamento,Municipio,Barrio/Aldea,Fecha,Hora,Doctor,Especialidad,Origen,Estado,DiagnÃ³stico,Pago,Estado Pago,Reasignada,Fecha Original,Hora Original,Referencia\n`;
      
      // Data rows
      filtered.forEach((apt, i) => {
        const row = [
          i + 1,
          apt.patient_name,
          apt.patient_id,
          apt.patient_age,
          apt.patient_phone || '',
          apt.department,
          apt.municipality,
          apt.neighborhood || '',
          apt.date,
          apt.time,
          apt.doctor_name,
          apt.specialty,
          originLabels[apt.origin] || apt.origin,
          statusLabels[apt.status] || apt.status,
          apt.diagnosis || '',
          apt.payment_amount || 0,
          apt.payment_status || '',
          apt.reassigned ? 'SÃ­' : 'No',
          apt.original_date || '',
          apt.original_time || '',
          apt.reference_hospital || ''
        ];
        
        // Escape and quote fields that might contain commas or quotes
        const escapedRow = row.map(field => {
          const stringField = String(field);
          if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return `"${stringField.replace(/"/g, '""')}"`;
          }
          return stringField;
        });
        
        csv += escapedRow.join(',') + '\n';
      });

      // Create blob and download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_citas_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Archivo Excel descargado exitosamente', 'success');
    }

    // Get Filtered Appointments
    function getFilteredAppointments() {
      const search = document.getElementById('search-appointment')?.value?.toLowerCase() || '';
      const statusFilter = document.getElementById('filter-status')?.value || '';
      const doctorFilter = document.getElementById('filter-doctor')?.value || '';
      const dateFrom = document.getElementById('filter-date-from')?.value || '';
      const dateTo = document.getElementById('filter-date-to')?.value || '';
      const expedienteFilter = document.getElementById('filter-expediente')?.value || '';
      
      return appointments.filter(apt => {
        const matchesSearch = apt.patient_name.toLowerCase().includes(search) || 
                             apt.patient_id.includes(search) ||
                             apt.doctor_name.toLowerCase().includes(search);
        const matchesStatus = !statusFilter || apt.status === statusFilter;
        const matchesDoctor = !doctorFilter || apt.doctor_id === doctorFilter;
        const matchesDateFrom = !dateFrom || apt.date >= dateFrom;
        const matchesDateTo = !dateTo || apt.date <= dateTo;
        const expedienteState = apt.expediente || 'sin';
        const matchesExpediente = !expedienteFilter || (expedienteFilter === 'sin' ? expedienteState === 'sin' : expedienteState === expedienteFilter);

        return matchesSearch && matchesStatus && matchesDoctor && matchesDateFrom && matchesDateTo && matchesExpediente;
      }).sort((a, b) => new Date(b.date) - new Date(a.date));
    }

    // Services Management
    function addService() {
      const name = document.getElementById('service-name').value.trim();
      const price = parseFloat(document.getElementById('service-price').value) || 0;
      
      if (name && price >= 0) {
        tempServices.push({ name, price });
        renderServicesList();
        document.getElementById('service-name').value = '';
        document.getElementById('service-price').value = '';
      } else {
        showToast('Datos de servicio invÃ¡lidos', 'error');
      }
    }

    function removeService(index) {
      tempServices.splice(index, 1);
      renderServicesList();
    }

    function renderServicesList() {
      const list = document.getElementById('services-list');
      list.innerHTML = tempServices.map((s, i) => `
        <div class="flex items-center justify-between bg-slate-700 rounded px-3 py-2 text-sm">
          <span>${s.name} - L.${s.price.toFixed(2)}</span>
          <button type="button" onclick="removeService(${i})" class="text-red-400 hover:text-red-300">âœ•</button>
        </div>
      `).join('');
    }

    // Vacations Management
    function addVacation() {
      const start = document.getElementById('vacation-start').value;
      const end = document.getElementById('vacation-end').value;
      
      if (start && end && start <= end) {
        tempVacations.push({ start, end });
        renderVacationList();
        document.getElementById('vacation-start').value = '';
        document.getElementById('vacation-end').value = '';
      } else {
        showToast('Fechas de vacaciones invÃ¡lidas', 'error');
      }
    }

    function removeVacation(index) {
      tempVacations.splice(index, 1);
      renderVacationList();
    }

    function renderVacationList() {
      const list = document.getElementById('vacation-list');
      list.innerHTML = tempVacations.map((v, i) => `
        <div class="flex items-center justify-between bg-slate-700 rounded px-3 py-2 text-sm">
          <span>${v.start} - ${v.end}</span>
          <button type="button" onclick="removeVacation(${i})" class="text-red-400 hover:text-red-300">âœ•</button>
        </div>
      `).join('');
    }

    // Save Doctor
    async function saveDoctor() {
      if (doctors.length >= 999 && !editingDoctorId) {
        showToast('LÃ­mite de 999 registros alcanzado', 'error');
        return;
      }

      const btn = document.getElementById('save-doctor-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      const availableDays = [...document.querySelectorAll('.day-checkbox:checked')].map(cb => parseInt(cb.value));

      const doctorData = {
        type: 'doctor',
        doctor_name: document.getElementById('doctor-name').value,
        specialty: document.getElementById('doctor-specialty').value,
        doctor_email: document.getElementById('doctor-email').value,
        doctor_max_appointments: parseInt(document.getElementById('doctor-max').value) || 10,
        doctor_available_days: JSON.stringify(availableDays),
        doctor_vacations: JSON.stringify(tempVacations),
        doctor_services: JSON.stringify(tempServices),
        created_at: new Date().toISOString()
      };

      try {
        // If dataSdk is available use it, otherwise fallback to local in-memory save
        if (window.dataSdk && (typeof window.dataSdk.create === 'function')) {
          let result;
          if (editingDoctorId) {
            const existingDoctor = doctors.find(d => d.__backendId === editingDoctorId);
            result = await window.dataSdk.update({ ...existingDoctor, ...doctorData });
          } else {
            result = await window.dataSdk.create(doctorData);
          }

          btn.disabled = false;
          btn.textContent = 'Guardar Doctor';

          if (result && result.isOk) {
            // Clear form and temps
            document.getElementById('doctor-form').reset();
            tempVacations = [];
            tempServices = [];
            renderVacationList();
            renderServicesList();

            const message = editingDoctorId ? 'Doctor actualizado' : 'Doctor agregado exitosamente';
            editingDoctorId = null;
            showToast(message, 'success');
            // SDK should trigger data refresh; if not, try to refresh UI
            if (!window.dataSdk.refresh) {
              renderDoctorsList();
              updateDoctorSelect();
            }
            return;
          } else {
            console.error('dataSdk returned error', result);
            showToast('Error al guardar doctor (SDK)', 'error');
            return;
          }
        }

        // Fallback: persist in-memory and update UI so user can continue working offline
          if (editingDoctorId) {
          const idx = doctors.findIndex(d => d.__backendId === editingDoctorId);
          if (idx !== -1) {
            doctors[idx] = { ...doctors[idx], ...doctorData };
          }
          const message = 'Doctor actualizado (local)';
          document.getElementById('doctor-form').reset();
          tempVacations = [];
          tempServices = [];
          renderVacationList();
          renderServicesList();
          editingDoctorId = null;
          renderDoctorsList();
          updateDoctorSelect();
          saveAllToLocal();
          showToast(message, 'success');
        } else {
          const localId = 'local-' + Date.now();
          const newDoc = { ...doctorData, __backendId: localId, type: 'doctor' };
          doctors.push(newDoc);
          document.getElementById('doctor-form').reset();
          tempVacations = [];
          tempServices = [];
          renderVacationList();
          renderServicesList();
          renderDoctorsList();
          updateDoctorSelect();
          saveAllToLocal();
          showToast('Doctor agregado (local)', 'success');
        }
      } catch (err) {
        console.error('Error saving doctor:', err);
        showToast('Error al guardar doctor', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Guardar Doctor';
      }
    }

    // Render Doctors List
    function renderDoctorsList() {
      const list = document.getElementById('doctors-list');
      
      if (doctors.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay doctores registrados</p>';
        return;
      }

      list.innerHTML = doctors.map(doc => {
        const vacations = doc.doctor_vacations ? JSON.parse(doc.doctor_vacations) : [];
        const services = doc.doctor_services ? JSON.parse(doc.doctor_services) : [];
        const days = doc.doctor_available_days ? JSON.parse(doc.doctor_available_days) : [];
        const dayNames = ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'];
        
        return `
          <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
            <div class="flex items-start justify-between">
              <div>
                <h3 class="font-semibold">${doc.doctor_name}</h3>
                <p class="text-sm text-emerald-400">${doc.specialty}</p>
                <p class="text-xs text-slate-400">${doc.doctor_email}</p>
                <p class="text-xs text-slate-400 mt-1">DÃ­as: ${days.map(d => dayNames[d]).join(', ')}</p>
                <p class="text-xs text-slate-400">MÃ¡x citas/dÃ­a: ${doc.doctor_max_appointments || 10}</p>
                ${services.length > 0 ? `<p class="text-xs text-blue-400 mt-1">Servicios: ${services.length}</p>` : ''}
                ${vacations.length > 0 ? `<p class="text-xs text-amber-400">Vacaciones: ${vacations.length} perÃ­odo(s)</p>` : ''}
              </div>
              <div class="flex gap-2">
                <button onclick="openEmailModal('${doc.__backendId}')" class="p-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm" title="Enviar calendario">ğŸ“§</button>
                <button onclick="editDoctor('${doc.__backendId}')" class="p-2 bg-amber-600 hover:bg-amber-700 rounded-lg text-sm" title="Editar">âœï¸</button>
                <button onclick="deleteDoctor('${doc.__backendId}', this)" class="p-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm" title="Eliminar">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Edit Doctor
    function editDoctor(id) {
      const doctor = doctors.find(d => d.__backendId === id);
      if (!doctor) return;

      editingDoctorId = id;
      document.getElementById('doctor-name').value = doctor.doctor_name;
      document.getElementById('doctor-specialty').value = doctor.specialty;
      document.getElementById('doctor-email').value = doctor.doctor_email;
      document.getElementById('doctor-max').value = doctor.doctor_max_appointments || 10;

      const availableDays = doctor.doctor_available_days ? JSON.parse(doctor.doctor_available_days) : [];
      document.querySelectorAll('.day-checkbox').forEach(cb => {
        cb.checked = availableDays.includes(parseInt(cb.value));
      });

      tempVacations = doctor.doctor_vacations ? JSON.parse(doctor.doctor_vacations) : [];
      renderVacationList();
      
      tempServices = doctor.doctor_services ? JSON.parse(doctor.doctor_services) : [];
      renderServicesList();

      document.getElementById('save-doctor-btn').textContent = 'Actualizar Doctor';
      showSection('doctors');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Delete Doctor
    async function deleteDoctor(id, btnElem) {
      const doctor = doctors.find(d => d.__backendId === id);
      if (!doctor) return;

      const btn = btnElem || (typeof event !== 'undefined' && event.target) || document.activeElement;
      if (btn.dataset.confirming !== 'true') {
        btn.dataset.confirming = 'true';
        btn.textContent = 'Â¿Seguro?';
        btn.classList.add('bg-red-700');
        setTimeout(() => {
          btn.dataset.confirming = 'false';
          btn.textContent = 'ğŸ—‘ï¸';
          btn.classList.remove('bg-red-700');
        }, 3000);
        return;
      }

      const result = await window.dataSdk.delete(doctor);
      if (result.isOk) {
        showToast('Doctor eliminado', 'success');
      } else {
        showToast('Error al eliminar doctor', 'error');
      }
    }

    // Email Modal
    function openEmailModal(doctorId) {
      const doctor = doctors.find(d => d.__backendId === doctorId);
      if (!doctor) return;

      const month = currentMonth.getMonth();
      const year = currentMonth.getFullYear();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const doctorApts = appointments.filter(a => a.doctor_id === doctorId);
      
      let calendarHtml = `
        <h3 class="font-semibold mb-2">Calendario de ${doctor.doctor_name}</h3>
        <p class="text-xs text-slate-400 mb-3">Mes: ${['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'][month]} ${year}</p>
        <div class="grid grid-cols-7 gap-1 text-xs">
      `;

      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayApts = doctorApts.filter(a => a.date === dateStr && a.status !== 'cancelada');
        const isFull = dayApts.length >= (doctor.doctor_max_appointments || 10);
        const bgColor = isFull ? 'bg-red-600' : dayApts.length > 0 ? 'bg-emerald-600' : 'bg-slate-700';
        
        calendarHtml += `<div class="${bgColor} p-1 rounded text-center">${day}<br><span class="text-[8px]">${dayApts.length}/${doctor.doctor_max_appointments || 10}</span></div>`;
      }

      calendarHtml += '</div>';
      calendarHtml += `<p class="text-xs mt-3 text-slate-400">ğŸ”´ Lleno | ğŸŸ¢ Con citas | â¬œ Disponible</p>`;

      document.getElementById('email-preview').innerHTML = calendarHtml;
      document.getElementById('email-modal').classList.remove('hidden');
      document.getElementById('email-modal').classList.add('flex');
      document.getElementById('email-modal').dataset.doctorId = doctorId;
    }

    function sendCalendarEmail() {
      const doctorId = document.getElementById('email-modal').dataset.doctorId;
      const doctor = doctors.find(d => d.__backendId === doctorId);
      
      if (doctor) {
        showToast(`Calendario enviado a ${doctor.doctor_email}`, 'success');
      }
      closeModal('email-modal');
    }

    // Render Appointments List
    function renderAppointmentsList() {
      const list = document.getElementById('appointments-list');
      const filtered = getFilteredAppointments();

      document.getElementById('appointments-count').textContent = `${filtered.length} cita(s) encontrada(s)`;

      if (filtered.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay citas que mostrar</p>';
        return;
      }

      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const statusLabels = {
        'programada': 'Programada',
        'triaje': 'En Triaje',
        'diagnostico': 'En DiagnÃ³stico',
        'completada': 'Completada',
        'cancelada': 'Cancelada'
      };

      list.innerHTML = filtered.map((apt, idx) => `
        <div class="bg-slate-700 rounded-lg p-3 border border-slate-600">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="font-semibold">${apt.patient_name}</h3>
              <p class="text-sm text-slate-400">${apt.patient_id} | ${apt.patient_age} aÃ±os</p>
              <p class="text-xs text-slate-400">${apt.department}, ${apt.municipality}</p>
            </div>
            <div class="text-right">
              <p class="font-medium">${apt.date}</p>
              <p class="text-sm text-slate-400">Por Cita ${idx + 1}</p>
              <span class="text-xs px-2 py-0.5 rounded ${
                apt.status === 'programada' ? 'bg-blue-600' : 
                apt.status === 'triaje' ? 'bg-purple-600' :
                apt.status === 'diagnostico' ? 'bg-amber-600' :
                apt.status === 'completada' ? 'bg-green-600' : 'bg-red-600'
              }">${statusLabels[apt.status] || apt.status}</span>
            </div>
          </div>
          <div class="mt-2 flex items-center justify-between text-sm">
            <span class="text-emerald-400">${apt.doctor_name} - ${apt.specialty}</span>
            <span class="text-xs bg-slate-600 px-2 py-1 rounded">${originLabels[apt.origin] || apt.origin}</span>
          </div>
          <div class="mt-2 flex gap-2 flex-wrap">
            <button onclick="printAppointmentTicket('${apt.__backendId}')" class="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded flex items-center gap-1" title="Imprimir Ticket de Cita">
              ğŸ« Ticket
            </button>
            <button onclick="createNewAppointmentForPatient('${apt.__backendId}')" class="text-xs bg-teal-600 hover:bg-teal-700 px-3 py-1 rounded flex items-center gap-1" title="Nueva cita con otro especialista">
              â• Nueva Cita
            </button>
            <!-- Expediente status actions -->
            ${apt.expediente === 'enviado' ? `
              <button onclick="toggleExpedienteStatus('${apt.__backendId}')" class="text-xs bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded flex items-center gap-1" title="Expediente: Enviado (clic para marcar recibido)">ğŸ“¤ Enviado</button>
            ` : apt.expediente === 'recibido' ? `
              <button onclick="toggleExpedienteStatus('${apt.__backendId}')" class="text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded flex items-center gap-1" title="Expediente: Recibido">ğŸ“¥ Recibido</button>
            ` : `
              <button onclick="markExpedienteEnviado('${apt.__backendId}')" class="text-xs bg-slate-600 hover:bg-slate-500 px-3 py-1 rounded flex items-center gap-1" title="Marcar expediente como enviado">ğŸ—‚ï¸ Sin expediente</button>
            `}
            <!-- Print expediente -->
            <button onclick="printExpediente('${apt.__backendId}')" class="text-xs bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded" title="Imprimir expediente">ğŸ“„ Expediente</button>
            <!-- Abrir receta desde cita -->
            <button onclick="openPrescriptionFromAppointment('${apt.__backendId}')" class="text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded">ğŸ’Š Receta</button>
            ${apt.status === 'programada' ? `
              <button onclick="openTriageModal('${apt.__backendId}')" class="text-xs bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded">Hacer Triaje</button>
              <button onclick="openReassignModal('${apt.__backendId}')" class="text-xs bg-amber-600 hover:bg-amber-700 px-3 py-1 rounded">Reasignar</button>
              <button onclick="cancelAppointment('${apt.__backendId}', this)" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Cancelar</button>
            ` : ''}
            ${apt.status === 'triaje' ? `
              <button onclick="openDiagnosisModal('${apt.__backendId}')" class="text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded">Hacer DiagnÃ³stico</button>
              <button onclick="openPrintOptions('${apt.__backendId}', 'triage')" class="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded">Imprimir Triaje</button>
              <button onclick="downloadCompleteTriagePDF('${apt.__backendId}')" class="text-xs bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded">ğŸ“‹ PDF Completo Triaje</button>
            ` : ''}
            ${apt.status === 'diagnostico' || apt.status === 'completada' ? `
              <button onclick="openReferenceModal('${apt.__backendId}')" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Crear Referencia</button>
              <button onclick="openPrintOptions('${apt.__backendId}', 'diagnosis')" class="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded">Imprimir DiagnÃ³stico</button>
            ` : ''}
            ${apt.reference_hospital ? `
              <button onclick="openPrintOptions('${apt.__backendId}', 'reference')" class="text-xs bg-orange-600 hover:bg-orange-700 px-3 py-1 rounded">Imprimir Referencia</button>
              <button onclick="openPrintOptions('${apt.__backendId}', 'both')" class="text-xs bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded">Ambos (Diag+Ref)</button>
            ` : ''}
            </div>
        </div>
      `).join('');
    }

    function filterAppointments() {
      renderAppointmentsList();
    }

    // Expediente helpers: marcar, recibir, imprimir y abrir receta desde cita
    async function updateAppointmentAndSave(updatedApt) {
      if (window.dataSdk && typeof window.dataSdk.update === 'function') {
        try { await window.dataSdk.update(updatedApt); } catch (e) { console.warn(e); }
      } else {
        const idx = appointments.findIndex(a => a.__backendId === updatedApt.__backendId);
        if (idx !== -1) appointments[idx] = updatedApt; else appointments.push(updatedApt);
        saveAllToLocal();
        try { dataHandler.onDataChanged([...(doctors||[]), ...(appointments||[]), ...(expenses||[]), ...(settings? [settings] : [])]); } catch (e) { /* ignore */ }
      }
    }

    function toggleExpedienteStatus(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      const newStatus = apt.expediente === 'recibido' ? 'enviado' : 'recibido';
      const updated = { ...apt, expediente: newStatus, expediente_updated_at: new Date().toISOString() };
      updateAppointmentAndSave(updated);
      showToast(`Expediente marcado como ${newStatus}`, 'success');
      renderAppointmentsList();
    }

    function markExpedienteEnviado(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      const updated = { ...apt, expediente: 'enviado', expediente_updated_at: new Date().toISOString() };
      updateAppointmentAndSave(updated);
      showToast('Expediente marcado como enviado', 'success');
      renderAppointmentsList();
    }

    async function receiveAllSentByDate() {
      const date = document.getElementById('filter-date-from')?.value;
      if (!date) return alert('Seleccione la fecha (desde) para recibir los expedientes enviados');
      const toDate = document.getElementById('filter-date-to')?.value || date;
      const updated = [];
      for (const apt of appointments) {
        if (!apt.date) continue;
        if (apt.date >= date && apt.date <= toDate && apt.expediente === 'enviado') {
          const u = { ...apt, expediente: 'recibido', expediente_updated_at: new Date().toISOString() };
          updated.push(u);
        }
      }
      for (const u of updated) await updateAppointmentAndSave(u);
      showToast(`Marcados ${updated.length} expediente(s) como recibidos`, 'success');
      renderAppointmentsList();
    }

    function printExpediente(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return alert('Cita no encontrada');
      const content = `
        <div style="font-family:Poppins, sans-serif; padding:20px; color:#000;">
          <h2>${document.getElementById('hospital-title')?.textContent || ''}</h2>
          <p>${document.getElementById('system-subtitle')?.textContent || ''}</p>
          <hr/>
          <h3>Expediente - ${apt.patient_name}</h3>
          <p><strong>Fecha:</strong> ${apt.date} ${apt.time || ''}</p>
          <p><strong>MÃ©dico:</strong> ${apt.doctor_name}</p>
          <p><strong>Estado expediente:</strong> ${apt.expediente || 'sin'}</p>
          <h4>Notas / Historia</h4>
          <pre style="white-space:pre-wrap;">${apt.expediente_notes || ''}</pre>
        </div>
      `;
      const win = window.open('', '', 'width=800,height=600');
      if (!win) return;
      win.document.write(`<html><head><title>Expediente - ${apt.patient_name}</title><link rel="stylesheet" href="style.css"></head><body>${content}</body></html>`);
      win.document.close();
      setTimeout(()=>{ win.print(); win.close(); }, 400);
    }

    function openPrescriptionFromAppointment(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      openPrescriptionModal();
      setTimeout(()=>{
        document.getElementById('presc-patient').value = apt.patient_name || '';
        document.getElementById('presc-id').value = apt.patient_id || '';
        const sel = document.getElementById('prescription-doctor');
        if (sel) {
          // try to select doctor by __backendId
          for (let i=0;i<sel.options.length;i++){
            if (sel.options[i].value === apt.doctor_id) { sel.selectedIndex = i; sel.onchange && sel.onchange(); break; }
          }
        }
      }, 200);
    }

    // Triage Functions
    function openTriageModal(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      
      currentTriageApt = apt;
      document.getElementById('triage-apt-id').value = aptId;
      document.getElementById('triage-patient-name').textContent = apt.patient_name;
      document.getElementById('triage-patient-info').textContent = `${apt.patient_id} | ${apt.patient_age} aÃ±os | ${apt.doctor_name} - ${apt.specialty}`;
      
      document.getElementById('triage-form').reset();
      document.getElementById('triage-apt-id').value = aptId;
      
      document.getElementById('triage-modal').classList.remove('hidden');
      document.getElementById('triage-modal').classList.add('flex');
    }

    async function saveTriage() {
      const aptId = document.getElementById('triage-apt-id').value;
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;

      const btn = document.getElementById('save-triage-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      const updatedApt = {
        ...apt,
        status: 'triaje',
        triage_blood_pressure: document.getElementById('triage-bp').value,
        triage_heart_rate: document.getElementById('triage-hr').value,
        triage_temperature: document.getElementById('triage-temp').value,
        triage_weight: document.getElementById('triage-weight').value,
        triage_height: document.getElementById('triage-height').value,
        triage_oxygen: document.getElementById('triage-oxygen').value,
        triage_notes: document.getElementById('triage-notes').value,
        triage_date: new Date().toISOString()
      };

      let result;
      try {
        if (window.dataSdk && typeof window.dataSdk.update === 'function') {
          result = await window.dataSdk.update(updatedApt);
        } else {
          const idx = appointments.findIndex(a => a.__backendId === updatedApt.__backendId);
          if (idx !== -1) appointments[idx] = updatedApt;
          else appointments.push(updatedApt);
          saveAllToLocal();
          // Refresh UI with updated local data
          try { dataHandler.onDataChanged([...(doctors||[]), ...(appointments||[]), ...(expenses||[]), ...(settings? [settings] : [])]); } catch (e) { /* ignore */ }
          result = { isOk: true };
        }
      } catch (e) {
        console.error('Error saving triage', e);
        result = { isOk: false };
      }

      btn.disabled = false;
      btn.textContent = 'Guardar Triaje';

      if (result && result.isOk) {
        showToast('Triaje guardado exitosamente', 'success');
        closeModal('triage-modal');
      } else {
        showToast('Error al guardar triaje', 'error');
      }
    }

    function printTriageAndContinue() {
      const aptId = document.getElementById('triage-apt-id').value;
      saveTriage().then(() => {
        setTimeout(() => {
          openPrintOptions(aptId, 'triage');
        }, 500);
      });
    }

    function renderTriagePending() {
      const list = document.getElementById('triage-pending-list');
      const pending = appointments.filter(a => a.status === 'programada').sort((a, b) => new Date(a.date) - new Date(b.date));
      
      if (pending.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay triajes pendientes</p>';
        return;
      }

      list.innerHTML = pending.map(apt => `
        <div class="bg-slate-700 rounded-lg p-3 flex items-center justify-between">
          <div>
            <h3 class="font-semibold">${apt.patient_name}</h3>
            <p class="text-sm text-slate-400">${apt.date} - ${apt.time} | ${apt.patient_age} aÃ±os</p>
            <p class="text-xs text-emerald-400">${apt.doctor_name} - ${apt.specialty}</p>
          </div>
          <button onclick="openTriageModal('${apt.__backendId}')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm">
            Hacer Triaje
          </button>
        </div>
      `).join('');
    }

    // Render Triages Completed
    function renderTriagesCompleted() {
      const list = document.getElementById('triage-completed-list');
      const filtered = getFilteredTriagesCompleted();
      
      // Update doctor filter
      const doctorFilter = document.getElementById('filter-triage-doctor');
      if (doctorFilter) {
        const currentValue = doctorFilter.value;
        doctorFilter.innerHTML = '<option value="">Todos los doctores</option>';
        doctors.forEach(doc => {
          doctorFilter.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name}</option>`;
        });
        doctorFilter.value = currentValue;
      }
      
      document.getElementById('triage-completed-count').textContent = `${filtered.length} triaje(s) encontrado(s)`;
      
      if (filtered.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay triajes realizados</p>';
        return;
      }

      list.innerHTML = filtered.map(apt => {
        const hasReference = apt.reference_hospital ? true : false;
        const hasDiagnosis = apt.diagnosis ? true : false;
        
        let statusBadge = '';
        let bgColor = 'bg-slate-700 border-slate-600';
        
        if (hasReference) {
          statusBadge = '<span class="text-xs bg-red-600 px-2 py-1 rounded">CON REFERENCIA</span>';
          bgColor = 'bg-red-600/20 border-red-500';
        } else if (hasDiagnosis) {
          statusBadge = '<span class="text-xs bg-emerald-600 px-2 py-1 rounded">CON DIAGNÃ“STICO</span>';
          bgColor = 'bg-emerald-600/20 border-emerald-500';
        } else {
          statusBadge = '<span class="text-xs bg-purple-600 px-2 py-1 rounded">SOLO TRIAJE</span>';
          bgColor = 'bg-purple-600/20 border-purple-500';
        }
        
        return `
          <div class="rounded-lg p-3 border ${bgColor}">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-semibold">${apt.patient_name}</h3>
                  ${statusBadge}
                </div>
                <p class="text-sm text-slate-400">${apt.patient_id} | ${apt.patient_age} aÃ±os</p>
                <p class="text-xs text-emerald-400">${apt.doctor_name} - ${apt.specialty}</p>
                <p class="text-xs text-slate-400">Fecha de triaje: ${apt.triage_date ? new Date(apt.triage_date).toLocaleDateString() : 'N/A'}</p>
              </div>
            </div>
            
            <!-- Triaje Info -->
            <div class="bg-slate-600/50 rounded p-2 mb-2 text-xs">
              <strong class="text-purple-300">ğŸ“‹ SIGNOS VITALES:</strong><br>
              PA: ${apt.triage_blood_pressure} | FC: ${apt.triage_heart_rate} bpm | Temp: ${apt.triage_temperature}Â°C<br>
              Peso: ${apt.triage_weight} kg | Altura: ${apt.triage_height} cm | SpOâ‚‚: ${apt.triage_oxygen}%
              ${apt.triage_notes ? `<br><strong>Notas:</strong> ${apt.triage_notes}` : ''}
            </div>
            
            <!-- Diagnosis Info -->
            ${hasDiagnosis ? `
            <div class="bg-emerald-600/20 rounded p-2 mb-2 text-xs border border-emerald-500">
              <strong class="text-emerald-300">ğŸ©º DIAGNÃ“STICO:</strong><br>
              ${apt.diagnosis}
              ${apt.diagnosis_date ? `<br><strong>Fecha:</strong> ${new Date(apt.diagnosis_date).toLocaleDateString()}` : ''}
              ${apt.payment_amount > 0 ? `<br><strong>Pago:</strong> L.${apt.payment_amount.toFixed(2)} - ${apt.payment_status}` : ''}
            </div>
            ` : ''}
            
            <!-- Reference Info -->
            ${hasReference ? `
            <div class="bg-red-600/20 rounded p-2 mb-2 text-xs border border-red-500">
              <strong class="text-red-300">ğŸ¥ REFERENCIA A:</strong> ${apt.reference_hospital}<br>
              <strong>Motivo:</strong> ${apt.reference_reason}
              ${apt.reference_date ? `<br><strong>Fecha:</strong> ${new Date(apt.reference_date).toLocaleDateString()}` : ''}
            </div>
            ` : ''}
            
            <div class="mt-2 flex gap-2 flex-wrap">
              <button onclick="downloadCompleteTriagePDF('${apt.__backendId}')" class="text-xs bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded">
                ğŸ“‹ PDF Triaje Completo
              </button>
              ${hasDiagnosis ? `
                <button onclick="openPrintOptions('${apt.__backendId}', 'diagnosis')" class="text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded">
                  ğŸ“„ Imprimir DiagnÃ³stico
                </button>
              ` : ''}
              ${hasReference ? `
                <button onclick="openPrintOptions('${apt.__backendId}', 'reference')" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-1 rounded">
                  ğŸ“„ Imprimir Referencia
                </button>
                <button onclick="openPrintOptions('${apt.__backendId}', 'both')" class="text-xs bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded">
                  ğŸ“„ Ambos (Diag+Ref)
                </button>
              ` : ''}
              ${hasDiagnosis && !hasReference ? `
                <button onclick="openReferenceModal('${apt.__backendId}')" class="text-xs bg-amber-600 hover:bg-amber-700 px-3 py-1 rounded">
                  â• Agregar Referencia
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Get Filtered Triages Completed
    function getFilteredTriagesCompleted() {
      const search = document.getElementById('search-triage-completed')?.value?.toLowerCase() || '';
      const statusFilter = document.getElementById('filter-triage-status')?.value || '';
      const doctorFilter = document.getElementById('filter-triage-doctor')?.value || '';
      
      return appointments.filter(apt => {
        // Must have triage data
        if (!apt.triage_date) return false;
        
        const matchesSearch = apt.patient_name.toLowerCase().includes(search) || 
                             apt.patient_id.includes(search);
        const matchesDoctor = !doctorFilter || apt.doctor_id === doctorFilter;
        
        let matchesStatus = true;
        if (statusFilter === 'triaje') {
          matchesStatus = apt.status === 'triaje';
        } else if (statusFilter === 'diagnostico') {
          matchesStatus = (apt.status === 'diagnostico' || apt.status === 'completada') && apt.diagnosis && !apt.reference_hospital;
        } else if (statusFilter === 'completada') {
          matchesStatus = apt.status === 'completada' && apt.reference_hospital;
        }
        
        return matchesSearch && matchesDoctor && matchesStatus;
      }).sort((a, b) => new Date(b.triage_date) - new Date(a.triage_date));
    }
    
    // Filter Triages Completed
    function filterTriagesCompleted() {
      renderTriagesCompleted();
    }

    // Download Complete Triage PDF
    function downloadCompleteTriagePDF(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;

      const doctor = doctors.find(d => d.__backendId === apt.doctor_id);
      const patientHistory = appointments
        .filter(a => a.patient_id === apt.patient_id && a.status !== 'programada' && a.status !== 'cancelada')
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      const originLabels = {
        'consulta_externa': 'Consulta Externa',
        'emergencia': 'Emergencia',
        'sala': 'Por Sala',
        'referencia_centro_salud': 'Ref. Centro de Salud',
        'referencia_clinica_privada': 'Ref. ClÃ­nica Privada'
      };

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;

      const calculateBMI = (weight, height) => {
        if (!weight || !height) return 'N/A';
        const heightM = height / 100;
        const bmi = (weight / (heightM * heightM)).toFixed(2);
        return bmi;
      };

      const bmi = calculateBMI(parseFloat(apt.triage_weight), parseFloat(apt.triage_height));

      let content = `
${'='.repeat(80)}
${hospitalName.toUpperCase()}
HOJA DE TRIAJE COMPLETA - REPORTE DETALLADO
${'='.repeat(80)}

INFORMACIÃ“N DEL PACIENTE
${'='.repeat(80)}
Nombre Completo:        ${apt.patient_name}
NÃºmero de Identidad:    ${apt.patient_id}
Fecha de Nacimiento:    ${apt.patient_birthdate || 'N/A'}
Edad:                   ${apt.patient_age} aÃ±os
Departamento:           ${apt.department}
Municipio:              ${apt.municipality}
Barrio/Aldea:           ${apt.neighborhood || 'N/A'}

DATOS DE LA CITA
${'='.repeat(80)}
ID de Cita:             ${aptId}
Fecha de Cita:          ${apt.date}
Hora:                   ${apt.time}
Origen de la Cita:      ${originLabels[apt.origin] || apt.origin}
Fecha de Triaje:        ${apt.triage_date ? new Date(apt.triage_date).toLocaleString() : 'N/A'}

INFORMACIÃ“N DEL MÃ‰DICO
${'='.repeat(80)}
Doctor Asignado:        ${apt.doctor_name}
Especialidad:           ${apt.specialty}
${doctor ? `Correo:                 ${doctor.doctor_email}` : ''}

SIGNOS VITALES
${'='.repeat(80)}
PresiÃ³n Arterial:       ${apt.triage_blood_pressure}
Frecuencia CardÃ­aca:    ${apt.triage_heart_rate} bpm
Temperatura:            ${apt.triage_temperature} Â°C
SaturaciÃ³n Oâ‚‚:          ${apt.triage_oxygen}%

MEDIDAS ANTROPOMÃ‰TRICAS
${'='.repeat(80)}
Peso:                   ${apt.triage_weight} kg
Altura:                 ${apt.triage_height} cm
IMC (Ãndice de Masa Corporal): ${bmi}

OBSERVACIONES DEL TRIAJE
${'='.repeat(80)}
${apt.triage_notes || 'Sin observaciones adicionales'}

`;

      if (patientHistory.length > 0) {
        content += `HISTORIAL DE TRIAJES ANTERIORES
${'='.repeat(80)}
Total de Triajes Registrados: ${patientHistory.length}

${patientHistory.map((h, i) => `
TRIAJE #${i + 1} - ${h.date}
${'-'.repeat(80)}
Doctor:         ${h.doctor_name} (${h.specialty})
PA:             ${h.triage_blood_pressure || 'N/A'}
FC:             ${h.triage_heart_rate || 'N/A'} bpm
Temp:           ${h.triage_temperature || 'N/A'} Â°C
Peso:           ${h.triage_weight || 'N/A'} kg
Altura:         ${h.triage_height || 'N/A'} cm
SpOâ‚‚:           ${h.triage_oxygen || 'N/A'}%
Estado:         ${h.status.toUpperCase()}
${h.triage_notes ? `Notas:          ${h.triage_notes}` : ''}
${h.diagnosis ? `DiagnÃ³stico:    ${h.diagnosis}` : ''}
`).join('\n')}
`;
      }

      content += `
${'='.repeat(80)}
ESCALA DE VALORES DE REFERENCIA
${'='.repeat(80)}
PresiÃ³n Arterial Normal:    120/80 mmHg
Frecuencia CardÃ­aca Normal: 60-100 bpm (adultos)
Temperatura Normal:         36.5-37.5 Â°C
SaturaciÃ³n Oâ‚‚ Normal:       95-100%
IMC Normal:                 18.5-24.9 kg/mÂ²

${'='.repeat(80)}
NOTAS IMPORTANTES
${'='.repeat(80)}
- Este documento contiene informaciÃ³n mÃ©dica confidencial
- Los valores fuera del rango normal requieren evaluaciÃ³n mÃ©dica
- Presentar este documento al mÃ©dico durante la consulta
- Conservar para el expediente mÃ©dico del paciente

${'='.repeat(80)}
Documento generado: ${new Date().toLocaleString()}
Personal de EnfermerÃ­a: _________________________________
Firma: __________________________________________________
${'='.repeat(80)}
      `;

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `triaje_completo_${apt.patient_id}_${apt.date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('PDF completo de triaje descargado', 'success');
    }

    // Diagnosis Functions
    function openDiagnosisModal(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      
      currentDiagnosisApt = apt;
      document.getElementById('diagnosis-apt-id').value = aptId;
      document.getElementById('diagnosis-patient-name').textContent = apt.patient_name;
      document.getElementById('diagnosis-patient-info').textContent = `${apt.patient_id} | ${apt.patient_age} aÃ±os | ${apt.doctor_name} - ${apt.specialty}`;
      
      const triageInfo = `
        <strong>Signos Vitales:</strong><br>
        PA: ${apt.triage_blood_pressure} | FC: ${apt.triage_heart_rate} bpm | Temp: ${apt.triage_temperature}Â°C<br>
        Peso: ${apt.triage_weight} kg | Altura: ${apt.triage_height} cm | SpOâ‚‚: ${apt.triage_oxygen}%
        ${apt.triage_notes ? `<br>Notas: ${apt.triage_notes}` : ''}
      `;
      document.getElementById('diagnosis-triage-info').innerHTML = triageInfo;
      
      // Load doctor services
      const doctor = doctors.find(d => d.__backendId === apt.doctor_id);
      const serviceSelect = document.getElementById('diagnosis-service');
      serviceSelect.innerHTML = '<option value="">Seleccione servicio...</option>';
      
      if (doctor && doctor.doctor_services) {
        const services = JSON.parse(doctor.doctor_services);
        services.forEach(service => {
          serviceSelect.innerHTML += `<option value="${JSON.stringify(service).replace(/"/g, '&quot;')}">${service.name} - L.${service.price.toFixed(2)}</option>`;
        });
      }
      
      serviceSelect.onchange = () => {
        if (serviceSelect.value) {
          const service = JSON.parse(serviceSelect.value);
          document.getElementById('service-price-display').textContent = `Costo del servicio: L.${service.price.toFixed(2)}`;
        } else {
          document.getElementById('service-price-display').textContent = '';
        }
      };
      
      document.getElementById('diagnosis-form').reset();
      document.getElementById('diagnosis-apt-id').value = aptId;
      
      document.getElementById('diagnosis-modal').classList.remove('hidden');
      document.getElementById('diagnosis-modal').classList.add('flex');
    }

    async function saveDiagnosis() {
      const aptId = document.getElementById('diagnosis-apt-id').value;
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;

      const serviceValue = document.getElementById('diagnosis-service').value;
      if (!serviceValue) {
        showToast('Seleccione un servicio', 'error');
        return;
      }

      const service = JSON.parse(serviceValue);

      const btn = document.getElementById('save-diagnosis-btn');
      btn.disabled = true;
      btn.textContent = 'Procesando...';

      const updatedApt = {
        ...apt,
        status: 'diagnostico',
        diagnosis: document.getElementById('diagnosis-text').value,
        diagnosis_date: new Date().toISOString(),
        payment_amount: service.price,
        payment_date: new Date().toISOString(),
        payment_status: 'completado'
      };

      let result;
      try {
        if (window.dataSdk && typeof window.dataSdk.update === 'function') {
          result = await window.dataSdk.update(updatedApt);
        } else {
          const idx = appointments.findIndex(a => a.__backendId === updatedApt.__backendId);
          if (idx !== -1) appointments[idx] = updatedApt;
          else appointments.push(updatedApt);
          saveAllToLocal();
          try { dataHandler.onDataChanged([...(doctors||[]), ...(appointments||[]), ...(expenses||[]), ...(settings? [settings] : [])]); } catch (e) { /* ignore */ }
          result = { isOk: true };
        }
      } catch (e) {
        console.error('Error saving diagnosis', e);
        result = { isOk: false };
      }

      btn.disabled = false;
      btn.textContent = 'Guardar y Procesar Pago';

      if (result && result.isOk) {
        showToast(`DiagnÃ³stico guardado - Pago procesado: L.${service.price.toFixed(2)}`, 'success');
        closeModal('diagnosis-modal');
      } else {
        showToast('Error al guardar diagnÃ³stico', 'error');
      }
    }

    function renderDiagnosisPending() {
      const list = document.getElementById('diagnosis-pending-list');
      const pending = appointments.filter(a => a.status === 'triaje').sort((a, b) => new Date(a.date) - new Date(b.date));
      
      if (pending.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay diagnÃ³sticos pendientes</p>';
        return;
      }

      list.innerHTML = pending.map(apt => `
        <div class="bg-slate-700 rounded-lg p-3">
          <div class="flex items-center justify-between mb-2">
            <div>
              <h3 class="font-semibold">${apt.patient_name}</h3>
              <p class="text-sm text-slate-400">${apt.date} - ${apt.time} | ${apt.patient_age} aÃ±os</p>
              <p class="text-xs text-emerald-400">${apt.doctor_name} - ${apt.specialty}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="openDiagnosisModal('${apt.__backendId}')" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm">
                Diagnosticar
              </button>
              <button onclick="downloadCompleteTriagePDF('${apt.__backendId}')" class="bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded-lg text-sm" title="Descargar PDF Completo Triaje">
                ğŸ“‹ PDF
              </button>
            </div>
          </div>
          <div class="text-xs text-slate-400 bg-slate-600 rounded p-2 mt-2">
            <strong>Triaje:</strong> PA: ${apt.triage_blood_pressure} | FC: ${apt.triage_heart_rate} | Temp: ${apt.triage_temperature}Â°C
          </div>
        </div>
      `).join('');
    }

    // Reference Functions
    function openReferenceModal(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      
      document.getElementById('reference-apt-id').value = aptId;
      document.getElementById('reference-patient-name').textContent = apt.patient_name;
      document.getElementById('reference-patient-info').textContent = `${apt.patient_id} | ${apt.patient_age} aÃ±os | ${apt.doctor_name} - ${apt.specialty}`;
      document.getElementById('reference-diagnosis-info').textContent = `DiagnÃ³stico: ${apt.diagnosis || 'N/A'}`;
      
      document.getElementById('reference-form').reset();
      document.getElementById('reference-apt-id').value = aptId;
      
      document.getElementById('reference-modal').classList.remove('hidden');
      document.getElementById('reference-modal').classList.add('flex');
    }

    async function saveReference() {
      const aptId = document.getElementById('reference-apt-id').value;
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;

      const btn = document.getElementById('save-reference-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';

      const updatedApt = {
        ...apt,
        status: 'completada',
        reference_hospital: document.getElementById('reference-hospital').value,
        reference_reason: document.getElementById('reference-reason').value,
        reference_date: new Date().toISOString()
      };

      let result;
      try {
        if (window.dataSdk && typeof window.dataSdk.update === 'function') {
          result = await window.dataSdk.update(updatedApt);
        } else {
          const idx = appointments.findIndex(a => a.__backendId === updatedApt.__backendId);
          if (idx !== -1) appointments[idx] = updatedApt;
          else appointments.push(updatedApt);
          saveAllToLocal();
          try { dataHandler.onDataChanged([...(doctors||[]), ...(appointments||[]), ...(expenses||[]), ...(settings? [settings] : [])]); } catch (e) { /* ignore */ }
          result = { isOk: true };
        }
      } catch (e) {
        console.error('Error saving reference', e);
        result = { isOk: false };
      }

      btn.disabled = false;
      btn.textContent = 'Generar Referencia';

      if (result && result.isOk) {
        showToast('Referencia generada exitosamente', 'success');
        closeModal('reference-modal');
        setTimeout(() => {
          openPrintOptions(aptId, 'reference');
        }, 500);
      } else {
        showToast('Error al generar referencia', 'error');
      }
    }

    // Print Options
    function openPrintOptions(aptId, type) {
      document.getElementById('print-apt-id').value = aptId;
      document.getElementById('print-type').value = type;
      
      const titles = {
        'triage': 'Imprimir Triaje',
        'diagnosis': 'Imprimir DiagnÃ³stico',
        'reference': 'Imprimir Referencia',
        'both': 'Imprimir DiagnÃ³stico y Referencia'
      };
      
      document.getElementById('print-options-title').textContent = titles[type] || 'Opciones de ImpresiÃ³n';
      document.getElementById('print-options-modal').classList.remove('hidden');
      document.getElementById('print-options-modal').classList.add('flex');
    }

    function printDocument() {
      const aptId = document.getElementById('print-apt-id').value;
      const type = document.getElementById('print-type').value;
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;

      let content = '';

      if (type === 'triage' || type === 'both') {
        content += `
<div style="padding: 20px; font-family: Arial, sans-serif;">
  <h2 style="text-align: center;">${hospitalName.toUpperCase()}</h2>
  <h3 style="text-align: center;">HOJA DE TRIAJE</h3>
  <hr>
  
  <p><strong>Paciente:</strong> ${apt.patient_name}</p>
  <p><strong>Identidad:</strong> ${apt.patient_id}</p>
  <p><strong>Edad:</strong> ${apt.patient_age} aÃ±os</p>
  <p><strong>Fecha:</strong> ${apt.date} ${apt.time}</p>
  <p><strong>Doctor:</strong> ${apt.doctor_name}</p>
  
  <h4>SIGNOS VITALES</h4>
  <table style="width: 100%; border-collapse: collapse;">
    <tr><td style="border: 1px solid #000; padding: 5px;"><strong>PresiÃ³n Arterial:</strong></td><td style="border: 1px solid #000; padding: 5px;">${apt.triage_blood_pressure}</td></tr>
    <tr><td style="border: 1px solid #000; padding: 5px;"><strong>Frecuencia CardÃ­aca:</strong></td><td style="border: 1px solid #000; padding: 5px;">${apt.triage_heart_rate} bpm</td></tr>
    <tr><td style="border: 1px solid #000; padding: 5px;"><strong>Temperatura:</strong></td><td style="border: 1px solid #000; padding: 5px;">${apt.triage_temperature} Â°C</td></tr>
    <tr><td style="border: 1px solid #000; padding: 5px;"><strong>Peso:</strong></td><td style="border: 1px solid #000; padding: 5px;">${apt.triage_weight} kg</td></tr>
    <tr><td style="border: 1px solid #000; padding: 5px;"><strong>Altura:</strong></td><td style="border: 1px solid #000; padding: 5px;">${apt.triage_height} cm</td></tr>
    <tr><td style="border: 1px solid #000; padding: 5px;"><strong>SaturaciÃ³n Oâ‚‚:</strong></td><td style="border: 1px solid #000; padding: 5px;">${apt.triage_oxygen}%</td></tr>
  </table>
  
  ${apt.triage_notes ? `<p><strong>Notas:</strong> ${apt.triage_notes}</p>` : ''}
  
  <p style="margin-top: 30px;"><strong>Fecha de Triaje:</strong> ${new Date(apt.triage_date).toLocaleString()}</p>
</div>
        `;
      }

      if (type === 'diagnosis' || type === 'both') {
        if (type === 'both') content += '<div style="page-break-before: always;"></div>';
        content += `
<div style="padding: 20px; font-family: Arial, sans-serif;">
  <h2 style="text-align: center;">${hospitalName.toUpperCase()}</h2>
  <h3 style="text-align: center;">DIAGNÃ“STICO MÃ‰DICO</h3>
  <hr>
  
  <p><strong>Paciente:</strong> ${apt.patient_name}</p>
  <p><strong>Identidad:</strong> ${apt.patient_id}</p>
  <p><strong>Edad:</strong> ${apt.patient_age} aÃ±os</p>
  <p><strong>Fecha:</strong> ${apt.date} ${apt.time}</p>
  <p><strong>Doctor:</strong> ${apt.doctor_name}</p>
  <p><strong>Especialidad:</strong> ${apt.specialty}</p>
  
  <h4>DIAGNÃ“STICO</h4>
  <p style="border: 1px solid #000; padding: 10px; min-height: 100px;">${apt.diagnosis}</p>
  
  <h4>PAGO</h4>
  <p><strong>Monto:</strong> L.${apt.payment_amount.toFixed(2)}</p>
  <p><strong>Estado:</strong> ${apt.payment_status}</p>
  <p><strong>Fecha de Pago:</strong> ${apt.payment_date ? new Date(apt.payment_date).toLocaleString() : 'N/A'}</p>
  
  <div style="margin-top: 50px;">
    <p>_______________________________</p>
    <p>Firma del MÃ©dico</p>
  </div>
</div>
        `;
      }

      if (type === 'reference') {
        content += `
<div style="padding: 20px; font-family: Arial, sans-serif;">
  <h2 style="text-align: center;">${hospitalName.toUpperCase()}</h2>
  <h3 style="text-align: center;">REFERENCIA MÃ‰DICA</h3>
  <hr>
  
  <p><strong>Paciente:</strong> ${apt.patient_name}</p>
  <p><strong>Identidad:</strong> ${apt.patient_id}</p>
  <p><strong>Edad:</strong> ${apt.patient_age} aÃ±os</p>
  <p><strong>DirecciÃ³n:</strong> ${apt.department}, ${apt.municipality}, ${apt.neighborhood}</p>
  
  <h4>DIAGNÃ“STICO</h4>
  <p style="border: 1px solid #000; padding: 10px;">${apt.diagnosis}</p>
  
  <h4>REFERENCIA A</h4>
  <p><strong>Hospital/Centro:</strong> ${apt.reference_hospital}</p>
  
  <h4>MOTIVO DE REFERENCIA</h4>
  <p style="border: 1px solid #000; padding: 10px; min-height: 100px;">${apt.reference_reason}</p>
  
  <p><strong>MÃ©dico Refiere:</strong> ${apt.doctor_name}</p>
  <p><strong>Especialidad:</strong> ${apt.specialty}</p>
  <p><strong>Fecha:</strong> ${new Date(apt.reference_date).toLocaleString()}</p>
  
  <div style="margin-top: 50px;">
    <p>_______________________________</p>
    <p>Firma y Sello del MÃ©dico</p>
  </div>
</div>
        `;
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head><title>Documento MÃ©dico</title></head>
          <body>
            ${content}
            <script>window.onload = function() { window.print(); }<\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    function downloadDocumentPDF() {
      const aptId = document.getElementById('print-apt-id').value;
      const type = document.getElementById('print-type').value;
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;

      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;

      let content = '';
      
      if (type === 'triage' || type === 'both') {
        content += `${'='.repeat(80)}\n`;
        content += `${hospitalName.toUpperCase()}\n`;
        content += `HOJA DE TRIAJE - REPORTE COMPLETO\n`;
        content += `${'='.repeat(80)}\n\n`;
        
        content += `INFORMACIÃ“N DEL PACIENTE\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Nombre Completo:        ${apt.patient_name}\n`;
        content += `NÃºmero de Identidad:    ${apt.patient_id}\n`;
        content += `Fecha de Nacimiento:    ${apt.patient_birthdate || 'N/A'}\n`;
        content += `Edad:                   ${apt.patient_age} aÃ±os\n`;
        content += `Departamento:           ${apt.department}\n`;
        content += `Municipio:              ${apt.municipality}\n`;
        content += `Barrio/Aldea:           ${apt.neighborhood || 'N/A'}\n\n`;
        
        content += `DATOS DE LA CITA\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Fecha de Cita:          ${apt.date}\n`;
        content += `Hora:                   ${apt.time}\n`;
        content += `Doctor Asignado:        ${apt.doctor_name}\n`;
        content += `Especialidad:           ${apt.specialty}\n`;
        content += `Fecha de Triaje:        ${apt.triage_date ? new Date(apt.triage_date).toLocaleString() : 'N/A'}\n\n`;
        
        content += `SIGNOS VITALES\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `PresiÃ³n Arterial:       ${apt.triage_blood_pressure}\n`;
        content += `Frecuencia CardÃ­aca:    ${apt.triage_heart_rate} bpm\n`;
        content += `Temperatura:            ${apt.triage_temperature} Â°C\n`;
        content += `SaturaciÃ³n Oâ‚‚:          ${apt.triage_oxygen}%\n`;
        content += `Peso:                   ${apt.triage_weight} kg\n`;
        content += `Altura:                 ${apt.triage_height} cm\n\n`;
        
        if (apt.triage_notes) {
          content += `OBSERVACIONES DEL TRIAJE\n`;
          content += `${'-'.repeat(80)}\n`;
          content += `${apt.triage_notes}\n\n`;
        }
        
        content += `${'='.repeat(80)}\n`;
        content += `Documento generado: ${new Date().toLocaleString()}\n`;
        content += `Personal de EnfermerÃ­a: _________________________________\n`;
        content += `Firma: __________________________________________________\n`;
        content += `${'='.repeat(80)}\n`;
      }

      if (type === 'diagnosis' || type === 'both') {
        if (type === 'both') content += '\n\n\n';
        
        content += `${'='.repeat(80)}\n`;
        content += `${hospitalName.toUpperCase()}\n`;
        content += `DIAGNÃ“STICO MÃ‰DICO - REPORTE COMPLETO\n`;
        content += `${'='.repeat(80)}\n\n`;
        
        content += `INFORMACIÃ“N DEL PACIENTE\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Nombre Completo:        ${apt.patient_name}\n`;
        content += `NÃºmero de Identidad:    ${apt.patient_id}\n`;
        content += `Fecha de Nacimiento:    ${apt.patient_birthdate || 'N/A'}\n`;
        content += `Edad:                   ${apt.patient_age} aÃ±os\n`;
        content += `Departamento:           ${apt.department}\n`;
        content += `Municipio:              ${apt.municipality}\n`;
        content += `Barrio/Aldea:           ${apt.neighborhood || 'N/A'}\n\n`;
        
        content += `DATOS DE LA CONSULTA\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Fecha de Consulta:      ${apt.date}\n`;
        content += `Hora:                   ${apt.time}\n`;
        content += `MÃ©dico Tratante:        ${apt.doctor_name}\n`;
        content += `Especialidad:           ${apt.specialty}\n`;
        content += `Fecha de DiagnÃ³stico:   ${apt.diagnosis_date ? new Date(apt.diagnosis_date).toLocaleString() : 'N/A'}\n\n`;
        
        content += `SIGNOS VITALES (TRIAJE)\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `PresiÃ³n Arterial:       ${apt.triage_blood_pressure}\n`;
        content += `Frecuencia CardÃ­aca:    ${apt.triage_heart_rate} bpm\n`;
        content += `Temperatura:            ${apt.triage_temperature} Â°C\n`;
        content += `SaturaciÃ³n Oâ‚‚:          ${apt.triage_oxygen}%\n`;
        content += `Peso:                   ${apt.triage_weight} kg\n`;
        content += `Altura:                 ${apt.triage_height} cm\n\n`;
        
        content += `DIAGNÃ“STICO MÃ‰DICO\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `${apt.diagnosis}\n\n`;
        
        content += `INFORMACIÃ“N DE PAGO\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Monto Total:            L.${apt.payment_amount.toFixed(2)}\n`;
        content += `Estado del Pago:        ${apt.payment_status.toUpperCase()}\n`;
        content += `Fecha de Pago:          ${apt.payment_date ? new Date(apt.payment_date).toLocaleString() : 'N/A'}\n\n`;
        
        content += `${'='.repeat(80)}\n`;
        content += `Documento generado: ${new Date().toLocaleString()}\n\n`;
        content += `Firma del MÃ©dico: _______________________________________\n\n`;
        content += `Sello del Hospital\n`;
        content += `${'='.repeat(80)}\n`;
      }

      if (type === 'reference') {
        content += `${'='.repeat(80)}\n`;
        content += `${hospitalName.toUpperCase()}\n`;
        content += `REFERENCIA MÃ‰DICA - FORMATO OFICIAL\n`;
        content += `${'='.repeat(80)}\n\n`;
        
        content += `FECHA DE EMISIÃ“N: ${apt.reference_date ? new Date(apt.reference_date).toLocaleDateString() : new Date().toLocaleDateString()}\n`;
        content += `FOLIO: REF-${apt.__backendId || 'N/A'}\n\n`;
        
        content += `DATOS DEL PACIENTE\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Nombre Completo:        ${apt.patient_name}\n`;
        content += `NÃºmero de Identidad:    ${apt.patient_id}\n`;
        content += `Fecha de Nacimiento:    ${apt.patient_birthdate || 'N/A'}\n`;
        content += `Edad:                   ${apt.patient_age} aÃ±os\n`;
        content += `Sexo:                   ______________\n`;
        content += `Departamento:           ${apt.department}\n`;
        content += `Municipio:              ${apt.municipality}\n`;
        content += `Barrio/Aldea:           ${apt.neighborhood || 'N/A'}\n`;
        content += `TelÃ©fono:               ______________________________\n\n`;
        
        content += `HOSPITAL DE ORIGEN\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Nombre:                 ${hospitalName}\n`;
        content += `MÃ©dico que Refiere:     ${apt.doctor_name}\n`;
        content += `Especialidad:           ${apt.specialty}\n`;
        content += `Fecha de Consulta:      ${apt.date}\n\n`;
        
        content += `SIGNOS VITALES ACTUALES\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `PresiÃ³n Arterial:       ${apt.triage_blood_pressure}\n`;
        content += `Frecuencia CardÃ­aca:    ${apt.triage_heart_rate} bpm\n`;
        content += `Temperatura:            ${apt.triage_temperature} Â°C\n`;
        content += `SaturaciÃ³n Oâ‚‚:          ${apt.triage_oxygen}%\n`;
        content += `Peso:                   ${apt.triage_weight} kg\n`;
        content += `Altura:                 ${apt.triage_height} cm\n\n`;
        
        content += `DIAGNÃ“STICO ACTUAL\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `${apt.diagnosis}\n\n`;
        
        content += `SE REFIERE A:\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Hospital/Centro:        ${apt.reference_hospital}\n`;
        content += `Especialidad Solicitada: ______________________________\n`;
        content += `Urgencia:               [  ] Urgente    [  ] Programada\n\n`;
        
        content += `MOTIVO DE LA REFERENCIA\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `${apt.reference_reason}\n\n`;
        
        content += `TRATAMIENTO RECIBIDO HASTA LA FECHA\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `_________________________________________________________________________\n`;
        content += `_________________________________________________________________________\n`;
        content += `_________________________________________________________________________\n\n`;
        
        content += `ESTUDIOS Y RESULTADOS ADJUNTOS\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `[  ] Laboratorios        [  ] RadiografÃ­as       [  ] Ultrasonido\n`;
        content += `[  ] Electrocardiograma  [  ] TAC                [  ] Resonancia\n`;
        content += `[  ] Otros: _________________________________________________________\n\n`;
        
        content += `${'='.repeat(80)}\n`;
        content += `DATOS DEL MÃ‰DICO QUE REFIERE\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Nombre:                 ${apt.doctor_name}\n`;
        content += `Especialidad:           ${apt.specialty}\n`;
        content += `CÃ³digo MÃ©dico:          ______________________________\n`;
        content += `TelÃ©fono de Contacto:   ______________________________\n\n`;
        content += `Firma: _____________________________   Sello: ___________________\n\n`;
        
        content += `${'='.repeat(80)}\n`;
        content += `PARA SER LLENADO POR EL HOSPITAL RECEPTOR\n`;
        content += `${'-'.repeat(80)}\n`;
        content += `Fecha de RecepciÃ³n:     _____/_____/_________\n`;
        content += `MÃ©dico que Recibe:      ______________________________\n`;
        content += `Especialidad:           ______________________________\n`;
        content += `Fecha de Consulta:      _____/_____/_________\n`;
        content += `Observaciones:          ______________________________\n`;
        content += `                        ______________________________\n`;
        content += `                        ______________________________\n\n`;
        content += `Firma y Sello: _________________________________________________\n`;
        content += `${'='.repeat(80)}\n\n`;
        
        content += `NOTA: Esta referencia es vÃ¡lida por 30 dÃ­as a partir de su emisiÃ³n.\n`;
        content += `      El paciente debe presentar este documento junto con su\n`;
        content += `      identificaciÃ³n personal en el hospital receptor.\n`;
        content += `${'='.repeat(80)}\n`;
      }

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${type}_${apt.patient_name.replace(/\s+/g, '_')}_${apt.date}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Documento PDF descargado exitosamente', 'success');
    }

    function generatePDFLink() {
      const aptId = document.getElementById('print-apt-id').value;
      const type = document.getElementById('print-type').value;
      
      const link = `${window.location.origin}${window.location.pathname}?pdf=${aptId}&type=${type}`;
      
      const tempInput = document.createElement('input');
      tempInput.value = link;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);
      
      showToast('Enlace PDF copiado al portapapeles', 'success');
    }

    // Appointment Actions
    async function cancelAppointment(id, btnElem) {
      const apt = appointments.find(a => a.__backendId === id);
      if (apt) {
        const btn = btnElem || (typeof event !== 'undefined' && event.target) || document.activeElement;
        if (btn.dataset.confirming !== 'true') {
          btn.dataset.confirming = 'true';
          btn.textContent = 'Â¿Confirmar?';
          setTimeout(() => {
            btn.dataset.confirming = 'false';
            btn.textContent = 'Cancelar';
          }, 3000);
          return;
        }

        const result = await window.dataSdk.update({ ...apt, status: 'cancelada' });
        if (result.isOk) {
          showToast('Cita cancelada', 'success');
        }
      }
    }

    // Reassign Modal
    function openReassignModal(id) {
      const apt = appointments.find(a => a.__backendId === id);
      if (!apt) return;
      
      document.getElementById('reassign-id').value = id;
      
      // Populate doctor selection dropdown
      const reassignDoctorSelect = document.getElementById('reassign-doctor-select');
      if (reassignDoctorSelect) {
        reassignDoctorSelect.innerHTML = '<option value="">Seleccione nuevo doctor...</option>';
        doctors.forEach(doc => {
          const isCurrentDoctor = doc.__backendId === apt.doctor_id ? ' (Doctor Actual)' : '';
          reassignDoctorSelect.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name} - ${doc.specialty}${isCurrentDoctor}</option>`;
        });
      }
      
      document.getElementById('reassign-modal').classList.remove('hidden');
      document.getElementById('reassign-modal').classList.add('flex');
    }

    async function confirmReassign() {
      const id = document.getElementById('reassign-id').value;
      const apt = appointments.find(a => a.__backendId === id);
      
      if (apt) {
        const newDate = document.getElementById('reassign-date').value;
        const newTime = document.getElementById('reassign-time').value;
        const newDoctorId = document.getElementById('reassign-doctor-select')?.value || apt.doctor_id;
        const newDoctor = doctors.find(d => d.__backendId === newDoctorId);
        
        if (!newDate || !newTime) {
          showToast('Por favor seleccione fecha y hora', 'error');
          return;
        }
        
        // Store original date/time if not already reassigned
        const originalDate = apt.reassigned ? apt.original_date : apt.date;
        const originalTime = apt.reassigned ? apt.original_time : apt.time;
        const originalDoctorId = apt.reassigned ? apt.original_doctor_id : apt.doctor_id;
        const originalDoctorName = apt.reassigned ? apt.original_doctor_name : apt.doctor_name;
        
        const updatedApt = {
          ...apt,
          date: newDate,
          time: newTime,
          doctor_id: newDoctorId,
          doctor_name: newDoctor ? newDoctor.doctor_name : apt.doctor_name,
          specialty: newDoctor ? newDoctor.specialty : apt.specialty,
          reassigned: true,
          original_date: originalDate,
          original_time: originalTime,
          original_doctor_id: originalDoctorId,
          original_doctor_name: originalDoctorName,
          reassigned_date: new Date().toISOString()
        };
        
        let result;
        if (window.dataSdk && typeof window.dataSdk.update === 'function') {
          result = await window.dataSdk.update(updatedApt);
        } else {
          const idx = appointments.findIndex(a => a.__backendId === updatedApt.__backendId);
          if (idx !== -1) appointments[idx] = updatedApt;
          else appointments.push(updatedApt);
          saveAllToLocal();
          try { dataHandler.onDataChanged([...(doctors||[]), ...(appointments||[]), ...(expenses||[]), ...(settings? [settings] : [])]); } catch (e) { /* ignore */ }
          result = { isOk: true };
        }
        
        if (result && result.isOk) {
          closeModal('reassign-modal');
          showToast('âœ… Cita reasignada exitosamente', 'success');
          
          // Ask if user wants to send confirmation message
          setTimeout(() => {
            if (apt.patient_phone) {
              if (confirm('Â¿Desea enviar mensaje de confirmaciÃ³n al paciente?')) {
                whatsappPatient(apt.patient_phone.replace(/[^0-9]/g, ''), apt.patient_name, newDate, newTime);
              }
            }
          }, 500);
        } else {
          showToast('Error al reasignar cita', 'error');
        }
      }
    }

    // Render Reassign List
    function renderReassignList() {
      const list = document.getElementById('reassign-list');
      const filtered = getFilteredReassignList();
      
      document.getElementById('reassign-count').textContent = `${filtered.length} cita(s) encontrada(s)`;
      
      // Update doctor filter
      const doctorFilter = document.getElementById('reassign-filter-doctor');
      const currentDoctorValue = doctorFilter.value;
      doctorFilter.innerHTML = '<option value="">Todos los doctores</option>';
      doctors.forEach(doc => {
        doctorFilter.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name}</option>`;
      });
      doctorFilter.value = currentDoctorValue;
      
      if (filtered.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay citas que mostrar</p>';
        return;
      }

      list.innerHTML = filtered.map(apt => {
        const bgColor = apt.reassigned ? 'bg-amber-600/20 border-amber-500' : 'bg-slate-700 border-slate-600';
        const reassignedBadge = apt.reassigned ? `<span class="text-xs bg-amber-600 px-2 py-1 rounded">âœ¨ Reasignada desde ${apt.original_date} ${apt.original_time}</span>` : '';
        const originalDoctorInfo = apt.reassigned ? `<p class="text-xs text-slate-400">MÃ©dico anterior: ${apt.original_doctor_name || 'N/A'}</p>` : '';
        
        return `
          <div class="rounded-lg p-3 border ${bgColor}">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold">${apt.patient_name}</h3>
                  ${apt.reassigned ? '<span class="text-xs bg-orange-600 text-orange-100 px-2 py-0.5 rounded">REASIGNADA</span>' : ''}
                </div>
                <p class="text-sm text-slate-400">${apt.patient_id} | ${apt.patient_age} aÃ±os</p>
                <p class="text-xs text-slate-400">${apt.department}, ${apt.municipality}</p>
                ${apt.patient_phone ? `<p class="text-xs text-green-400">ğŸ“ ${apt.patient_phone}</p>` : ''}
                <p class="text-xs text-emerald-400 mt-1">ğŸ‘¨â€âš•ï¸ ${apt.doctor_name} - ${apt.specialty}</p>
                ${originalDoctorInfo}
                ${reassignedBadge}
              </div>
              <div class="text-right">
                <p class="font-medium text-lg">${apt.date}</p>
                <p class="text-sm text-slate-400">${apt.time}</p>
                ${apt.reassigned && apt.reassigned_date ? `<p class="text-xs text-amber-400">Reasignada: ${new Date(apt.reassigned_date).toLocaleDateString()}</p>` : ''}
              </div>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2 flex-wrap">
              <button onclick="openReassignModal('${apt.__backendId}')" class="text-xs bg-amber-600 hover:bg-amber-700 px-3 py-2 rounded">
                ğŸ”„ Reasignar
              </button>
              ${apt.patient_phone ? `
                <button onclick="whatsappPatient('${apt.patient_phone.replace(/[^0-9]/g, '')}', '${apt.patient_name}', '${apt.date}', '${apt.time}')" class="text-xs bg-green-600 hover:bg-green-700 px-3 py-2 rounded">
                  ğŸ’¬ Mensaje
                </button>
                <button onclick="callPatient('${apt.patient_phone.replace(/[^0-9]/g, '')}')" class="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded">
                  ğŸ“ Llamar
                </button>
              ` : ''}
              ${!apt.reassigned ? `
                <button onclick="printAppointmentTicket('${apt.__backendId}')" class="text-xs bg-purple-600 hover:bg-purple-700 px-3 py-2 rounded">
                  ğŸ« Ticket
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Get Filtered Reassign List
    function getFilteredReassignList() {
      const search = document.getElementById('reassign-search')?.value?.toLowerCase() || '';
      const doctorFilter = document.getElementById('reassign-filter-doctor')?.value || '';
      const dateFilter = document.getElementById('reassign-filter-date')?.value || '';
      
      return appointments.filter(apt => {
        if (apt.status === 'cancelada') return false;
        
        const matchesSearch = apt.patient_name.toLowerCase().includes(search) || 
                             apt.patient_id.includes(search);
        const matchesDoctor = !doctorFilter || apt.doctor_id === doctorFilter;
        const matchesDate = !dateFilter || apt.date === dateFilter;
        
        return matchesSearch && matchesDoctor && matchesDate;
      }).sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    // Filter Reassign List
    function filterReassignList() {
      renderReassignList();
    }

    // Call Patient
    function callPatient(phone) {
      if (!phone) {
        showToast('No hay nÃºmero de telÃ©fono registrado', 'error');
        return;
      }
      window.open(`tel:+504${phone}`, '_blank');
      showToast('Abriendo aplicaciÃ³n de llamadas...', 'info');
    }

    // WhatsApp Patient
    function whatsappPatient(phone, name, date, time) {
      if (!phone) {
        showToast('No hay nÃºmero de telÃ©fono registrado', 'error');
        return;
      }
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const fechaActualizacion = new Date().toLocaleString('es-HN', { hour12: false });
      const message = `Hola ${name},\n\nâœ… Su cita mÃ©dica ha sido confirmada para el dÃ­a ${date} a las ${time} en ${hospitalName}.\n\nFecha de actualizaciÃ³n: ${fechaActualizacion}\n\nPor favor confirme su asistencia respondiendo este mensaje.\n\nÂ¡Gracias!`;
      const encodedMessage = encodeURIComponent(message);
      window.open(`https://wa.me/504${phone}?text=${encodedMessage}`, '_blank');
      showToast('Abriendo WhatsApp...', 'success');
    }
    
    // Contact All Reassign - Send messages to all patients
    function contactAllReassign() {
      const filtered = getFilteredReassignList();
      const withPhone = filtered.filter(apt => apt.patient_phone);
      if (withPhone.length === 0) {
        showToast('No hay pacientes con telÃ©fono registrado', 'error');
        return;
      }
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      let sentCount = 0;
      if (!confirm(`Â¿Enviar mensajes de confirmaciÃ³n a ${withPhone.length} paciente(s) por WhatsApp?`)) {
        return;
      }
      withPhone.forEach((apt, index) => {
        setTimeout(() => {
          const phone = apt.patient_phone.replace(/[^0-9]/g, '');
          const fechaActualizacion = new Date().toLocaleString('es-HN', { hour12: false });
          const message = `Hola ${apt.patient_name},\n\nâœ… Su cita mÃ©dica ha sido confirmada para el dÃ­a ${apt.date} a las ${apt.time} en ${hospitalName}.\nğŸ‘¨â€âš•ï¸ Doctor: ${apt.doctor_name}\n${apt.reassigned ? '\nâœ¨ Su cita ha sido reasignada.' : ''}\n\nFecha de actualizaciÃ³n: ${fechaActualizacion}\n\nPor favor confirme su asistencia respondiendo este mensaje.\n\nÂ¡Gracias!`;
          const encodedMessage = encodeURIComponent(message);
          window.open(`https://wa.me/504${phone}?text=${encodedMessage}`, '_blank');
          sentCount++;
        }, index * 1500);
      });
      showToast(`ğŸ“± Enviando ${withPhone.length} mensaje(s) de confirmaciÃ³n...`, 'success');
    }

    // Auto Reassign All - Show doctor selection dialog
    async function autoReassignAll(btnElem) {
      const filtered = getFilteredReassignList();
      
      if (filtered.length === 0) {
        showToast('No hay citas para reasignar', 'error');
        return;
      }
      
      // Create a modal to select target doctor
      const doctorOptions = doctors.map(doc => 
        `<option value="${doc.__backendId}">${doc.doctor_name} - ${doc.specialty}</option>`
      ).join('');
      
      if (doctorOptions === '') {
        showToast('No hay doctores disponibles', 'error');
        return;
      }
      
      // Show a prompt or dialog to select doctor
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4';
      modal.innerHTML = `
        <div class="bg-slate-800 rounded-xl max-w-md w-full animate-slide">
          <div class="p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ”„ Reasignar ${filtered.length} Cita(s)</h2>
            <p class="text-slate-300 mb-4">Seleccione el doctor a quien reasignar las citas:</p>
            <select id="bulk-reassign-doctor" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 mb-4">
              <option value="">-- Seleccione doctor --</option>
              ${doctorOptions}
            </select>
            <div class="flex gap-2">
              <button onclick="performBulkReassign('${filtered.map(a => a.__backendId).join(',')}')" class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-medium">
                Reasignar a Todos
              </button>
              <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-slate-600 hover:bg-slate-500 py-3 rounded-lg font-medium">
                Cancelar
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    async function performBulkReassign(aptIds) {
      const doctorSelect = document.getElementById('bulk-reassign-doctor');
      const selectedDoctorId = doctorSelect?.value;
      
      if (!selectedDoctorId) {
        showToast('Por favor seleccione un doctor', 'error');
        return;
      }
      
      const selectedDoctor = doctors.find(d => d.__backendId === selectedDoctorId);
      if (!selectedDoctor) {
        showToast('Doctor no encontrado', 'error');
        return;
      }
      
      const aptIdArray = aptIds.split(',');
      const toReasign = appointments.filter(a => aptIdArray.includes(a.__backendId));
      
      // Close the selection modal
      document.querySelector('.fixed').remove();
      
      let successCount = 0;
      let errorCount = 0;
      const confirmedApts = [];
      
      for (const apt of toReasign) {
        try {
          const availableDays = selectedDoctor.doctor_available_days ? JSON.parse(selectedDoctor.doctor_available_days) : [1,2,3,4,5];
          const vacations = selectedDoctor.doctor_vacations ? JSON.parse(selectedDoctor.doctor_vacations) : [];
          const maxSlots = selectedDoctor.doctor_max_appointments || 10;
          
          // Start searching from 7 days from now
          const startDate = new Date();
          startDate.setDate(startDate.getDate() + 7);
          
          let foundSlot = false;
          let searchDate = new Date(startDate);
          let newDate = '';
          
          // Search for up to 90 days
          for (let i = 0; i < 90 && !foundSlot; i++) {
            const dateStr = searchDate.toISOString().split('T')[0];
            const dayOfWeek = searchDate.getDay();
            
            // Skip weekends
            if (dayOfWeek === 0 || dayOfWeek === 6) {
              searchDate.setDate(searchDate.getDate() + 1);
              continue;
            }
            
            // Check if available day
            const isAvailableDay = availableDays.includes(dayOfWeek);
            
            // Check vacations
            const isVacation = vacations.some(v => dateStr >= v.start && dateStr <= v.end);
            
            if (isAvailableDay && !isVacation) {
              const dayApts = appointments.filter(a => 
                a.date === dateStr && 
                a.doctor_id === selectedDoctorId && 
                a.status !== 'cancelada' &&
                a.__backendId !== apt.__backendId
              );
              const available = maxSlots - dayApts.length;
              
              if (available > 0) {
                newDate = dateStr;
                foundSlot = true;
              }
            }
            
            searchDate.setDate(searchDate.getDate() + 1);
          }
          
          if (foundSlot) {
            // Store original info if not already reassigned
            const originalDate = apt.reassigned ? apt.original_date : apt.date;
            const originalTime = apt.reassigned ? apt.original_time : apt.time;
            const originalDoctorId = apt.reassigned ? apt.original_doctor_id : apt.doctor_id;
            const originalDoctorName = apt.reassigned ? apt.original_doctor_name : apt.doctor_name;
            
            const updatedApt = {
              ...apt,
              date: newDate,
              time: apt.time, // Keep original time
              doctor_id: selectedDoctorId,
              doctor_name: selectedDoctor.doctor_name,
              specialty: selectedDoctor.specialty,
              reassigned: true,
              original_date: originalDate,
              original_time: originalTime,
              original_doctor_id: originalDoctorId,
              original_doctor_name: originalDoctorName,
              reassigned_date: new Date().toISOString()
            };
            
            let result;
            if (window.dataSdk && typeof window.dataSdk.update === 'function') {
              result = await window.dataSdk.update(updatedApt);
            } else {
              const idx = appointments.findIndex(a => a.__backendId === updatedApt.__backendId);
              if (idx !== -1) {
                appointments[idx] = updatedApt;
              } else {
                appointments.push(updatedApt);
              }
              saveAllToLocal();
              try { dataHandler.onDataChanged([...(doctors||[]), ...(appointments||[]), ...(expenses||[]), ...(settings? [settings] : [])]); } catch (e) { /* ignore */ }
              result = { isOk: true };
            }
            
            if (result && result.isOk) {
              successCount++;
              confirmedApts.push(apt);
            } else {
              errorCount++;
            }
          } else {
            errorCount++;
          }
          
        } catch (error) {
          errorCount++;
        }
      }
      
      if (successCount > 0) {
        showToast(`âœ… ${successCount} cita(s) reasignada(s) exitosamente${errorCount > 0 ? ` (${errorCount} error(es))` : ''}`, 'success');
        
        // Ask if user wants to send confirmation messages
        setTimeout(() => {
          const withPhone = confirmedApts.filter(apt => apt.patient_phone);
          if (withPhone.length > 0 && confirm(`Â¿Desea enviar mensajes de confirmaciÃ³n a ${withPhone.length} paciente(s)?`)) {
            contactAllReassign();
          }
        }, 500);
      } else {
        showToast(`âŒ No se pudieron reasignar las citas. ${errorCount} error(es).`, 'error');
      }
    }

    // Mora QuirÃºrgica Analysis
    function renderMoraAnalysis() {
      const moraList = document.getElementById('mora-list');
      const waitingAppts = appointments.filter(a => a.status === 'programada' && a.surgical_delay > 0);
      
      const total = waitingAppts.length;
      const avgDelay = total > 0 ? Math.round(waitingAppts.reduce((sum, a) => sum + a.surgical_delay, 0) / total) : 0;
      const critical = waitingAppts.filter(a => a.surgical_delay > 60).length;
      
      document.getElementById('mora-total').textContent = total;
      document.getElementById('mora-average').textContent = avgDelay;
      document.getElementById('mora-critical').textContent = critical;
      
      if (waitingAppts.length === 0) {
        moraList.innerHTML = '<p class="text-slate-400 text-center py-8">No hay pacientes en espera quirÃºrgica</p>';
        return;
      }

      const sorted = waitingAppts.sort((a, b) => b.surgical_delay - a.surgical_delay);
      
      moraList.innerHTML = sorted.map(apt => {
        const isCritical = apt.surgical_delay > 60;
        const bgColor = isCritical ? 'border-red-500 bg-red-600/20' : 'border-amber-500 bg-amber-600/20';
        
        return `
          <div class="rounded-lg p-3 border ${bgColor}">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold">${apt.patient_name}</h3>
                <p class="text-sm text-slate-400">${apt.specialty} | ${apt.patient_age} aÃ±os</p>
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold ${isCritical ? 'text-red-400' : 'text-amber-400'}">${apt.surgical_delay}</p>
                <p class="text-xs text-slate-400">dÃ­as de espera</p>
              </div>
            </div>
            <div class="mt-2 text-sm text-slate-400">
              Fecha programada: ${apt.date} | Doctor: ${apt.doctor_name}
            </div>
          </div>
        `;
      }).join('');
    }

    // Toast Notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600';
      toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 animate-slide`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Custom Data: save to localStorage and optionally to dataSdk, and render
    function loadCustomData() {
      try {
        const raw = localStorage.getItem('customData');
        return raw ? JSON.parse(raw) : [];
      } catch (e) {
        return [];
      }
    }

    function getSdkCustomEntries() {
      try {
        if (!allData || !Array.isArray(allData)) return [];
        return allData.filter(d => d.type === 'custom_entry').map(d => ({ id: d.__backendId, value: d.value }));
      } catch (e) {
        return [];
      }
    }

    function renderCustomDataList() {
      const list = document.getElementById('custom-data-list');
      if (!list) return;

      const sdkItems = getSdkCustomEntries();
      const localItems = loadCustomData();

      if (sdkItems.length === 0 && localItems.length === 0) {
        list.innerHTML = '<p class="text-slate-500">No hay datos guardados</p>';
        return;
      }

      const sdkHtml = sdkItems.map(item => `
        <div class="flex items-center justify-between bg-slate-700 rounded px-3 py-1 mb-1">
          <span>${item.value} <span class="text-xs text-slate-400">(en servidor)</span></span>
          <button onclick="deleteCustomDataSdk('${item.id}')" class="text-red-400 hover:text-red-300">âœ•</button>
        </div>
      `).join('');

      const localHtml = localItems.map((it, i) => `
        <div class="flex items-center justify-between bg-slate-700 rounded px-3 py-1 mb-1">
          <span>${it}</span>
          <button onclick="removeCustomData(${i})" class="text-red-400 hover:text-red-300">âœ•</button>
        </div>
      `).join('');

      list.innerHTML = sdkHtml + localHtml;
    }

    async function saveCustomData() {
      const input = document.getElementById('custom-input');
      if (!input) return;
      const val = input.value.trim();
      if (!val) return;

      // Always save locally
      const items = loadCustomData();
      items.unshift(val);
      localStorage.setItem('customData', JSON.stringify(items));

      // Also try to save to dataSdk if available
      if (window.dataSdk && typeof window.dataSdk.create === 'function') {
        try {
          const payload = { type: 'custom_entry', value: val, created_at: new Date().toISOString() };
          const result = await window.dataSdk.create(payload);
          if (result && result.isOk) {
            showToast('Dato guardado en servidor y en local', 'success');
          } else {
            showToast('Guardado solo en local (error en servidor)', 'info');
          }
        } catch (e) {
          showToast('Guardado solo en local (no se pudo conectar al servidor)', 'info');
        }
      } else {
        showToast('Dato guardado en local', 'success');
      }

      input.value = '';
      renderCustomDataList();
    }

    function removeCustomData(index) {
      const items = loadCustomData();
      if (index < 0 || index >= items.length) return;
      items.splice(index, 1);
      localStorage.setItem('customData', JSON.stringify(items));
      renderCustomDataList();
      showToast('Dato eliminado (local)', 'success');
    }

    async function deleteCustomDataSdk(id) {
      if (!window.dataSdk || typeof window.dataSdk.delete !== 'function') {
        showToast('No hay conexiÃ³n al servidor', 'error');
        return;
      }

      const entry = allData.find(d => d.__backendId === id || String(d.__backendId) === String(id));
      if (!entry) {
        showToast('Entrada no encontrada en servidor', 'error');
        return;
      }

      const result = await window.dataSdk.delete(entry);
      if (result && result.isOk) {
        showToast('Dato eliminado del servidor', 'success');
        // dataSdk update will trigger dataHandler and re-render; but ensure local list updated too
        renderCustomDataList();
      } else {
        showToast('Error al eliminar en servidor', 'error');
      }
    }

    function clearCustomData() {
      localStorage.removeItem('customData');
      renderCustomDataList();
      showToast('Datos locales limpiados', 'success');
    }

    // Add Sample Doctors (only if database is empty)
    async function addSampleDoctorsIfNeeded() {
      // Only add sample doctors if there are no doctors in the database
      if (doctors.length === 0) {
        const sampleDoctors = [
          {
            type: 'doctor',
            doctor_name: 'Dr. Carlos HernÃ¡ndez',
            specialty: 'Medicina General',
            doctor_email: 'carlos.hernandez@hospital.hn',
            doctor_max_appointments: 12,
            doctor_available_days: JSON.stringify([1, 2, 3, 4, 5]),
            doctor_vacations: JSON.stringify([]),
            doctor_services: JSON.stringify([
              { name: 'Consulta General', price: 150 },
              { name: 'Control de PresiÃ³n', price: 100 },
              { name: 'RevisiÃ³n de Rutina', price: 120 }
            ]),
            created_at: new Date().toISOString()
          },
          {
            type: 'doctor',
            doctor_name: 'Dra. MarÃ­a GonzÃ¡lez',
            specialty: 'PediatrÃ­a',
            doctor_email: 'maria.gonzalez@hospital.hn',
            doctor_max_appointments: 10,
            doctor_available_days: JSON.stringify([1, 2, 3, 4, 5]),
            doctor_vacations: JSON.stringify([]),
            doctor_services: JSON.stringify([
              { name: 'Consulta PediÃ¡trica', price: 180 },
              { name: 'Control de NiÃ±o Sano', price: 150 },
              { name: 'VacunaciÃ³n', price: 200 }
            ]),
            created_at: new Date().toISOString()
          },
          {
            type: 'doctor',
            doctor_name: 'Dr. Roberto MartÃ­nez',
            specialty: 'CirugÃ­a General',
            doctor_email: 'roberto.martinez@hospital.hn',
            doctor_max_appointments: 8,
            doctor_available_days: JSON.stringify([1, 3, 5]),
            doctor_vacations: JSON.stringify([]),
            doctor_services: JSON.stringify([
              { name: 'Consulta QuirÃºrgica', price: 250 },
              { name: 'EvaluaciÃ³n Pre-operatoria', price: 200 },
              { name: 'Control Post-operatorio', price: 180 }
            ]),
            created_at: new Date().toISOString()
          },
          {
            type: 'doctor',
            doctor_name: 'Dra. Ana Patricia LÃ³pez',
            specialty: 'GinecologÃ­a',
            doctor_email: 'ana.lopez@hospital.hn',
            doctor_max_appointments: 10,
            doctor_available_days: JSON.stringify([1, 2, 3, 4, 5]),
            doctor_vacations: JSON.stringify([]),
            doctor_services: JSON.stringify([
              { name: 'Consulta GinecolÃ³gica', price: 220 },
              { name: 'Control Prenatal', price: 200 },
              { name: 'Papanicolaou', price: 180 }
            ]),
            created_at: new Date().toISOString()
          },
          {
            type: 'doctor',
            doctor_name: 'Dr. Luis Fernando Reyes',
            specialty: 'CardiologÃ­a',
            doctor_email: 'luis.reyes@hospital.hn',
            doctor_max_appointments: 8,
            doctor_available_days: JSON.stringify([2, 4, 5]),
            doctor_vacations: JSON.stringify([]),
            doctor_services: JSON.stringify([
              { name: 'Consulta CardiolÃ³gica', price: 300 },
              { name: 'Electrocardiograma', price: 250 },
              { name: 'Control de HipertensiÃ³n', price: 200 }
            ]),
            created_at: new Date().toISOString()
          }
        ];

        // Add all sample doctors
        for (const doctor of sampleDoctors) {
          if (allData.length >= 999) {
            console.warn('Database limit reached, cannot add more sample doctors');
            break;
          }
          if (window.dataSdk && typeof window.dataSdk.create === 'function') {
            const result = await window.dataSdk.create(doctor);
            if (!result.isOk) {
              console.error('Failed to create sample doctor:', doctor.doctor_name);
            }
          } else {
            // Fallback: add locally
            const localId = 'local-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            const newDoc = { ...doctor, __backendId: localId };
            doctors.push(newDoc);
            allData.push({ ...newDoc, type: 'doctor' });
          }
        }
        // If persisted locally, save
        try { saveAllToLocal(); } catch (e) { /* ignore */ }
        showToast('5 mÃ©dicos de muestra agregados exitosamente', 'success');
      }
    }

    // Initialize on load
    init();

    // ========== FINANCE FUNCTIONS ==========
    
    // Show Finance Tab
    function showFinanceTab(tab) {
      document.querySelectorAll('.finance-tab').forEach(btn => {
        btn.classList.remove('border-emerald-600', 'text-emerald-400');
        btn.classList.add('border-transparent', 'text-slate-400');
      });
      
      document.querySelectorAll('.finance-tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      
      document.querySelector(`[data-tab="${tab}"]`).classList.remove('border-transparent', 'text-slate-400');
      document.querySelector(`[data-tab="${tab}"]`).classList.add('border-emerald-600', 'text-emerald-400');
      document.getElementById(`finance-tab-${tab}`).classList.remove('hidden');
    }
    
    // Render Finance Summary
    function renderFinanceSummary() {
      // Calculate income (completed payments)
      const completedPayments = appointments.filter(a => a.payment_status === 'completado');
      const totalIncome = completedPayments.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      
      // Calculate pending payments
      const pendingPayments = appointments.filter(a => a.payment_status === 'pendiente' && a.payment_amount > 0);
      const totalPending = pendingPayments.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      
      // Calculate expenses
      const totalExpenses = expenses.reduce((sum, e) => sum + (e.payment_amount || 0), 0);
      
      // Calculate balance
      const balance = totalIncome - totalExpenses;
      
      // Update summary cards
      document.getElementById('total-income').textContent = `L.${totalIncome.toFixed(2)}`;
      document.getElementById('total-expenses').textContent = `L.${totalExpenses.toFixed(2)}`;
      document.getElementById('net-balance').textContent = `L.${balance.toFixed(2)}`;
      document.getElementById('pending-payments').textContent = `L.${totalPending.toFixed(2)}`;
      
      // Update balance card color
      const balanceCard = document.getElementById('balance-card');
      if (balance >= 0) {
        balanceCard.className = 'bg-gradient-to-br from-blue-600 to-blue-700 rounded-xl p-4 border border-blue-500';
      } else {
        balanceCard.className = 'bg-gradient-to-br from-red-600 to-red-700 rounded-xl p-4 border border-red-500';
      }
    }
    
    // Render Payments List
    function renderPaymentsList() {
      const list = document.getElementById('payments-list');
      const filtered = getFilteredPayments();
      
      // Update payment doctor filter
      const doctorFilter = document.getElementById('filter-payment-doctor');
      if (doctorFilter) {
        const currentValue = doctorFilter.value;
        doctorFilter.innerHTML = '<option value="">Todos los doctores</option>';
        doctors.forEach(doc => {
          doctorFilter.innerHTML += `<option value="${doc.__backendId}">${doc.doctor_name}</option>`;
        });
        doctorFilter.value = currentValue;
      }
      
      // Update stats
      const completed = filtered.filter(a => a.payment_status === 'completado');
      const pending = filtered.filter(a => a.payment_status === 'pendiente');
      const today = new Date().toISOString().split('T')[0];
      const todayPayments = completed.filter(a => a.payment_date && a.payment_date.startsWith(today));
      
      const totalCompleted = completed.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      const totalPending = pending.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      const totalToday = todayPayments.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      
      document.getElementById('payments-completed').textContent = `L.${totalCompleted.toFixed(2)}`;
      document.getElementById('payments-pending').textContent = `L.${totalPending.toFixed(2)}`;
      document.getElementById('payments-today').textContent = `L.${totalToday.toFixed(2)}`;
      document.getElementById('payments-count').textContent = completed.length;
      
      if (filtered.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay pagos registrados</p>';
        return;
      }
      
      list.innerHTML = filtered.map(apt => {
        const isPaid = apt.payment_status === 'completado';
        const bgColor = isPaid ? 'bg-green-600/20 border-green-500' : 'bg-amber-600/20 border-amber-500';
        const statusBadge = isPaid ? '<span class="text-xs bg-green-600 px-2 py-1 rounded">PAGADO</span>' : '<span class="text-xs bg-amber-600 px-2 py-1 rounded">PENDIENTE</span>';
        
        return `
          <div class="rounded-lg p-3 border ${bgColor}">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h3 class="font-semibold">${apt.patient_name}</h3>
                <p class="text-sm text-slate-400">${apt.patient_id} | ${apt.date}</p>
                <p class="text-xs text-emerald-400">${apt.doctor_name} - ${apt.specialty}</p>
                ${apt.diagnosis ? `<p class="text-xs text-slate-400 mt-1">${apt.diagnosis.substring(0, 60)}...</p>` : ''}
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold ${isPaid ? 'text-green-400' : 'text-amber-400'}">L.${(apt.payment_amount || 0).toFixed(2)}</p>
                ${statusBadge}
                ${isPaid && apt.payment_date ? `<p class="text-xs text-slate-400 mt-1">${new Date(apt.payment_date).toLocaleDateString()}</p>` : ''}
              </div>
            </div>
            <div class="mt-2 flex gap-2">
              <button onclick="generateInvoice('${apt.__backendId}')" class="text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded">
                ğŸ§¾ Generar Factura
              </button>
              ${!isPaid && apt.payment_amount > 0 ? `
                <button onclick="markAsPaid('${apt.__backendId}', this)" class="text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded">
                  âœ… Marcar como Pagado
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Get Filtered Payments
    function getFilteredPayments() {
      const search = document.getElementById('filter-payment-patient')?.value?.toLowerCase() || '';
      const doctorFilter = document.getElementById('filter-payment-doctor')?.value || '';
      const statusFilter = document.getElementById('filter-payment-status')?.value || '';
      const dateFrom = document.getElementById('filter-payment-from')?.value || '';
      const dateTo = document.getElementById('filter-payment-to')?.value || '';
      
      return appointments.filter(apt => {
        if (apt.payment_amount <= 0) return false;
        
        const matchesSearch = apt.patient_name.toLowerCase().includes(search);
        const matchesDoctor = !doctorFilter || apt.doctor_id === doctorFilter;
        const matchesStatus = !statusFilter || apt.payment_status === statusFilter;
        const matchesDateFrom = !dateFrom || apt.date >= dateFrom;
        const matchesDateTo = !dateTo || apt.date <= dateTo;
        
        return matchesSearch && matchesDoctor && matchesStatus && matchesDateFrom && matchesDateTo;
      }).sort((a, b) => new Date(b.date) - new Date(a.date));
    }
    
    // Filter Payments
    function filterPayments() {
      renderPaymentsList();
    }
    
    // Mark Payment as Paid
    async function markAsPaid(aptId, btnElem) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      
      const btn = btnElem || (typeof event !== 'undefined' && event.target) || document.activeElement;
      btn.disabled = true;
      btn.textContent = 'Procesando...';
      
      const result = await window.dataSdk.update({
        ...apt,
        payment_status: 'completado',
        payment_date: new Date().toISOString()
      });
      
      btn.disabled = false;
      btn.textContent = 'âœ… Marcar como Pagado';
      
      if (result.isOk) {
        showToast('Pago registrado exitosamente', 'success');
      } else {
        showToast('Error al registrar pago', 'error');
      }
    }
    
    // Generate Invoice
    function generateInvoice(aptId) {
      const apt = appointments.find(a => a.__backendId === aptId);
      if (!apt) return;
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const invoiceNumber = `INV-${aptId.substring(0, 8).toUpperCase()}`;
      const invoiceDate = apt.payment_date ? new Date(apt.payment_date).toLocaleDateString() : new Date().toLocaleDateString();
      
      const invoiceHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Factura ${invoiceNumber}</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { text-align: center; border-bottom: 3px solid #059669; padding-bottom: 20px; margin-bottom: 30px; }
    .header h1 { margin: 0; color: #059669; }
    .invoice-info { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .box { border: 1px solid #cbd5e1; padding: 15px; border-radius: 8px; }
    .box h3 { margin: 0 0 10px 0; color: #334155; font-size: 14px; }
    .box p { margin: 5px 0; font-size: 13px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #cbd5e1; padding: 12px; text-align: left; }
    th { background: #f1f5f9; font-weight: bold; }
    .total-row { background: #059669; color: white; font-weight: bold; font-size: 16px; }
    .footer { margin-top: 40px; text-align: center; color: #64748b; font-size: 12px; }
    .status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
    .status-paid { background: #10b981; color: white; }
    .status-pending { background: #f59e0b; color: white; }
  </style>
</head>
<body>
  <div class="header">
    <h1>${hospitalName}</h1>
    <p style="margin: 5px 0; color: #64748b;">Sistema de Citas MÃ©dicas</p>
    <p style="margin: 5px 0; color: #64748b;">Factura MÃ©dica</p>
  </div>
  
  <div class="invoice-info">
    <div class="box" style="flex: 1; margin-right: 10px;">
      <h3>INFORMACIÃ“N DEL PACIENTE</h3>
      <p><strong>Nombre:</strong> ${apt.patient_name}</p>
      <p><strong>Identidad:</strong> ${apt.patient_id}</p>
      <p><strong>Edad:</strong> ${apt.patient_age} aÃ±os</p>
      <p><strong>DirecciÃ³n:</strong> ${apt.department}, ${apt.municipality}</p>
    </div>
    <div class="box" style="flex: 1;">
      <h3>INFORMACIÃ“N DE FACTURA</h3>
      <p><strong>No. Factura:</strong> ${invoiceNumber}</p>
      <p><strong>Fecha:</strong> ${invoiceDate}</p>
      <p><strong>Estado:</strong> <span class="status ${apt.payment_status === 'completado' ? 'status-paid' : 'status-pending'}">${apt.payment_status === 'completado' ? 'PAGADO' : 'PENDIENTE'}</span></p>
      <p><strong>Fecha de Cita:</strong> ${apt.date}</p>
    </div>
  </div>
  
  <div class="box" style="margin-bottom: 20px;">
    <h3>SERVICIO MÃ‰DICO</h3>
    <p><strong>Doctor:</strong> ${apt.doctor_name}</p>
    <p><strong>Especialidad:</strong> ${apt.specialty}</p>
    ${apt.diagnosis ? `<p><strong>DiagnÃ³stico:</strong> ${apt.diagnosis}</p>` : ''}
  </div>
  
  <table>
    <thead>
      <tr>
        <th>DescripciÃ³n del Servicio</th>
        <th style="width: 100px;">Cantidad</th>
        <th style="width: 150px;">Precio Unitario</th>
        <th style="width: 150px;">Total</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Consulta MÃ©dica - ${apt.specialty}</td>
        <td>1</td>
        <td>L.${(apt.payment_amount || 0).toFixed(2)}</td>
        <td>L.${(apt.payment_amount || 0).toFixed(2)}</td>
      </tr>
      <tr class="total-row">
        <td colspan="3" style="text-align: right;">TOTAL A PAGAR:</td>
        <td>L.${(apt.payment_amount || 0).toFixed(2)}</td>
      </tr>
    </tbody>
  </table>
  
  ${apt.payment_status === 'completado' && apt.payment_date ? `
  <div class="box" style="background: #f0fdf4; border-color: #10b981;">
    <p style="color: #059669; font-weight: bold; margin: 0;">âœ… PAGO COMPLETADO</p>
    <p style="margin: 5px 0;">Fecha de Pago: ${new Date(apt.payment_date).toLocaleString()}</p>
  </div>
  ` : `
  <div class="box" style="background: #fffbeb; border-color: #f59e0b;">
    <p style="color: #d97706; font-weight: bold; margin: 0;">â³ PAGO PENDIENTE</p>
    <p style="margin: 5px 0;">Favor presentar esta factura al realizar el pago</p>
  </div>
  `}
  
  <div class="footer">
    <p>Gracias por confiar en ${hospitalName}</p>
    <p>Este documento es una factura oficial generada por el Sistema de Citas MÃ©dicas</p>
    <p>Generado: ${new Date().toLocaleString()}</p>
  </div>
</body>
</html>
      `;
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('Por favor permita las ventanas emergentes', 'error');
        return;
      }
      
      printWindow.document.write(invoiceHtml);
      printWindow.document.close();
      
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.focus();
          printWindow.print();
        }, 250);
      };
      
      showToast('Factura generada exitosamente', 'success');
    }
    
    // Export Payments PDF
    function exportPaymentsPDF() {
      const filtered = getFilteredPayments();
      if (filtered.length === 0) {
        showToast('No hay pagos para exportar', 'error');
        return;
      }
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const completed = filtered.filter(a => a.payment_status === 'completado');
      const pending = filtered.filter(a => a.payment_status === 'pendiente');
      const totalCompleted = completed.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      const totalPending = pending.reduce((sum, a) => sum + (a.payment_amount || 0), 0);
      
      let htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reporte de Pagos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
    .header { text-align: center; border-bottom: 3px solid #059669; padding-bottom: 15px; margin-bottom: 30px; }
    .header h1 { margin: 0; color: #059669; font-size: 24px; }
    .summary { display: flex; gap: 15px; margin-bottom: 30px; }
    .summary-box { flex: 1; border: 1px solid #cbd5e1; padding: 15px; border-radius: 8px; }
    .summary-box h3 { margin: 0 0 10px 0; font-size: 14px; color: #334155; }
    .summary-box p { margin: 0; font-size: 24px; font-weight: bold; }
    .completed { color: #10b981; }
    .pending { color: #f59e0b; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: left; font-size: 11px; }
    th { background: #f1f5f9; font-weight: bold; }
    .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 11px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>${hospitalName}</h1>
    <h2>Reporte de Pagos e Ingresos</h2>
  </div>
  
  <div class="summary">
    <div class="summary-box">
      <h3>ğŸ’° Total Cobrado</h3>
      <p class="completed">L.${totalCompleted.toFixed(2)}</p>
      <p style="font-size: 12px; color: #64748b; margin-top: 5px;">${completed.length} pagos</p>
    </div>
    <div class="summary-box">
      <h3>â³ Total Pendiente</h3>
      <p class="pending">L.${totalPending.toFixed(2)}</p>
      <p style="font-size: 12px; color: #64748b; margin-top: 5px;">${pending.length} pagos</p>
    </div>
    <div class="summary-box">
      <h3>ğŸ“Š Total General</h3>
      <p style="color: #3b82f6;">L.${(totalCompleted + totalPending).toFixed(2)}</p>
      <p style="font-size: 12px; color: #64748b; margin-top: 5px;">${filtered.length} pagos</p>
    </div>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Paciente</th>
        <th>Doctor</th>
        <th>Especialidad</th>
        <th>Monto</th>
        <th>Estado</th>
      </tr>
    </thead>
    <tbody>
      ${filtered.map(apt => `
        <tr>
          <td>${apt.date}</td>
          <td>${apt.patient_name}<br><small style="color: #64748b;">${apt.patient_id}</small></td>
          <td>${apt.doctor_name}</td>
          <td>${apt.specialty}</td>
          <td style="font-weight: bold;">L.${(apt.payment_amount || 0).toFixed(2)}</td>
          <td><span style="padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; color: white; background: ${apt.payment_status === 'completado' ? '#10b981' : '#f59e0b'};">${apt.payment_status === 'completado' ? 'PAGADO' : 'PENDIENTE'}</span></td>
        </tr>
      `).join('')}
    </tbody>
  </table>
  
  <div class="footer">
    <p>Documento generado: ${new Date().toLocaleString()}</p>
    <p>${hospitalName} - Sistema de Citas MÃ©dicas</p>
  </div>
</body>
</html>
      `;
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('Por favor permita las ventanas emergentes', 'error');
        return;
      }
      
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.focus();
          printWindow.print();
        }, 250);
      };
      
      showToast('Abriendo reporte de pagos...', 'success');
    }
    
    // Export Payments Excel
    function exportPaymentsExcel() {
      const filtered = getFilteredPayments();
      if (filtered.length === 0) {
        showToast('No hay pagos para exportar', 'error');
        return;
      }
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      
      let csv = '\uFEFF';
      csv += `${hospitalName}\n`;
      csv += `Reporte de Pagos e Ingresos\n`;
      csv += `Generado: ${new Date().toLocaleString()}\n\n`;
      
      csv += `No.,Fecha,Paciente,Identidad,Doctor,Especialidad,Monto,Estado,Fecha Pago\n`;
      
      filtered.forEach((apt, i) => {
        const row = [
          i + 1,
          apt.date,
          apt.patient_name,
          apt.patient_id,
          apt.doctor_name,
          apt.specialty,
          (apt.payment_amount || 0).toFixed(2),
          apt.payment_status === 'completado' ? 'PAGADO' : 'PENDIENTE',
          apt.payment_date ? new Date(apt.payment_date).toLocaleDateString() : 'N/A'
        ];
        
        const escapedRow = row.map(field => {
          const stringField = String(field);
          if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return `"${stringField.replace(/"/g, '""')}"`;
          }
          return stringField;
        });
        
        csv += escapedRow.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_pagos_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('ğŸ“Š Excel descargado exitosamente', 'success');
    }
    
    // Save Expense
    async function saveExpense() {
      if (expenses.length >= 999) {
        showToast('LÃ­mite de 999 registros alcanzado', 'error');
        return;
      }
      
      const btn = document.getElementById('save-expense-btn');
      btn.disabled = true;
      btn.textContent = 'Guardando...';
      
      const expenseData = {
        type: 'expense',
        expense_type: document.getElementById('expense-type').value,
        expense_description: document.getElementById('expense-description').value,
        payment_amount: parseFloat(document.getElementById('expense-amount').value) || 0,
        date: document.getElementById('expense-date').value,
        expense_employee: document.getElementById('expense-employee').value || '',
        expense_notes: document.getElementById('expense-notes').value || '',
        created_at: new Date().toISOString()
      };
      try {
        if (window.dataSdk && typeof window.dataSdk.create === 'function') {
          const result = await window.dataSdk.create(expenseData);
          btn.disabled = false;
          btn.textContent = 'Guardar Gasto';
          if (result && result.isOk) {
            document.getElementById('expense-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            showToast('Gasto registrado exitosamente', 'success');
            return;
          } else {
            console.error('dataSdk create expense error', result);
            showToast('Error al registrar gasto (SDK)', 'error');
            return;
          }
        }

        // Fallback: save locally
        const localId = 'local-exp-' + Date.now();
        const toSave = { ...expenseData, __backendId: localId };
        expenses.push(toSave);
        saveAllToLocal();

        btn.disabled = false;
        btn.textContent = 'Guardar Gasto';
        document.getElementById('expense-form').reset();
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expense-date').value = today;
        renderExpensesList();
        renderFinanceSummary();
        showToast('Gasto registrado (local)', 'success');
      } catch (err) {
        console.error('Error saving expense:', err);
        btn.disabled = false;
        btn.textContent = 'Guardar Gasto';
        showToast('Error al registrar gasto', 'error');
      }
    }
    
    // Render Expenses List
    function renderExpensesList() {
      const list = document.getElementById('expenses-list');
      const filtered = getFilteredExpenses();
      
      document.getElementById('expenses-count').textContent = `${filtered.length} gasto(s) encontrado(s)`;
      
      if (filtered.length === 0) {
        list.innerHTML = '<p class="text-slate-400 text-center py-8">No hay gastos registrados</p>';
        return;
      }
      
      const typeLabels = {
        'salarios': 'ğŸ’¼ Salarios',
        'servicios': 'âš¡ Servicios',
        'medicamentos': 'ğŸ’Š Medicamentos',
        'equipo': 'ğŸ¥ Equipo',
        'mantenimiento': 'ğŸ”§ Mantenimiento',
        'limpieza': 'ğŸ§¹ Limpieza',
        'papeleria': 'ğŸ“„ PapelerÃ­a',
        'otros': 'ğŸ“¦ Otros'
      };
      
      list.innerHTML = filtered.map(expense => `
        <div class="bg-slate-700 rounded-lg p-3 border border-slate-600">
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="text-xs bg-slate-600 px-2 py-1 rounded">${typeLabels[expense.expense_type] || expense.expense_type}</span>
                <h3 class="font-semibold text-sm">${expense.expense_description}</h3>
              </div>
              <p class="text-xs text-slate-400 mt-1">${expense.date}</p>
              ${expense.expense_employee ? `<p class="text-xs text-emerald-400">ğŸ‘¤ ${expense.expense_employee}</p>` : ''}
              ${expense.expense_notes ? `<p class="text-xs text-slate-400 mt-1">${expense.expense_notes}</p>` : ''}
            </div>
            <div class="text-right flex items-center gap-2">
              <div>
                <p class="text-xl font-bold text-red-400">L.${(expense.payment_amount || 0).toFixed(2)}</p>
              </div>
              <button onclick="deleteExpense('${expense.__backendId}', this)" class="p-2 bg-red-600 hover:bg-red-700 rounded text-xs" title="Eliminar">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Get Filtered Expenses
    function getFilteredExpenses() {
      const typeFilter = document.getElementById('filter-expense-type')?.value || '';
      const dateFrom = document.getElementById('filter-expense-from')?.value || '';
      const dateTo = document.getElementById('filter-expense-to')?.value || '';
      
      return expenses.filter(expense => {
        const matchesType = !typeFilter || expense.expense_type === typeFilter;
        const matchesDateFrom = !dateFrom || expense.date >= dateFrom;
        const matchesDateTo = !dateTo || expense.date <= dateTo;
        
        return matchesType && matchesDateFrom && matchesDateTo;
      }).sort((a, b) => new Date(b.date) - new Date(a.date));
    }
    
    // Filter Expenses
    function filterExpenses() {
      renderExpensesList();
    }
    
    // Delete Expense
    async function deleteExpense(id, btnElem) {
      const expense = expenses.find(e => e.__backendId === id);
      if (!expense) return;
      
      const btn = btnElem || (typeof event !== 'undefined' && event.target) || document.activeElement;
      if (btn.dataset.confirming !== 'true') {
        btn.dataset.confirming = 'true';
        btn.textContent = 'Â¿Confirmar?';
        btn.classList.add('bg-red-700');
        setTimeout(() => {
          btn.dataset.confirming = 'false';
          btn.textContent = 'ğŸ—‘ï¸';
          btn.classList.remove('bg-red-700');
        }, 3000);
        return;
      }
      
      const result = await window.dataSdk.delete(expense);
      if (result.isOk) {
        showToast('Gasto eliminado', 'success');
      } else {
        showToast('Error al eliminar gasto', 'error');
      }
    }
    
    // Export Expenses PDF
    function exportExpensesPDF() {
      const filtered = getFilteredExpenses();
      if (filtered.length === 0) {
        showToast('No hay gastos para exportar', 'error');
        return;
      }
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      const totalExpenses = filtered.reduce((sum, e) => sum + (e.payment_amount || 0), 0);
      
      const typeLabels = {
        'salarios': 'Salarios de Empleados',
        'servicios': 'Servicios PÃºblicos',
        'medicamentos': 'Medicamentos e Insumos',
        'equipo': 'Equipo MÃ©dico',
        'mantenimiento': 'Mantenimiento',
        'limpieza': 'Limpieza y Saneamiento',
        'papeleria': 'PapelerÃ­a y Oficina',
        'otros': 'Otros'
      };
      
      let htmlContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reporte de Gastos</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
    .header { text-align: center; border-bottom: 3px solid #dc2626; padding-bottom: 15px; margin-bottom: 30px; }
    .header h1 { margin: 0; color: #dc2626; font-size: 24px; }
    .summary { border: 1px solid #cbd5e1; padding: 20px; border-radius: 8px; margin-bottom: 30px; background: #fef2f2; }
    .summary h2 { margin: 0 0 10px 0; font-size: 16px; color: #991b1b; }
    .summary p { margin: 0; font-size: 28px; font-weight: bold; color: #dc2626; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: left; font-size: 11px; }
    th { background: #f1f5f9; font-weight: bold; }
    .footer { margin-top: 30px; text-align: center; color: #64748b; font-size: 11px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>${hospitalName}</h1>
    <h2>Reporte de Gastos y Egresos</h2>
  </div>
  
  <div class="summary">
    <h2>ğŸ’¸ Total de Egresos</h2>
    <p>L.${totalExpenses.toFixed(2)}</p>
    <p style="font-size: 12px; color: #64748b; margin-top: 5px;">${filtered.length} gasto(s) registrado(s)</p>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>DescripciÃ³n</th>
        <th>Empleado</th>
        <th>Monto</th>
      </tr>
    </thead>
    <tbody>
      ${filtered.map(expense => `
        <tr>
          <td>${expense.date}</td>
          <td>${typeLabels[expense.expense_type] || expense.expense_type}</td>
          <td>${expense.expense_description}${expense.expense_notes ? `<br><small style="color: #64748b;">${expense.expense_notes}</small>` : ''}</td>
          <td>${expense.expense_employee || 'N/A'}</td>
          <td style="font-weight: bold; color: #dc2626;">L.${(expense.payment_amount || 0).toFixed(2)}</td>
        </tr>
      `).join('')}
      <tr style="background: #dc2626; color: white; font-weight: bold;">
        <td colspan="4" style="text-align: right;">TOTAL DE EGRESOS:</td>
        <td>L.${totalExpenses.toFixed(2)}</td>
      </tr>
    </tbody>
  </table>
  
  <div class="footer">
    <p>Documento generado: ${new Date().toLocaleString()}</p>
    <p>${hospitalName} - Sistema de Citas MÃ©dicas</p>
  </div>
</body>
</html>
      `;
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showToast('Por favor permita las ventanas emergentes', 'error');
        return;
      }
      
      printWindow.document.write(htmlContent);
      printWindow.document.close();
      
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.focus();
          printWindow.print();
        }, 250);
      };
      
      showToast('Abriendo reporte de gastos...', 'success');
    }
    
    // Export Expenses Excel
    function exportExpensesExcel() {
      const filtered = getFilteredExpenses();
      if (filtered.length === 0) {
        showToast('No hay gastos para exportar', 'error');
        return;
      }
      
      const hospitalName = settings ? settings.hospital_name : defaultConfig.hospital_name;
      
      const typeLabels = {
        'salarios': 'Salarios de Empleados',
        'servicios': 'Servicios PÃºblicos',
        'medicamentos': 'Medicamentos e Insumos',
        'equipo': 'Equipo MÃ©dico',
        'mantenimiento': 'Mantenimiento',
        'limpieza': 'Limpieza y Saneamiento',
        'papeleria': 'PapelerÃ­a y Oficina',
        'otros': 'Otros'
      };
      
      let csv = '\uFEFF';
      csv += `${hospitalName}\n`;
      csv += `Reporte de Gastos y Egresos\n`;
      csv += `Generado: ${new Date().toLocaleString()}\n\n`;
      
      csv += `No.,Fecha,Tipo,DescripciÃ³n,Empleado,Monto,Notas\n`;
      
      filtered.forEach((expense, i) => {
        const row = [
          i + 1,
          expense.date,
          typeLabels[expense.expense_type] || expense.expense_type,
          expense.expense_description,
          expense.expense_employee || 'N/A',
          (expense.payment_amount || 0).toFixed(2),
          expense.expense_notes || ''
        ];
        
        const escapedRow = row.map(field => {
          const stringField = String(field);
          if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
            return `"${stringField.replace(/"/g, '""')}"`;
          }
          return stringField;
        });
        
        csv += escapedRow.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `reporte_gastos_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('ğŸ“Š Excel descargado exitosamente', 'success');
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bdb5345c7e90db9',t:'MTc2ODM3NDc0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>